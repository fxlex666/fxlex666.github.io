var box2d=window.box2d=function(t){"use strict";class b2Color{constructor(t=.5,e=.5,i=.5,s=1){this.r=t,this.g=e,this.b=i,this.a=s}Clone(){return(new b2Color).Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}Set(t,e,i,s=this.a){this.SetRGBA(t,e,i,s)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){b2Color.MixColors(this,t,e)}static MixColors(t,e,i){const s=i*(e.r-t.r),o=i*(e.g-t.g),n=i*(e.b-t.b),r=i*(e.a-t.a);t.r+=s,t.g+=o,t.b+=n,t.a+=r,e.r-=s,e.g-=o,e.b-=n,e.a-=r}MakeStyleString(t=this.a){return b2Color.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,s=1){return t*=255,e*=255,i*=255,s<1?`rgba(${t},${e},${i},${s})`:`rgb(${t},${e},${i})`}}var e;b2Color.ZERO=new b2Color(0,0,0,0),b2Color.RED=new b2Color(1,0,0),b2Color.GREEN=new b2Color(0,1,0),b2Color.BLUE=new b2Color(0,0,1),t.b2DrawFlags=void 0,(e=t.b2DrawFlags||(t.b2DrawFlags={}))[e.e_none=0]="e_none",e[e.e_shapeBit=1]="e_shapeBit",e[e.e_jointBit=2]="e_jointBit",e[e.e_aabbBit=4]="e_aabbBit",e[e.e_pairBit=8]="e_pairBit",e[e.e_centerOfMassBit=16]="e_centerOfMassBit",e[e.e_all=63]="e_all";function b2Maybe(t,e){return void 0!==t?t:e}const i=1e37,s=1e-5,o=s*s,n=3.14159265359,r=.1,a=.005,h=2/180*n,l=.01,_=.2,m=8/180*n,c=.5*n,b=2.4674011002726646,u=.01,d=2/180*n;class b2Version{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}const p=new b2Version(2,4,1);function b2MakeArray(t,e){const i=new Array(t);for(let s=0;s<t;++s)i[s]=e(s);return i}function b2MakeNumberArray(t,e=0){const i=new Array(t);for(let s=0;s<t;++s)i[s]=e;return i}class b2GrowableStack{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=b2MakeArray(t,(t=>null)),this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];return this.m_stack[this.m_count]=null,t}GetCount(){return this.m_count}}const y=n/180,V=180/n,x=2*n,S=Math.abs;function b2Min(t,e){return t<e?t:e}function b2Max(t,e){return t>e?t:e}function b2Clamp(t,e,i){return t<e?e:t>i?i:t}const f=isFinite;function b2Sq(t){return t*t}const A=Math.sqrt,C=Math.pow;const w=Math.cos,g=Math.sin,B=Math.acos,v=Math.asin,M=Math.atan2;class b2Vec2{constructor(t=0,e=0){this.x=t,this.y=e}Clone(){return new b2Vec2(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=b2Min(this.x,t.x),this.y=b2Min(this.y,t.y),this}SelfMaxV(t){return this.x=b2Max(this.x,t.x),this.y=b2Max(this.y,t.y),this}SelfAbs(){return this.x=S(this.x),this.y=S(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return b2MakeArray(t,(t=>new b2Vec2))}static AbsV(t,e){return e.x=S(t.x),e.y=S(t.y),e}static MinV(t,e,i){return i.x=b2Min(t.x,e.x),i.y=b2Min(t.y,e.y),i}static MaxV(t,e,i){return i.x=b2Max(t.x,e.x),i.y=b2Max(t.y,e.y),i}static ClampV(t,e,i,s){return s.x=b2Clamp(t.x,e.x,i.x),s.y=b2Clamp(t.y,e.y,i.y),s}static RotateV(t,e,i){const s=t.x,o=t.y,n=Math.cos(e),r=Math.sin(e);return i.x=n*s-r*o,i.y=r*s+n*o,i}static DotVV(t,e){return t.x*e.x+t.y*e.y}static CrossVV(t,e){return t.x*e.y-t.y*e.x}static CrossVS(t,e,i){const s=t.x;return i.x=e*t.y,i.y=-e*s,i}static CrossVOne(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossSV(t,e,i){const s=e.x;return i.x=-t*e.y,i.y=t*s,i}static CrossOneV(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static AddVV(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static SubVV(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static MulSV(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static MulVS(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}static AddVMulSV(t,e,i,s){return s.x=t.x+e*i.x,s.y=t.y+e*i.y,s}static SubVMulSV(t,e,i,s){return s.x=t.x-e*i.x,s.y=t.y-e*i.y,s}static AddVCrossSV(t,e,i,s){const o=i.x;return s.x=t.x-e*i.y,s.y=t.y+e*o,s}static MidVV(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i}static ExtVV(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i}static IsEqualToV(t,e){return t.x===e.x&&t.y===e.y}static DistanceVV(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}static DistanceSquaredVV(t,e){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s}static NegV(t,e){return e.x=-t.x,e.y=-t.y,e}}b2Vec2.ZERO=new b2Vec2(0,0),b2Vec2.UNITX=new b2Vec2(1,0),b2Vec2.UNITY=new b2Vec2(0,1),b2Vec2.s_t0=new b2Vec2,b2Vec2.s_t1=new b2Vec2,b2Vec2.s_t2=new b2Vec2,b2Vec2.s_t3=new b2Vec2;const I=new b2Vec2(0,0);class b2Vec3{constructor(...t){if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0,s="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([e,i,s])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}get z(){return this.data[2]}set z(t){this.data[2]=t}Clone(){return new b2Vec3(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static CrossV3V3(t,e,i){const s=t.x,o=t.y,n=t.z,r=e.x,a=e.y,h=e.z;return i.x=o*h-n*a,i.y=n*r-s*h,i.z=s*a-o*r,i}}b2Vec3.ZERO=new b2Vec3(0,0,0),b2Vec3.s_t0=new b2Vec3;class b2Mat22{constructor(){this.ex=new b2Vec2(1,0),this.ey=new b2Vec2(0,1)}Clone(){return(new b2Mat22).Copy(this)}static FromVV(t,e){return(new b2Mat22).SetVV(t,e)}static FromSSSS(t,e,i,s){return(new b2Mat22).SetSSSS(t,e,i,s)}static FromAngle(t){return(new b2Mat22).SetAngle(t)}SetSSSS(t,e,i,s){return this.ex.Set(t,i),this.ey.Set(e,s),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y;let n=e*o-i*s;return 0!==n&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.y=-n*s,t.ey.y=n*e,t}Solve(t,e,i){const s=this.ex.x,o=this.ey.x,n=this.ex.y,r=this.ey.y;let a=s*r-o*n;return 0!==a&&(a=1/a),i.x=a*(r*t-o*e),i.y=a*(s*e-n*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){const i=t.ex,s=t.ey;return e.ex.x=S(i.x),e.ex.y=S(i.y),e.ey.x=S(s.x),e.ey.y=S(s.y),e}static MulMV(t,e,i){const s=t.ex,o=t.ey,n=e.x,r=e.y;return i.x=s.x*n+o.x*r,i.y=s.y*n+o.y*r,i}static MulTMV(t,e,i){const s=t.ex,o=t.ey,n=e.x,r=e.y;return i.x=s.x*n+s.y*r,i.y=o.x*n+o.y*r,i}static AddMM(t,e,i){const s=t.ex,o=t.ey,n=e.ex,r=e.ey;return i.ex.x=s.x+n.x,i.ex.y=s.y+n.y,i.ey.x=o.x+r.x,i.ey.y=o.y+r.y,i}static MulMM(t,e,i){const s=t.ex.x,o=t.ex.y,n=t.ey.x,r=t.ey.y,a=e.ex.x,h=e.ex.y,l=e.ey.x,_=e.ey.y;return i.ex.x=s*a+n*h,i.ex.y=o*a+r*h,i.ey.x=s*l+n*_,i.ey.y=o*l+r*_,i}static MulTMM(t,e,i){const s=t.ex.x,o=t.ex.y,n=t.ey.x,r=t.ey.y,a=e.ex.x,h=e.ex.y,l=e.ey.x,_=e.ey.y;return i.ex.x=s*a+o*h,i.ex.y=n*a+r*h,i.ey.x=s*l+o*_,i.ey.y=n*l+r*_,i}}b2Mat22.IDENTITY=new b2Mat22;class b2Mat33{constructor(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new b2Vec3(this.data.subarray(0,3)),this.ey=new b2Vec3(this.data.subarray(3,6)),this.ez=new b2Vec3(this.data.subarray(6,9))}Clone(){return(new b2Mat33).Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,s){const o=this.ex.x,n=this.ex.y,r=this.ex.z,a=this.ey.x,h=this.ey.y,l=this.ey.z,_=this.ez.x,m=this.ez.y,c=this.ez.z;let b=o*(h*c-l*m)+n*(l*_-a*c)+r*(a*m-h*_);return 0!==b&&(b=1/b),s.x=b*(t*(h*c-l*m)+e*(l*_-a*c)+i*(a*m-h*_)),s.y=b*(o*(e*c-i*m)+n*(i*_-t*c)+r*(t*m-e*_)),s.z=b*(o*(h*i-l*e)+n*(l*t-a*i)+r*(a*e-h*t)),s}Solve22(t,e,i){const s=this.ex.x,o=this.ey.x,n=this.ex.y,r=this.ey.y;let a=s*r-o*n;return 0!==a&&(a=1/a),i.x=a*(r*t-o*e),i.y=a*(s*e-n*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,o=this.ey.y;let n=e*o-i*s;0!==n&&(n=1/n),t.ex.x=n*o,t.ey.x=-n*i,t.ex.z=0,t.ex.y=-n*s,t.ey.y=n*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=b2Vec3.DotV3V3(this.ex,b2Vec3.CrossV3V3(this.ey,this.ez,b2Vec3.s_t0));0!==e&&(e=1/e);const i=this.ex.x,s=this.ey.x,o=this.ez.x,n=this.ey.y,r=this.ez.y,a=this.ez.z;t.ex.x=e*(n*a-r*r),t.ex.y=e*(o*r-s*a),t.ex.z=e*(s*r-o*n),t.ey.x=t.ex.y,t.ey.y=e*(i*a-o*o),t.ey.z=e*(o*s-i*r),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*n-s*s)}static MulM33V3(t,e,i){const s=e.x,o=e.y,n=e.z;return i.x=t.ex.x*s+t.ey.x*o+t.ez.x*n,i.y=t.ex.y*s+t.ey.y*o+t.ez.y*n,i.z=t.ex.z*s+t.ey.z*o+t.ez.z*n,i}static MulM33XYZ(t,e,i,s,o){return o.x=t.ex.x*e+t.ey.x*i+t.ez.x*s,o.y=t.ex.y*e+t.ey.y*i+t.ez.y*s,o.z=t.ex.z*e+t.ey.z*i+t.ez.z*s,o}static MulM33V2(t,e,i){const s=e.x,o=e.y;return i.x=t.ex.x*s+t.ey.x*o,i.y=t.ex.y*s+t.ey.y*o,i}static MulM33XY(t,e,i,s){return s.x=t.ex.x*e+t.ey.x*i,s.y=t.ex.y*e+t.ey.y*i,s}}b2Mat33.IDENTITY=new b2Mat33;class b2Rot{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return(new b2Rot).Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){const s=t.c,o=t.s,n=e.c,r=e.s;return i.s=o*n+s*r,i.c=s*n-o*r,i}static MulTRR(t,e,i){const s=t.c,o=t.s,n=e.c,r=e.s;return i.s=s*r-o*n,i.c=s*n+o*r,i}static MulRV(t,e,i){const s=t.c,o=t.s,n=e.x,r=e.y;return i.x=s*n-o*r,i.y=o*n+s*r,i}static MulTRV(t,e,i){const s=t.c,o=t.s,n=e.x,r=e.y;return i.x=s*n+o*r,i.y=-o*n+s*r,i}}b2Rot.IDENTITY=new b2Rot;class b2Transform{constructor(){this.p=new b2Vec2,this.q=new b2Rot}Clone(){return(new b2Transform).Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){const s=t.q.c,o=t.q.s,n=e.x,r=e.y;return i.x=s*n-o*r+t.p.x,i.y=o*n+s*r+t.p.y,i}static MulTXV(t,e,i){const s=t.q.c,o=t.q.s,n=e.x-t.p.x,r=e.y-t.p.y;return i.x=s*n+o*r,i.y=-o*n+s*r,i}static MulXX(t,e,i){return b2Rot.MulRR(t.q,e.q,i.q),b2Vec2.AddVV(b2Rot.MulRV(t.q,e.p,i.p),t.p,i.p),i}static MulTXX(t,e,i){return b2Rot.MulTRR(t.q,e.q,i.q),b2Rot.MulTRV(t.q,b2Vec2.SubVV(e.p,t.p,i.p),i.p),i}}b2Transform.IDENTITY=new b2Transform;class b2Sweep{constructor(){this.localCenter=new b2Vec2,this.c0=new b2Vec2,this.c=new b2Vec2,this.a0=0,this.a=0,this.alpha0=0}Clone(){return(new b2Sweep).Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){t.p.x=(1-e)*this.c0.x+e*this.c.x,t.p.y=(1-e)*this.c0.y+e*this.c.y;const i=(1-e)*this.a0+e*this.a;return t.q.SetAngle(i),t.p.SelfSub(b2Rot.MulRV(t.q,this.localCenter,b2Vec2.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0);this.c0.SelfMulAdd(e,this.c.Clone().SelfSub(this.c0)),this.a0+=e*(this.a-this.a0),this.alpha0=t}Normalize(){const t=x*Math.floor(this.a0/x);this.a0-=t,this.a-=t}}class b2Timer{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class b2MassData{constructor(){this.mass=0,this.center=new b2Vec2(0,0),this.I=0}}var P;t.b2ShapeType=void 0,(P=t.b2ShapeType||(t.b2ShapeType={}))[P.e_unknown=-1]="e_unknown",P[P.e_circleShape=0]="e_circleShape",P[P.e_edgeShape=1]="e_edgeShape",P[P.e_polygonShape=2]="e_polygonShape",P[P.e_chainShape=3]="e_chainShape",P[P.e_shapeTypeCount=4]="e_shapeTypeCount";class b2Shape{constructor(e,i){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=i}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class b2DistanceProxy{constructor(){this.m_buffer=b2Vec2.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}Set(...t){t[0]instanceof b2Shape?this.SetShape(t[0],t[1]):this.SetVerticesRadius(t[0],t[1],t[2])}GetSupport(t){let e=0,i=b2Vec2.DotVV(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const o=b2Vec2.DotVV(this.m_vertices[s],t);o>i&&(e=s,i=o)}return e}GetSupportVertex(t){let e=0,i=b2Vec2.DotVV(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const o=b2Vec2.DotVV(this.m_vertices[s],t);o>i&&(e=s,i=o)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class b2SimplexCache{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class b2DistanceInput{constructor(){this.proxyA=new b2DistanceProxy,this.proxyB=new b2DistanceProxy,this.transformA=new b2Transform,this.transformB=new b2Transform,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class b2DistanceOutput{constructor(){this.pointA=new b2Vec2,this.pointB=new b2Vec2,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;class b2SimplexVertex{constructor(){this.wA=new b2Vec2,this.wB=new b2Vec2,this.w=new b2Vec2,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class b2Simplex{constructor(){this.m_v1=new b2SimplexVertex,this.m_v2=new b2SimplexVertex,this.m_v3=new b2SimplexVertex,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,o,n){this.m_count=t.count;const r=this.m_vertices;for(let s=0;s<this.m_count;++s){const a=r[s];a.indexA=t.indexA[s],a.indexB=t.indexB[s];const h=e.GetVertex(a.indexA),l=o.GetVertex(a.indexB);b2Transform.MulXV(i,h,a.wA),b2Transform.MulXV(n,l,a.wB),b2Vec2.SubVV(a.wB,a.wA,a.w),a.a=0}if(this.m_count>1){const e=t.metric,i=this.GetMetric();(i<.5*e||2*e<i||i<s)&&(this.m_count=0)}if(0===this.m_count){const t=r[0];t.indexA=0,t.indexB=0;const s=e.GetVertex(0),a=o.GetVertex(0);b2Transform.MulXV(i,s,t.wA),b2Transform.MulXV(n,a,t.wB),b2Vec2.SubVV(t.wB,t.wA,t.w),t.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return b2Vec2.NegV(this.m_v1.w,t);case 2:{const e=b2Vec2.SubVV(this.m_v2.w,this.m_v1.w,t);return b2Vec2.CrossVV(e,b2Vec2.NegV(this.m_v1.w,b2Vec2.s_t0))>0?b2Vec2.CrossOneV(e,t):b2Vec2.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:case 3:default:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y)}}GetWitnessPoints(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}GetMetric(){switch(this.m_count){case 0:case 1:default:return 0;case 2:return b2Vec2.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return b2Vec2.CrossVV(b2Vec2.SubVV(this.m_v2.w,this.m_v1.w,b2Vec2.s_t0),b2Vec2.SubVV(this.m_v3.w,this.m_v1.w,b2Vec2.s_t1))}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=b2Vec2.SubVV(e,t,b2Simplex.s_e12),s=-b2Vec2.DotVV(t,i);if(s<=0)return this.m_v1.a=1,void(this.m_count=1);const o=b2Vec2.DotVV(e,i);if(o<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);const n=1/(o+s);this.m_v1.a=o*n,this.m_v2.a=s*n,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,s=b2Vec2.SubVV(e,t,b2Simplex.s_e12),o=b2Vec2.DotVV(t,s),n=b2Vec2.DotVV(e,s),r=-o,a=b2Vec2.SubVV(i,t,b2Simplex.s_e13),h=b2Vec2.DotVV(t,a),l=b2Vec2.DotVV(i,a),_=-h,m=b2Vec2.SubVV(i,e,b2Simplex.s_e23),c=b2Vec2.DotVV(e,m),b=b2Vec2.DotVV(i,m),u=-c,d=b2Vec2.CrossVV(s,a),p=d*b2Vec2.CrossVV(e,i),y=d*b2Vec2.CrossVV(i,t),V=d*b2Vec2.CrossVV(t,e);if(r<=0&&_<=0)return this.m_v1.a=1,void(this.m_count=1);if(n>0&&r>0&&V<=0){const t=1/(n+r);return this.m_v1.a=n*t,this.m_v2.a=r*t,void(this.m_count=2)}if(l>0&&_>0&&y<=0){const t=1/(l+_);return this.m_v1.a=l*t,this.m_v3.a=_*t,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(n<=0&&u<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(l<=0&&b<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(b>0&&u>0&&p<=0){const t=1/(b+u);return this.m_v2.a=b*t,this.m_v3.a=u*t,this.m_count=2,void this.m_v1.Copy(this.m_v3)}const x=1/(p+y+V);this.m_v1.a=p*x,this.m_v2.a=y*x,this.m_v3.a=V*x,this.m_count=3}}b2Simplex.s_e12=new b2Vec2,b2Simplex.s_e13=new b2Vec2,b2Simplex.s_e23=new b2Vec2;const D=new b2Simplex,T=[0,0,0],R=[0,0,0],G=new b2Vec2,J=new b2Vec2,L=new b2Vec2,F=new b2Vec2,k=new b2Vec2;function b2Distance(e,i,n){++t.b2_gjkCalls;const r=n.proxyA,a=n.proxyB,h=n.transformA,l=n.transformB,_=D;_.ReadCache(i,r,h,a,l);const m=_.m_vertices,c=T,b=R;let u=0,d=0;for(;d<20;){u=_.m_count;for(let t=0;t<u;++t)c[t]=m[t].indexA,b[t]=m[t].indexB;switch(_.m_count){case 1:break;case 2:_.Solve2();break;case 3:_.Solve3()}if(3===_.m_count)break;const e=_.GetSearchDirection(J);if(e.LengthSquared()<o)break;const i=m[_.m_count];i.indexA=r.GetSupport(b2Rot.MulTRV(h.q,b2Vec2.NegV(e,b2Vec2.s_t0),F)),b2Transform.MulXV(h,r.GetVertex(i.indexA),i.wA),i.indexB=a.GetSupport(b2Rot.MulTRV(l.q,e,k)),b2Transform.MulXV(l,a.GetVertex(i.indexB),i.wB),b2Vec2.SubVV(i.wB,i.wA,i.w),++d,++t.b2_gjkIters;let s=!1;for(let t=0;t<u;++t)if(i.indexA===c[t]&&i.indexB===b[t]){s=!0;break}if(s)break;++_.m_count}if(t.b2_gjkMaxIters=b2Max(t.b2_gjkMaxIters,d),_.GetWitnessPoints(e.pointA,e.pointB),e.distance=b2Vec2.DistanceVV(e.pointA,e.pointB),e.iterations=d,_.WriteCache(i),n.useRadii){const t=r.m_radius,i=a.m_radius;if(e.distance>t+i&&e.distance>s){e.distance-=t+i;const s=b2Vec2.SubVV(e.pointB,e.pointA,L);s.Normalize(),e.pointA.SelfMulAdd(t,s),e.pointB.SelfMulSub(i,s)}else{const t=b2Vec2.MidVV(e.pointA,e.pointB,G);e.pointA.Copy(t),e.pointB.Copy(t),e.distance=0}}}const E=new b2Vec2,j=new b2Simplex,q=new b2Vec2,O=new b2Vec2,z=new b2Vec2,X=new b2Vec2,W=new b2Vec2,N=new b2Vec2;var Z,Y,U;t.b2ContactFeatureType=void 0,(Z=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[Z.e_vertex=0]="e_vertex",Z[Z.e_face=1]="e_face";class b2ContactFeature{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class b2ContactID{constructor(){this.cf=new b2ContactFeature}Copy(t){return this.key=t.key,this}Clone(){return(new b2ContactID).Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class b2ManifoldPoint{constructor(){this.localPoint=new b2Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.id=new b2ContactID}static MakeArray(t){return b2MakeArray(t,(t=>new b2ManifoldPoint))}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}t.b2ManifoldType=void 0,(Y=t.b2ManifoldType||(t.b2ManifoldType={}))[Y.e_unknown=-1]="e_unknown",Y[Y.e_circles=0]="e_circles",Y[Y.e_faceA=1]="e_faceA",Y[Y.e_faceB=2]="e_faceB";class b2Manifold{constructor(){this.points=b2ManifoldPoint.MakeArray(2),this.localNormal=new b2Vec2,this.localPoint=new b2Vec2,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<2;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<2;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return(new b2Manifold).Copy(this)}}class b2WorldManifold{constructor(){this.normal=new b2Vec2,this.points=b2Vec2.MakeArray(2),this.separations=b2MakeNumberArray(2)}Initialize(e,i,s,n,r){if(0!==e.pointCount)switch(e.type){case t.b2ManifoldType.e_circles:{this.normal.Set(1,0);const t=b2Transform.MulXV(i,e.localPoint,b2WorldManifold.Initialize_s_pointA),a=b2Transform.MulXV(n,e.points[0].localPoint,b2WorldManifold.Initialize_s_pointB);b2Vec2.DistanceSquaredVV(t,a)>o&&b2Vec2.SubVV(a,t,this.normal).SelfNormalize();const h=b2Vec2.AddVMulSV(t,s,this.normal,b2WorldManifold.Initialize_s_cA),l=b2Vec2.SubVMulSV(a,r,this.normal,b2WorldManifold.Initialize_s_cB);b2Vec2.MidVV(h,l,this.points[0]),this.separations[0]=b2Vec2.DotVV(b2Vec2.SubVV(l,h,b2Vec2.s_t0),this.normal);break}case t.b2ManifoldType.e_faceA:{b2Rot.MulRV(i.q,e.localNormal,this.normal);const t=b2Transform.MulXV(i,e.localPoint,b2WorldManifold.Initialize_s_planePoint);for(let i=0;i<e.pointCount;++i){const o=b2Transform.MulXV(n,e.points[i].localPoint,b2WorldManifold.Initialize_s_clipPoint),a=s-b2Vec2.DotVV(b2Vec2.SubVV(o,t,b2Vec2.s_t0),this.normal),h=b2Vec2.AddVMulSV(o,a,this.normal,b2WorldManifold.Initialize_s_cA),l=b2Vec2.SubVMulSV(o,r,this.normal,b2WorldManifold.Initialize_s_cB);b2Vec2.MidVV(h,l,this.points[i]),this.separations[i]=b2Vec2.DotVV(b2Vec2.SubVV(l,h,b2Vec2.s_t0),this.normal)}break}case t.b2ManifoldType.e_faceB:{b2Rot.MulRV(n.q,e.localNormal,this.normal);const t=b2Transform.MulXV(n,e.localPoint,b2WorldManifold.Initialize_s_planePoint);for(let o=0;o<e.pointCount;++o){const n=b2Transform.MulXV(i,e.points[o].localPoint,b2WorldManifold.Initialize_s_clipPoint),a=r-b2Vec2.DotVV(b2Vec2.SubVV(n,t,b2Vec2.s_t0),this.normal),h=b2Vec2.AddVMulSV(n,a,this.normal,b2WorldManifold.Initialize_s_cB),l=b2Vec2.SubVMulSV(n,s,this.normal,b2WorldManifold.Initialize_s_cA);b2Vec2.MidVV(l,h,this.points[o]),this.separations[o]=b2Vec2.DotVV(b2Vec2.SubVV(l,h,b2Vec2.s_t0),this.normal)}this.normal.SelfNeg();break}}}}b2WorldManifold.Initialize_s_pointA=new b2Vec2,b2WorldManifold.Initialize_s_pointB=new b2Vec2,b2WorldManifold.Initialize_s_cA=new b2Vec2,b2WorldManifold.Initialize_s_cB=new b2Vec2,b2WorldManifold.Initialize_s_planePoint=new b2Vec2,b2WorldManifold.Initialize_s_clipPoint=new b2Vec2,t.b2PointState=void 0,(U=t.b2PointState||(t.b2PointState={}))[U.b2_nullState=0]="b2_nullState",U[U.b2_addState=1]="b2_addState",U[U.b2_persistState=2]="b2_persistState",U[U.b2_removeState=3]="b2_removeState";class b2ClipVertex{constructor(){this.v=new b2Vec2,this.id=new b2ContactID}static MakeArray(t){return b2MakeArray(t,(t=>new b2ClipVertex))}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class b2RayCastInput{constructor(){this.p1=new b2Vec2,this.p2=new b2Vec2,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class b2RayCastOutput{constructor(){this.normal=new b2Vec2,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class b2AABB{constructor(){this.lowerBound=new b2Vec2,this.upperBound=new b2Vec2,this.m_cache_center=new b2Vec2,this.m_cache_extent=new b2Vec2}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return!!this.lowerBound.IsValid()&&(!!this.upperBound.IsValid()&&(!(this.upperBound.x<this.lowerBound.x)&&!(this.upperBound.y<this.lowerBound.y)))}GetCenter(){return b2Vec2.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return b2Vec2.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}Combine1(t){return this.lowerBound.x=b2Min(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=b2Min(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=b2Max(this.upperBound.x,t.upperBound.x),this.upperBound.y=b2Max(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=b2Min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=b2Min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=b2Max(t.upperBound.x,e.upperBound.x),this.upperBound.y=b2Max(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){let e=!0;return e=e&&this.lowerBound.x<=t.lowerBound.x,e=e&&this.lowerBound.y<=t.lowerBound.y,e=e&&t.upperBound.x<=this.upperBound.x,e=e&&t.upperBound.y<=this.upperBound.y,e}RayCast(t,e){let o=-i,n=i;const r=e.p1.x,a=e.p1.y,h=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,_=S(h),m=S(l),c=t.normal;if(_<s){if(r<this.lowerBound.x||this.upperBound.x<r)return!1}else{const t=1/h;let e=(this.lowerBound.x-r)*t,i=(this.upperBound.x-r)*t,s=-1;if(e>i){const t=e;e=i,i=t,s=1}if(e>o&&(c.x=s,c.y=0,o=e),n=b2Min(n,i),o>n)return!1}if(m<s){if(a<this.lowerBound.y||this.upperBound.y<a)return!1}else{const t=1/l;let e=(this.lowerBound.y-a)*t,i=(this.upperBound.y-a)*t,s=-1;if(e>i){const t=e;e=i,i=t,s=1}if(e>o&&(c.x=0,c.y=s,o=e),n=b2Min(n,i),o>n)return!1}return!(o<0||e.maxFraction<o)&&(t.fraction=o,!0)}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x)&&!(t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x)&&(!(this.upperBound.y<t.lowerBound.y)&&(!(t.upperBound.x<this.lowerBound.x)&&!(t.upperBound.y<this.lowerBound.y)))}}function b2TestOverlapAABB(t,e){return!(t.upperBound.x<e.lowerBound.x)&&(!(t.upperBound.y<e.lowerBound.y)&&(!(e.upperBound.x<t.lowerBound.x)&&!(e.upperBound.y<t.lowerBound.y)))}function b2ClipSegmentToLine(e,i,s,o,n){let r=0;const a=i[0],h=i[1],l=b2Vec2.DotVV(s,a.v)-o,_=b2Vec2.DotVV(s,h.v)-o;if(l<=0&&e[r++].Copy(a),_<=0&&e[r++].Copy(h),l*_<0){const i=l/(l-_),s=e[r].v;s.x=a.v.x+i*(h.v.x-a.v.x),s.y=a.v.y+i*(h.v.y-a.v.y);const o=e[r].id;o.cf.indexA=n,o.cf.indexB=a.id.cf.indexB,o.cf.typeA=t.b2ContactFeatureType.e_vertex,o.cf.typeB=t.b2ContactFeatureType.e_face,++r}return r}const Q=new b2DistanceInput,K=new b2SimplexCache,H=new b2DistanceOutput;function b2TestOverlapShape(t,e,i,s,o,n){const r=Q.Reset();r.proxyA.SetShape(t,e),r.proxyB.SetShape(i,s),r.transformA.Copy(o),r.transformB.Copy(n),r.useRadii=!0;const a=K.Reset();a.count=0;const h=H.Reset();return b2Distance(h,a,r),h.distance<1e-4}function verify(t){if(null===t)throw new Error;return t}class b2TreeNode{constructor(t=0){this.m_id=0,this.aabb=new b2AABB,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.moved=!1,this.m_id=t}get userData(){if(null===this._userData)throw new Error;return this._userData}set userData(t){if(null!==this._userData)throw new Error;this._userData=t}Reset(){this._userData=null}IsLeaf(){return null===this.child1}}class b2DynamicTree{constructor(){this.m_root=null,this.m_freeList=null,this.m_insertionCount=0,this.m_stack=new b2GrowableStack(256)}Query(...t){let e,i;t[0]instanceof b2AABB?(e=t[0],i=t[1]):(e=t[1],i=t[0]);const s=this.m_stack.Reset();for(s.Push(this.m_root);s.GetCount()>0;){const t=s.Pop();if(null!==t&&t.aabb.TestOverlap(e))if(t.IsLeaf()){if(!i(t))return}else s.Push(t.child1),s.Push(t.child2)}}QueryPoint(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const s=i.Pop();if(null!==s&&s.aabb.TestContain(t))if(s.IsLeaf()){if(!e(s))return}else i.Push(s.child1),i.Push(s.child2)}}RayCast(...t){let e,i;t[0]instanceof b2RayCastInput?(i=t[0],e=t[1]):(i=t[1],e=t[0]);const s=i.p1,o=i.p2,n=b2Vec2.SubVV(o,s,b2DynamicTree.s_r);n.Normalize();const r=b2Vec2.CrossOneV(n,b2DynamicTree.s_v),a=b2Vec2.AbsV(r,b2DynamicTree.s_abs_v);let h=i.maxFraction;const l=b2DynamicTree.s_segmentAABB;let _=s.x+h*(o.x-s.x),m=s.y+h*(o.y-s.y);l.lowerBound.x=b2Min(s.x,_),l.lowerBound.y=b2Min(s.y,m),l.upperBound.x=b2Max(s.x,_),l.upperBound.y=b2Max(s.y,m);const c=this.m_stack.Reset();for(c.Push(this.m_root);c.GetCount()>0;){const t=c.Pop();if(null===t)continue;if(!b2TestOverlapAABB(t.aabb,l))continue;const n=t.aabb.GetCenter(),b=t.aabb.GetExtents();if(!(S(b2Vec2.DotVV(r,b2Vec2.SubVV(s,n,b2Vec2.s_t0)))-b2Vec2.DotVV(a,b)>0))if(t.IsLeaf()){const n=b2DynamicTree.s_subInput;n.p1.Copy(i.p1),n.p2.Copy(i.p2),n.maxFraction=h;const r=e(n,t);if(0===r)return;r>0&&(h=r,_=s.x+h*(o.x-s.x),m=s.y+h*(o.y-s.y),l.lowerBound.x=b2Min(s.x,_),l.lowerBound.y=b2Min(s.y,m),l.upperBound.x=b2Max(s.x,_),l.upperBound.y=b2Max(s.y,m))}else c.Push(t.child1),c.Push(t.child2)}}AllocateNode(){if(null!==this.m_freeList){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t.moved=!1,t}return new b2TreeNode(b2DynamicTree.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode();return i.aabb.lowerBound.x=t.lowerBound.x-.1,i.aabb.lowerBound.y=t.lowerBound.y-.1,i.aabb.upperBound.x=t.upperBound.x+.1,i.aabb.upperBound.y=t.upperBound.y+.1,i.userData=e,i.height=0,i.moved=!0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){const s=b2DynamicTree.MoveProxy_s_fatAABB,o=r,n=r;s.lowerBound.x=e.lowerBound.x-o,s.lowerBound.y=e.lowerBound.y-n,s.upperBound.x=e.upperBound.x+o,s.upperBound.y=e.upperBound.y+n;const a=4*i.x,h=4*i.y;a<0?s.lowerBound.x+=a:s.upperBound.x+=a,h<0?s.lowerBound.y+=h:s.upperBound.y+=h;const l=t.aabb;if(l.Contains(e)){const t=b2DynamicTree.MoveProxy_s_hugeAABB;if(t.lowerBound.x=s.lowerBound.x-.4,t.lowerBound.y=s.lowerBound.y-.4,t.upperBound.x=s.upperBound.x+.4,t.upperBound.y=s.upperBound.y+.4,t.Contains(l))return!1}return this.RemoveLeaf(t),t.aabb.Copy(s),this.InsertLeaf(t),t.moved=!0,!0}InsertLeaf(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);const e=t.aabb;let i=this.m_root;for(;!i.IsLeaf();){const t=verify(i.child1),s=verify(i.child2),o=i.aabb.GetPerimeter(),n=b2DynamicTree.s_combinedAABB;n.Combine2(i.aabb,e);const r=n.GetPerimeter(),a=2*r,h=2*(r-o);let l;const _=b2DynamicTree.s_aabb;let m,c,b;if(t.IsLeaf()?(_.Combine2(e,t.aabb),l=_.GetPerimeter()+h):(_.Combine2(e,t.aabb),m=t.aabb.GetPerimeter(),c=_.GetPerimeter(),l=c-m+h),s.IsLeaf()?(_.Combine2(e,s.aabb),b=_.GetPerimeter()+h):(_.Combine2(e,s.aabb),m=s.aabb.GetPerimeter(),c=_.GetPerimeter(),b=c-m+h),a<l&&a<b)break;i=l<b?t:s}const s=i.parent,o=this.AllocateNode();o.parent=s,o.aabb.Combine2(e,i.aabb),o.height=i.height+1,null!==s?(s.child1===i?s.child1=o:s.child2=o,o.child1=i,o.child2=t,i.parent=o,t.parent=o):(o.child1=i,o.child2=t,i.parent=o,t.parent=o,this.m_root=o);let n=t.parent;for(;null!==n;){n=this.Balance(n);const t=verify(n.child1),e=verify(n.child2);n.height=1+b2Max(t.height,e.height),n.aabb.Combine2(t.aabb,e.aabb),n=n.parent}}RemoveLeaf(t){if(t===this.m_root)return void(this.m_root=null);const e=verify(t.parent),i=e&&e.parent,s=verify(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=s:i.child2=s,s.parent=i,this.FreeNode(e);let t=i;for(;null!==t;){t=this.Balance(t);const e=verify(t.child1),i=verify(t.child2);t.aabb.Combine2(e.aabb,i.aabb),t.height=1+b2Max(e.height,i.height),t=t.parent}}else this.m_root=s,s.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=verify(t.child1),i=verify(t.child2),s=i.height-e.height;if(s>1){const s=verify(i.child1),o=verify(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,s.height>o.height?(i.child2=s,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+b2Max(e.height,o.height),i.height=1+b2Max(t.height,s.height)):(i.child2=o,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,o.aabb),t.height=1+b2Max(e.height,s.height),i.height=1+b2Max(t.height,o.height)),i}if(s<-1){const s=verify(e.child1),o=verify(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,s.height>o.height?(e.child2=s,t.child1=o,o.parent=t,t.aabb.Combine2(i.aabb,o.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+b2Max(i.height,o.height),e.height=1+b2Max(t.height,s.height)):(e.child2=o,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,o.aabb),t.height=1+b2Max(i.height,s.height),e.height=1+b2Max(t.height,o.height)),e}return t}GetHeight(){return null===this.m_root?0:this.m_root.height}static GetAreaNode(t){if(null===t)return 0;if(t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=b2DynamicTree.GetAreaNode(t.child1),e+=b2DynamicTree.GetAreaNode(t.child2),e}GetAreaRatio(){if(null===this.m_root)return 0;const t=this.m_root.aabb.GetPerimeter();return b2DynamicTree.GetAreaNode(this.m_root)/t}static ComputeHeightNode(t){if(null===t)return 0;if(t.IsLeaf())return 0;return 1+b2Max(b2DynamicTree.ComputeHeightNode(t.child1),b2DynamicTree.ComputeHeightNode(t.child2))}ComputeHeight(){return b2DynamicTree.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(null===t)return;if(this.m_root,t.IsLeaf())return;const e=verify(t.child1),i=verify(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}ValidateMetrics(t){if(null===t)return;if(t.IsLeaf())return;const e=verify(t.child1),i=verify(t.child2);b2DynamicTree.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)}Validate(){}static GetMaxBalanceNode(t,e){if(null===t)return e;if(t.height<=1)return e;const i=verify(t.child1),s=verify(t.child2);return b2Max(e,S(s.height-i.height))}GetMaxBalance(){return b2DynamicTree.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(null===t)return;if(t.height<=1)return;const i=t.child1,s=t.child2;b2DynamicTree.ShiftOriginNode(i,e),b2DynamicTree.ShiftOriginNode(s,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){b2DynamicTree.ShiftOriginNode(this.m_root,t)}}b2DynamicTree.s_r=new b2Vec2,b2DynamicTree.s_v=new b2Vec2,b2DynamicTree.s_abs_v=new b2Vec2,b2DynamicTree.s_segmentAABB=new b2AABB,b2DynamicTree.s_subInput=new b2RayCastInput,b2DynamicTree.s_combinedAABB=new b2AABB,b2DynamicTree.s_aabb=new b2AABB,b2DynamicTree.s_node_id=0,b2DynamicTree.MoveProxy_s_fatAABB=new b2AABB,b2DynamicTree.MoveProxy_s_hugeAABB=new b2AABB;class b2Pair{constructor(t,e){this.proxyA=t,this.proxyB=e}}class b2BroadPhase{constructor(){this.m_tree=new b2DynamicTree,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];if(null===e)continue;const i=e.aabb;this.m_tree.Query(i,(t=>{if(t.m_id===e.m_id)return!0;if(t.moved&&t.m_id>e.m_id)return!0;let i,s;if(t.m_id<e.m_id?(i=t,s=e):(i=e,s=t),this.m_pairCount===this.m_pairBuffer.length)this.m_pairBuffer[this.m_pairCount]=new b2Pair(i,s);else{const t=this.m_pairBuffer[this.m_pairCount];t.proxyA=i,t.proxyB=s}return++this.m_pairCount,!0}))}for(let e=0;e<this.m_pairCount;++e){const i=this.m_pairBuffer[e];t(i.proxyA.userData,i.proxyB.userData)}for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];null!==e&&(e.moved=!1)}this.m_moveCount=0}Query(...t){this.m_tree.Query(t[0],t[1])}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){for(let e=0;e<this.m_moveCount;e++)this.m_moveBuffer[e]==t&&(this.m_moveBuffer[e]=null)}}class b2EdgeShape extends b2Shape{constructor(){super(t.b2ShapeType.e_edgeShape,l),this.m_vertex1=new b2Vec2,this.m_vertex2=new b2Vec2,this.m_vertex0=new b2Vec2,this.m_vertex3=new b2Vec2,this.m_oneSided=!1}SetOneSided(t,e,i,s){return this.m_vertex0.Copy(t),this.m_vertex1.Copy(e),this.m_vertex2.Copy(i),this.m_vertex3.Copy(s),this.m_oneSided=!0,this}SetTwoSided(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_oneSided=!1,this}Clone(){return(new b2EdgeShape).Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_oneSided=t.m_oneSided,this}GetChildCount(){return 1}TestPoint(t,e){return!1}RayCast(t,e,i,s){const o=b2Transform.MulTXV(i,e.p1,b2EdgeShape.RayCast_s_p1),n=b2Transform.MulTXV(i,e.p2,b2EdgeShape.RayCast_s_p2),r=b2Vec2.SubVV(n,o,b2EdgeShape.RayCast_s_d),a=this.m_vertex1,h=this.m_vertex2,l=b2Vec2.SubVV(h,a,b2EdgeShape.RayCast_s_e),_=t.normal.Set(l.y,-l.x).SelfNormalize(),m=b2Vec2.DotVV(_,b2Vec2.SubVV(a,o,b2Vec2.s_t0));if(this.m_oneSided&&m>0)return!1;const c=b2Vec2.DotVV(_,r);if(0===c)return!1;const b=m/c;if(b<0||e.maxFraction<b)return!1;const u=b2Vec2.AddVMulSV(o,b,r,b2EdgeShape.RayCast_s_q),d=b2Vec2.SubVV(h,a,b2EdgeShape.RayCast_s_r),p=b2Vec2.DotVV(d,d);if(0===p)return!1;const y=b2Vec2.DotVV(b2Vec2.SubVV(u,a,b2Vec2.s_t0),d)/p;return!(y<0||1<y)&&(t.fraction=b,b2Rot.MulRV(i.q,t.normal,t.normal),m>0&&t.normal.SelfNeg(),!0)}ComputeAABB(t,e,i){const s=b2Transform.MulXV(e,this.m_vertex1,b2EdgeShape.ComputeAABB_s_v1),o=b2Transform.MulXV(e,this.m_vertex2,b2EdgeShape.ComputeAABB_s_v2);b2Vec2.MinV(s,o,t.lowerBound),b2Vec2.MaxV(s,o,t.upperBound);const n=this.m_radius;t.lowerBound.SelfSubXY(n,n),t.upperBound.SelfAddXY(n,n)}ComputeMass(t,e){t.mass=0,b2Vec2.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){return s.SetZero(),0}Dump(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_oneSided = %s;\n",this.m_oneSided)}}b2EdgeShape.RayCast_s_p1=new b2Vec2,b2EdgeShape.RayCast_s_p2=new b2Vec2,b2EdgeShape.RayCast_s_d=new b2Vec2,b2EdgeShape.RayCast_s_e=new b2Vec2,b2EdgeShape.RayCast_s_q=new b2Vec2,b2EdgeShape.RayCast_s_r=new b2Vec2,b2EdgeShape.ComputeAABB_s_v1=new b2Vec2,b2EdgeShape.ComputeAABB_s_v2=new b2Vec2;class b2ChainShape extends b2Shape{constructor(){super(t.b2ShapeType.e_chainShape,l),this.m_vertices=[],this.m_count=0,this.m_prevVertex=new b2Vec2,this.m_nextVertex=new b2Vec2}CreateLoop(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._CreateLoop((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._CreateLoop((t=>e[t]),i)}}_CreateLoop(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=b2Vec2.MakeArray(this.m_count);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this}CreateChain(...t){if("number"==typeof t[0][0]){const e=t[0],i=t[1],s=t[2];if(e.length%2!=0)throw new Error;return this._CreateChain((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2,i,s)}{const e=t[0],i=t[1]||e.length,s=t[2],o=t[3];return this._CreateChain((t=>e[t]),i,s,o)}}_CreateChain(t,e,i,s){this.m_count=e,this.m_vertices=b2Vec2.MakeArray(e);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_prevVertex.Copy(i),this.m_nextVertex.Copy(s),this}Clone(){return(new b2ChainShape).Copy(this)}Copy(t){return super.Copy(t),this._CreateChain((e=>t.m_vertices[e]),t.m_count,t.m_prevVertex,t.m_nextVertex),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this}GetChildCount(){return this.m_count-1}GetChildEdge(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),t.m_oneSided=!0,e>0?t.m_vertex0.Copy(this.m_vertices[e-1]):t.m_vertex0.Copy(this.m_prevVertex),e<this.m_count-2?t.m_vertex3.Copy(this.m_vertices[e+2]):t.m_vertex3.Copy(this.m_nextVertex)}TestPoint(t,e){return!1}RayCast(t,e,i,s){const o=b2ChainShape.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[s]),o.m_vertex2.Copy(this.m_vertices[(s+1)%this.m_count]),o.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const s=this.m_vertices[i],o=this.m_vertices[(i+1)%this.m_count],n=b2Transform.MulXV(e,s,b2ChainShape.ComputeAABB_s_v1),r=b2Transform.MulXV(e,o,b2ChainShape.ComputeAABB_s_v2),a=b2Vec2.MinV(n,r,b2ChainShape.ComputeAABB_s_lower),h=b2Vec2.MaxV(n,r,b2ChainShape.ComputeAABB_s_upper);t.lowerBound.x=a.x-this.m_radius,t.lowerBound.y=a.y-this.m_radius,t.upperBound.x=h.x+this.m_radius,t.upperBound.y=h.y+this.m_radius}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){return s.SetZero(),0}Dump(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y)}}b2ChainShape.RayCast_s_edgeShape=new b2EdgeShape,b2ChainShape.ComputeAABB_s_v1=new b2Vec2,b2ChainShape.ComputeAABB_s_v2=new b2Vec2,b2ChainShape.ComputeAABB_s_lower=new b2Vec2,b2ChainShape.ComputeAABB_s_upper=new b2Vec2;class b2CircleShape extends b2Shape{constructor(e=0){super(t.b2ShapeType.e_circleShape,e),this.m_p=new b2Vec2}Set(t,e=this.m_radius){return this.m_p.Copy(t),this.m_radius=e,this}Clone(){return(new b2CircleShape).Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=b2Transform.MulXV(t,this.m_p,b2CircleShape.TestPoint_s_center),s=b2Vec2.SubVV(e,i,b2CircleShape.TestPoint_s_d);return b2Vec2.DotVV(s,s)<=b2Sq(this.m_radius)}RayCast(t,e,i,o){const n=b2Transform.MulXV(i,this.m_p,b2CircleShape.RayCast_s_position),r=b2Vec2.SubVV(e.p1,n,b2CircleShape.RayCast_s_s),a=b2Vec2.DotVV(r,r)-b2Sq(this.m_radius),h=b2Vec2.SubVV(e.p2,e.p1,b2CircleShape.RayCast_s_r),l=b2Vec2.DotVV(r,h),_=b2Vec2.DotVV(h,h),m=l*l-_*a;if(m<0||_<s)return!1;let c=-(l+A(m));return 0<=c&&c<=e.maxFraction*_&&(c/=_,t.fraction=c,b2Vec2.AddVMulSV(r,c,h,t.normal).SelfNormalize(),!0)}ComputeAABB(t,e,i){const s=b2Transform.MulXV(e,this.m_p,b2CircleShape.ComputeAABB_s_p);t.lowerBound.Set(s.x-this.m_radius,s.y-this.m_radius),t.upperBound.Set(s.x+this.m_radius,s.y+this.m_radius)}ComputeMass(t,e){const i=b2Sq(this.m_radius);t.mass=e*n*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+b2Vec2.DotVV(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,o){const r=b2Transform.MulXV(i,this.m_p,new b2Vec2),a=-(b2Vec2.DotVV(t,r)-e);if(a<-this.m_radius+s)return 0;if(a>this.m_radius)return o.Copy(r),n*this.m_radius*this.m_radius;const h=this.m_radius*this.m_radius,l=a*a,_=h*(v(a/this.m_radius)+n/2)+a*A(h-l),m=-2/3*C(h-l,1.5)/_;return o.x=r.x+t.x*m,o.y=r.y+t.y*m,_}Dump(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)}}b2CircleShape.TestPoint_s_center=new b2Vec2,b2CircleShape.TestPoint_s_d=new b2Vec2,b2CircleShape.RayCast_s_position=new b2Vec2,b2CircleShape.RayCast_s_s=new b2Vec2,b2CircleShape.RayCast_s_r=new b2Vec2,b2CircleShape.ComputeAABB_s_p=new b2Vec2;const $=new b2Vec2,tt=new b2Vec2;function b2CollideCircles(e,i,s,o,n){e.pointCount=0;const r=b2Transform.MulXV(s,i.m_p,$),a=b2Transform.MulXV(n,o.m_p,tt),h=b2Vec2.DistanceSquaredVV(r,a),l=i.m_radius+o.m_radius;h>l*l||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(i.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0)}const et=new b2Vec2,it=new b2Vec2,st=new b2Vec2;function b2CollidePolygonAndCircle(e,o,n,r,a){e.pointCount=0;const h=b2Transform.MulXV(a,r.m_p,et),l=b2Transform.MulTXV(n,h,it);let _=0,m=-i;const c=o.m_radius+r.m_radius,b=o.m_count,u=o.m_vertices,d=o.m_normals;for(let t=0;t<b;++t){const e=b2Vec2.DotVV(d[t],b2Vec2.SubVV(l,u[t],b2Vec2.s_t0));if(e>c)return;e>m&&(m=e,_=t)}const p=_,y=(p+1)%b,V=u[p],x=u[y];if(m<s)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[_]),b2Vec2.MidVV(V,x,e.localPoint),e.points[0].localPoint.Copy(r.m_p),void(e.points[0].id.key=0);const S=b2Vec2.DotVV(b2Vec2.SubVV(l,V,b2Vec2.s_t0),b2Vec2.SubVV(x,V,b2Vec2.s_t1)),f=b2Vec2.DotVV(b2Vec2.SubVV(l,x,b2Vec2.s_t0),b2Vec2.SubVV(V,x,b2Vec2.s_t1));if(S<=0){if(b2Vec2.DistanceSquaredVV(l,V)>c*c)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,b2Vec2.SubVV(l,V,e.localNormal).SelfNormalize(),e.localPoint.Copy(V),e.points[0].localPoint.Copy(r.m_p),e.points[0].id.key=0}else if(f<=0){if(b2Vec2.DistanceSquaredVV(l,x)>c*c)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,b2Vec2.SubVV(l,x,e.localNormal).SelfNormalize(),e.localPoint.Copy(x),e.points[0].localPoint.Copy(r.m_p),e.points[0].id.key=0}else{const i=b2Vec2.MidVV(V,x,st);if(b2Vec2.DotVV(b2Vec2.SubVV(l,i,b2Vec2.s_t1),d[p])>c)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[p]).SelfNormalize(),e.localPoint.Copy(i),e.points[0].localPoint.Copy(r.m_p),e.points[0].id.key=0}}const ot=new b2Vec2,nt=new b2Vec2,rt=new b2Vec2,at=new b2Vec2,ht=new b2Vec2,lt=new b2Vec2,_t=new b2Vec2,mt=new b2ContactID;function b2CollideEdgeAndCircle(e,i,s,o,n){e.pointCount=0;const r=b2Transform.MulTXV(s,b2Transform.MulXV(n,o.m_p,b2Vec2.s_t0),ot),a=i.m_vertex1,h=i.m_vertex2,l=b2Vec2.SubVV(h,a,nt),_=_t.Set(l.y,-l.x),m=b2Vec2.DotVV(_,b2Vec2.SubVV(r,a,b2Vec2.s_t0));if(i.m_oneSided&&m<0)return;const c=b2Vec2.DotVV(l,b2Vec2.SubVV(h,r,b2Vec2.s_t0)),b=b2Vec2.DotVV(l,b2Vec2.SubVV(r,a,b2Vec2.s_t0)),u=i.m_radius+o.m_radius,d=mt;if(d.cf.indexB=0,d.cf.typeB=t.b2ContactFeatureType.e_vertex,b<=0){const s=a,n=b2Vec2.SubVV(r,s,rt);if(b2Vec2.DotVV(n,n)>u*u)return;if(i.m_oneSided){const t=i.m_vertex0,e=a,s=b2Vec2.SubVV(e,t,at);if(b2Vec2.DotVV(s,b2Vec2.SubVV(e,r,b2Vec2.s_t0))>0)return}return d.cf.indexA=0,d.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(s),e.points[0].id.Copy(d),void e.points[0].localPoint.Copy(o.m_p)}if(c<=0){const s=h,n=b2Vec2.SubVV(r,s,rt);if(b2Vec2.DotVV(n,n)>u*u)return;if(i.m_oneSided){const t=i.m_vertex3,e=h,s=b2Vec2.SubVV(t,e,ht);if(b2Vec2.DotVV(s,b2Vec2.SubVV(r,e,b2Vec2.s_t0))>0)return}return d.cf.indexA=1,d.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(s),e.points[0].id.Copy(d),void e.points[0].localPoint.Copy(o.m_p)}const p=b2Vec2.DotVV(l,l),y=lt;y.x=1/p*(c*a.x+b*h.x),y.y=1/p*(c*a.y+b*h.y);const V=b2Vec2.SubVV(r,y,rt);b2Vec2.DotVV(V,V)>u*u||(m<0&&_.Set(-_.x,-_.y),_.Normalize(),d.cf.indexA=0,d.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(_),e.localPoint.Copy(a),e.points[0].id.Copy(d),e.points[0].localPoint.Copy(o.m_p))}var ct;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(ct||(ct={}));class b2EPAxis{constructor(){this.normal=new b2Vec2,this.type=ct.e_unknown,this.index=0,this.separation=0}}const bt=new b2EPAxis,ut=[new b2Vec2,new b2Vec2];const dt=new b2EPAxis,pt=new b2Vec2;const yt=new b2Transform,Vt=new b2Vec2,xt=new b2Vec2,St=new b2Vec2,ft=new b2Vec2,At=new b2Vec2,Ct=new b2Vec2,wt=new b2Vec2,gt=new class{constructor(){this.vertices=[],this.normals=[],this.count=0}},Bt=new class{constructor(){this.i1=0,this.i2=0,this.v1=new b2Vec2,this.v2=new b2Vec2,this.normal=new b2Vec2,this.sideNormal1=new b2Vec2,this.sideOffset1=0,this.sideNormal2=new b2Vec2,this.sideOffset2=0}},vt=[new b2ClipVertex,new b2ClipVertex],Mt=[new b2ClipVertex,new b2ClipVertex],It=[new b2ClipVertex,new b2ClipVertex];function b2CollideEdgeAndPolygon(e,i,s,o,n){e.pointCount=0;const r=b2Transform.MulTXX(s,n,yt),a=b2Transform.MulXV(r,o.m_centroid,Vt),h=i.m_vertex1,l=i.m_vertex2,_=b2Vec2.SubVV(l,h,xt);_.Normalize();const m=St.Set(_.y,-_.x),c=b2Vec2.DotVV(m,b2Vec2.SubVV(a,h,b2Vec2.s_t0)),b=i.m_oneSided;if(b&&c<0)return;const u=gt;u.count=o.m_count;for(let t=0;t<o.m_count;++t)u.vertices.length<=t&&u.vertices.push(new b2Vec2),u.normals.length<=t&&u.normals.push(new b2Vec2),b2Transform.MulXV(r,o.m_vertices[t],u.vertices[t]),b2Rot.MulRV(r.q,o.m_normals[t],u.normals[t]);const d=o.m_radius+i.m_radius,p=function(t,e,i){const s=bt;s.type=ct.e_edgeA,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.SetZero();const o=ut;o[0].Copy(i),o[1].Copy(i).SelfNeg();for(let i=0;i<2;++i){let n=Number.MAX_VALUE;for(let s=0;s<t.count;++s){const r=b2Vec2.DotVV(o[i],b2Vec2.SubVV(t.vertices[s],e,b2Vec2.s_t0));r<n&&(n=r)}n>s.separation&&(s.index=i,s.separation=n,s.normal.Copy(o[i]))}return s}(u,h,m);if(p.separation>d)return;const y=function(t,e,i){const s=dt;s.type=ct.e_unknown,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.SetZero();for(let o=0;o<t.count;++o){const n=b2Vec2.NegV(t.normals[o],pt),r=b2Min(b2Vec2.DotVV(n,b2Vec2.SubVV(t.vertices[o],e,b2Vec2.s_t0)),b2Vec2.DotVV(n,b2Vec2.SubVV(t.vertices[o],i,b2Vec2.s_t0)));r>s.separation&&(s.type=ct.e_edgeB,s.index=o,s.separation=r,s.normal.Copy(n))}return s}(u,h,l);if(y.separation>d)return;let V;if(V=y.separation-d>.98*(p.separation-d)+.001?y:p,b){const t=b2Vec2.SubVV(h,i.m_vertex0,ft);t.Normalize();const e=At.Set(t.y,-t.x),s=b2Vec2.CrossVV(t,_)>=0,o=b2Vec2.SubVV(i.m_vertex3,l,Ct);o.Normalize();const n=wt.Set(o.y,-o.x),r=b2Vec2.CrossVV(_,o)>=0,a=.1;if(b2Vec2.DotVV(V.normal,_)<=0)if(s){if(b2Vec2.CrossVV(V.normal,e)>a)return}else V=p;else if(r){if(b2Vec2.CrossVV(n,V.normal)>a)return}else V=p}const x=vt,S=Bt;if(V.type===ct.e_edgeA){e.type=t.b2ManifoldType.e_faceA;let i=0,s=b2Vec2.DotVV(V.normal,u.normals[0]);for(let t=1;t<u.count;++t){const e=b2Vec2.DotVV(V.normal,u.normals[t]);e<s&&(s=e,i=t)}const o=i,n=o+1<u.count?o+1:0;x[0].v.Copy(u.vertices[o]),x[0].id.cf.indexA=0,x[0].id.cf.indexB=o,x[0].id.cf.typeA=t.b2ContactFeatureType.e_face,x[0].id.cf.typeB=t.b2ContactFeatureType.e_vertex,x[1].v.Copy(u.vertices[n]),x[1].id.cf.indexA=0,x[1].id.cf.indexB=n,x[1].id.cf.typeA=t.b2ContactFeatureType.e_face,x[1].id.cf.typeB=t.b2ContactFeatureType.e_vertex,S.i1=0,S.i2=1,S.v1.Copy(h),S.v2.Copy(l),S.normal.Copy(V.normal),S.sideNormal1.Copy(_).SelfNeg(),S.sideNormal2.Copy(_)}else e.type=t.b2ManifoldType.e_faceB,x[0].v.Copy(l),x[0].id.cf.indexA=1,x[0].id.cf.indexB=V.index,x[0].id.cf.typeA=t.b2ContactFeatureType.e_vertex,x[0].id.cf.typeB=t.b2ContactFeatureType.e_face,x[1].v.Copy(h),x[1].id.cf.indexA=0,x[1].id.cf.indexB=V.index,x[1].id.cf.typeA=t.b2ContactFeatureType.e_vertex,x[1].id.cf.typeB=t.b2ContactFeatureType.e_face,S.i1=V.index,S.i2=S.i1+1<u.count?S.i1+1:0,S.v1.Copy(u.vertices[S.i1]),S.v2.Copy(u.vertices[S.i2]),S.normal.Copy(u.normals[S.i1]),S.sideNormal1.Set(S.normal.y,-S.normal.x),S.sideNormal2.Copy(S.sideNormal1).SelfNeg();S.sideOffset1=b2Vec2.DotVV(S.sideNormal1,S.v1),S.sideOffset2=b2Vec2.DotVV(S.sideNormal2,S.v2);const f=Mt,A=It;let C;if(C=b2ClipSegmentToLine(f,x,S.sideNormal1,S.sideOffset1,S.i1),C<2)return;if(C=b2ClipSegmentToLine(A,f,S.sideNormal2,S.sideOffset2,S.i2),C<2)return;V.type===ct.e_edgeA?(e.localNormal.Copy(S.normal),e.localPoint.Copy(S.v1)):(e.localNormal.Copy(o.m_normals[S.i1]),e.localPoint.Copy(o.m_vertices[S.i1]));let w=0;for(let t=0;t<2;++t){if(b2Vec2.DotVV(S.normal,b2Vec2.SubVV(A[t].v,S.v1,b2Vec2.s_t0))<=d){const i=e.points[w];V.type===ct.e_edgeA?(b2Transform.MulTXV(r,A[t].v,i.localPoint),i.id.Copy(A[t].id)):(i.localPoint.Copy(A[t].v),i.id.cf.typeA=A[t].id.cf.typeB,i.id.cf.typeB=A[t].id.cf.typeA,i.id.cf.indexA=A[t].id.cf.indexB,i.id.cf.indexB=A[t].id.cf.indexA),++w}}e.pointCount=w}const Pt=new b2Transform,Dt=new b2Vec2,Tt=new b2Vec2;function b2FindMaxSeparation(t,e,s,o,n){const r=e.m_count,a=o.m_count,h=e.m_normals,l=e.m_vertices,_=o.m_vertices,m=b2Transform.MulTXX(n,s,Pt);let c=0,b=-i;for(let t=0;t<r;++t){const e=b2Rot.MulRV(m.q,h[t],Dt),s=b2Transform.MulXV(m,l[t],Tt);let o=i;for(let t=0;t<a;++t){const i=b2Vec2.DotVV(e,b2Vec2.SubVV(_[t],s,b2Vec2.s_t0));i<o&&(o=i)}o>b&&(b=o,c=t)}return t[0]=c,b}const Rt=new b2Vec2;const Gt=[new b2ClipVertex,new b2ClipVertex],Jt=[new b2ClipVertex,new b2ClipVertex],Lt=[new b2ClipVertex,new b2ClipVertex],Ft=[0],kt=[0],Et=new b2Vec2,jt=new b2Vec2,qt=new b2Vec2,Ot=new b2Vec2,zt=new b2Vec2,Xt=new b2Vec2,Wt=new b2Vec2,Nt=new b2Vec2;function b2CollidePolygons(e,s,o,n,r){e.pointCount=0;const a=s.m_radius+n.m_radius,h=Ft;h[0]=0;const l=b2FindMaxSeparation(h,s,o,n,r);if(l>a)return;const _=kt;_[0]=0;const m=b2FindMaxSeparation(_,n,r,s,o);if(m>a)return;let c,b,u,d,p=0,y=0;m>l+5e-4?(c=n,b=s,u=r,d=o,p=_[0],e.type=t.b2ManifoldType.e_faceB,y=1):(c=s,b=n,u=o,d=r,p=h[0],e.type=t.b2ManifoldType.e_faceA,y=0);const V=Gt;!function(e,s,o,n,r,a){const h=s.m_normals,l=r.m_count,_=r.m_vertices,m=r.m_normals,c=b2Rot.MulTRV(a.q,b2Rot.MulRV(o.q,h[n],b2Vec2.s_t0),Rt);let b=0,u=i;for(let t=0;t<l;++t){const e=b2Vec2.DotVV(c,m[t]);e<u&&(u=e,b=t)}const d=b,p=d+1<l?d+1:0,y=e[0];b2Transform.MulXV(a,_[d],y.v);const V=y.id.cf;V.indexA=n,V.indexB=d,V.typeA=t.b2ContactFeatureType.e_face,V.typeB=t.b2ContactFeatureType.e_vertex;const x=e[1];b2Transform.MulXV(a,_[p],x.v);const S=x.id.cf;S.indexA=n,S.indexB=p,S.typeA=t.b2ContactFeatureType.e_face,S.typeB=t.b2ContactFeatureType.e_vertex}(V,c,u,p,b,d);const x=c.m_count,S=c.m_vertices,f=p,A=p+1<x?p+1:0,C=S[f],w=S[A],g=b2Vec2.SubVV(w,C,Et);g.Normalize();const B=b2Vec2.CrossVOne(g,jt),v=b2Vec2.MidVV(C,w,qt),M=b2Rot.MulRV(u.q,g,zt),I=b2Vec2.CrossVOne(M,Ot),P=b2Transform.MulXV(u,C,Wt),D=b2Transform.MulXV(u,w,Nt),T=b2Vec2.DotVV(I,P),R=-b2Vec2.DotVV(M,P)+a,G=b2Vec2.DotVV(M,D)+a,J=Jt,L=Lt;let F;if(F=b2ClipSegmentToLine(J,V,b2Vec2.NegV(M,Xt),R,f),F<2)return;if(F=b2ClipSegmentToLine(L,J,M,G,A),F<2)return;e.localNormal.Copy(B),e.localPoint.Copy(v);let k=0;for(let t=0;t<2;++t){const i=L[t];if(b2Vec2.DotVV(I,i.v)-T<=a){const t=e.points[k];if(b2Transform.MulTXV(d,i.v,t.localPoint),t.id.Copy(i.id),y){const e=t.id.cf;t.id.cf.indexA=e.indexB,t.id.cf.indexB=e.indexA,t.id.cf.typeA=e.typeB,t.id.cf.typeB=e.typeA}++k}}e.pointCount=k}class b2PolygonShape extends b2Shape{constructor(){super(t.b2ShapeType.e_polygonShape,l),this.m_centroid=new b2Vec2(0,0),this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return(new b2PolygonShape).Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=b2Vec2.MakeArray(this.m_count),this.m_normals=b2Vec2.MakeArray(this.m_count);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._Set((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._Set((t=>e[t]),i)}}_Set(t,e){if(e<3)return this.SetAsBox(1,1);let i=e;const s=[];for(let e=0;e<i;++e){const i=t(e);let o=!0;for(let t=0;t<s.length;++t)if(b2Vec2.DistanceSquaredVV(i,s[t])<625e-8){o=!1;break}o&&s.push(i)}if(i=s.length,i<3)return this.SetAsBox(1,1);let o=0,n=s[0].x;for(let t=1;t<i;++t){const e=s[t].x;(e>n||e===n&&s[t].y<s[o].y)&&(o=t,n=e)}const r=[];let a=0,h=o;for(;;){r[a]=h;let t=0;for(let e=1;e<i;++e){if(t===h){t=e;continue}const i=b2Vec2.SubVV(s[t],s[r[a]],b2PolygonShape.Set_s_r),o=b2Vec2.SubVV(s[e],s[r[a]],b2PolygonShape.Set_s_v),n=b2Vec2.CrossVV(i,o);n<0&&(t=e),0===n&&o.LengthSquared()>i.LengthSquared()&&(t=e)}if(++a,h=t,t===o)break}this.m_count=a,this.m_vertices=b2Vec2.MakeArray(this.m_count),this.m_normals=b2Vec2.MakeArray(this.m_count);for(let t=0;t<a;++t)this.m_vertices[t].Copy(s[r[t]]);for(let t=0;t<a;++t){const e=this.m_vertices[t],i=this.m_vertices[(t+1)%a],s=b2Vec2.SubVV(i,e,b2Vec2.s_t0);b2Vec2.CrossVOne(s,this.m_normals[t]).SelfNormalize()}return b2PolygonShape.ComputeCentroid(this.m_vertices,a,this.m_centroid),this}SetAsBox(t,e,i,s=0){if(this.m_count=4,this.m_vertices=b2Vec2.MakeArray(this.m_count),this.m_normals=b2Vec2.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);const t=new b2Transform;t.SetPosition(i),t.SetRotationAngle(s);for(let e=0;e<this.m_count;++e)b2Transform.MulXV(t,this.m_vertices[e],this.m_vertices[e]),b2Rot.MulRV(t.q,this.m_normals[e],this.m_normals[e])}return this}TestPoint(t,e){const i=b2Transform.MulTXV(t,e,b2PolygonShape.TestPoint_s_pLocal);for(let t=0;t<this.m_count;++t){if(b2Vec2.DotVV(this.m_normals[t],b2Vec2.SubVV(i,this.m_vertices[t],b2Vec2.s_t0))>0)return!1}return!0}RayCast(t,e,i,s){const o=b2Transform.MulTXV(i,e.p1,b2PolygonShape.RayCast_s_p1),n=b2Transform.MulTXV(i,e.p2,b2PolygonShape.RayCast_s_p2),r=b2Vec2.SubVV(n,o,b2PolygonShape.RayCast_s_d);let a=0,h=e.maxFraction,l=-1;for(let t=0;t<this.m_count;++t){const e=b2Vec2.DotVV(this.m_normals[t],b2Vec2.SubVV(this.m_vertices[t],o,b2Vec2.s_t0)),i=b2Vec2.DotVV(this.m_normals[t],r);if(0===i){if(e<0)return!1}else i<0&&e<a*i?(a=e/i,l=t):i>0&&e<h*i&&(h=e/i);if(h<a)return!1}return l>=0&&(t.fraction=a,b2Rot.MulRV(i.q,this.m_normals[l],t.normal),!0)}ComputeAABB(t,e,i){const s=b2Transform.MulXV(e,this.m_vertices[0],t.lowerBound),o=t.upperBound.Copy(s);for(let t=0;t<this.m_count;++t){const i=b2Transform.MulXV(e,this.m_vertices[t],b2PolygonShape.ComputeAABB_s_v);b2Vec2.MinV(i,s,s),b2Vec2.MaxV(i,o,o)}const n=this.m_radius;s.SelfSubXY(n,n),o.SelfAddXY(n,n)}ComputeMass(t,e){const i=b2PolygonShape.ComputeMass_s_center.SetZero();let s=0,o=0;const n=b2PolygonShape.ComputeMass_s_s.Copy(this.m_vertices[0]),r=1/3;for(let t=0;t<this.m_count;++t){const e=b2Vec2.SubVV(this.m_vertices[t],n,b2PolygonShape.ComputeMass_s_e1),a=b2Vec2.SubVV(this.m_vertices[(t+1)%this.m_count],n,b2PolygonShape.ComputeMass_s_e2),h=b2Vec2.CrossVV(e,a),l=.5*h;s+=l,i.SelfAdd(b2Vec2.MulSV(l*r,b2Vec2.AddVV(e,a,b2Vec2.s_t0),b2Vec2.s_t1));const _=e.x,m=e.y,c=a.x,b=a.y;o+=.25*r*h*(_*_+c*_+c*c+(m*m+b*m+b*b))}t.mass=e*s,i.SelfMul(1/s),b2Vec2.AddVV(i,n,t.center),t.I=e*o,t.I+=t.mass*(b2Vec2.DotVV(t.center,t.center)-b2Vec2.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,s=this.m_vertices[e],o=b2Vec2.SubVV(this.m_vertices[i],s,b2PolygonShape.Validate_s_e);for(let t=0;t<this.m_count;++t){if(t===e||t===i)continue;const n=b2Vec2.SubVV(this.m_vertices[t],s,b2PolygonShape.Validate_s_v);if(b2Vec2.CrossVV(o,n)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){const o=b2Rot.MulTRV(i.q,t,b2PolygonShape.ComputeSubmergedArea_s_normalL),n=e-b2Vec2.DotVV(t,i.p),r=[];let a=0,h=-1,l=-1,_=!1;for(let t=0;t<this.m_count;++t){r[t]=b2Vec2.DotVV(o,this.m_vertices[t])-n;const e=r[t]<-1e-5;t>0&&(e?_||(h=t-1,a++):_&&(l=t-1,a++)),_=e}switch(a){case 0:if(_){const t=b2PolygonShape.ComputeSubmergedArea_s_md;return this.ComputeMass(t,1),b2Transform.MulXV(i,t.center,s),t.mass}return 0;case 1:-1===h?h=this.m_count-1:l=this.m_count-1}const m=(h+1)%this.m_count,c=(l+1)%this.m_count,b=(0-r[h])/(r[m]-r[h]),u=(0-r[l])/(r[c]-r[l]),d=b2PolygonShape.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[h].x*(1-b)+this.m_vertices[m].x*b,this.m_vertices[h].y*(1-b)+this.m_vertices[m].y*b),p=b2PolygonShape.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[l].x*(1-u)+this.m_vertices[c].x*u,this.m_vertices[l].y*(1-u)+this.m_vertices[c].y*u);let y=0;const V=b2PolygonShape.ComputeSubmergedArea_s_center.SetZero();let x,S=this.m_vertices[m],f=m;for(;f!==c;){f=(f+1)%this.m_count,x=f===c?p:this.m_vertices[f];const t=.5*((S.x-d.x)*(x.y-d.y)-(S.y-d.y)*(x.x-d.x));y+=t,V.x+=t*(d.x+S.x+x.x)/3,V.y+=t*(d.y+S.y+x.y)/3,S=x}return V.SelfMul(1/y),b2Transform.MulXV(i,V,s),y}Dump(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)}static ComputeCentroid(t,e,i){const s=i;s.SetZero();let o=0;const n=b2PolygonShape.ComputeCentroid_s_s.Copy(t[0]),r=1/3;for(let i=0;i<e;++i){const a=b2Vec2.SubVV(t[0],n,b2PolygonShape.ComputeCentroid_s_p1),h=b2Vec2.SubVV(t[i],n,b2PolygonShape.ComputeCentroid_s_p2),l=b2Vec2.SubVV(t[(i+1)%e],n,b2PolygonShape.ComputeCentroid_s_p3),_=b2Vec2.SubVV(h,a,b2PolygonShape.ComputeCentroid_s_e1),m=b2Vec2.SubVV(l,a,b2PolygonShape.ComputeCentroid_s_e2),c=.5*b2Vec2.CrossVV(_,m);o+=c,s.x+=c*r*(a.x+h.x+l.x),s.y+=c*r*(a.y+h.y+l.y)}return s.x=1/o*s.x+n.x,s.y=1/o*s.y+n.y,s}}b2PolygonShape.Set_s_r=new b2Vec2,b2PolygonShape.Set_s_v=new b2Vec2,b2PolygonShape.TestPoint_s_pLocal=new b2Vec2,b2PolygonShape.RayCast_s_p1=new b2Vec2,b2PolygonShape.RayCast_s_p2=new b2Vec2,b2PolygonShape.RayCast_s_d=new b2Vec2,b2PolygonShape.ComputeAABB_s_v=new b2Vec2,b2PolygonShape.ComputeMass_s_center=new b2Vec2,b2PolygonShape.ComputeMass_s_s=new b2Vec2,b2PolygonShape.ComputeMass_s_e1=new b2Vec2,b2PolygonShape.ComputeMass_s_e2=new b2Vec2,b2PolygonShape.Validate_s_e=new b2Vec2,b2PolygonShape.Validate_s_v=new b2Vec2,b2PolygonShape.ComputeSubmergedArea_s_normalL=new b2Vec2,b2PolygonShape.ComputeSubmergedArea_s_md=new b2MassData,b2PolygonShape.ComputeSubmergedArea_s_intoVec=new b2Vec2,b2PolygonShape.ComputeSubmergedArea_s_outoVec=new b2Vec2,b2PolygonShape.ComputeSubmergedArea_s_center=new b2Vec2,b2PolygonShape.ComputeCentroid_s_s=new b2Vec2,b2PolygonShape.ComputeCentroid_s_p1=new b2Vec2,b2PolygonShape.ComputeCentroid_s_p2=new b2Vec2,b2PolygonShape.ComputeCentroid_s_p3=new b2Vec2,b2PolygonShape.ComputeCentroid_s_e1=new b2Vec2,b2PolygonShape.ComputeCentroid_s_e2=new b2Vec2,t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;const Zt=new b2Transform,Yt=new b2Transform,Ut=new b2Vec2,Qt=new b2Vec2,Kt=new b2Vec2,Ht=new b2Vec2,$t=new b2Vec2;class b2TOIInput{constructor(){this.proxyA=new b2DistanceProxy,this.proxyB=new b2DistanceProxy,this.sweepA=new b2Sweep,this.sweepB=new b2Sweep,this.tMax=0}}var te,ee;t.b2TOIOutputState=void 0,(te=t.b2TOIOutputState||(t.b2TOIOutputState={}))[te.e_unknown=0]="e_unknown",te[te.e_failed=1]="e_failed",te[te.e_overlapped=2]="e_overlapped",te[te.e_touching=3]="e_touching",te[te.e_separated=4]="e_separated";class b2TOIOutput{constructor(){this.state=t.b2TOIOutputState.e_unknown,this.t=0}}t.b2SeparationFunctionType=void 0,(ee=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[ee.e_unknown=-1]="e_unknown",ee[ee.e_points=0]="e_points",ee[ee.e_faceA=1]="e_faceA",ee[ee.e_faceB=2]="e_faceB";class b2SeparationFunction{constructor(){this.m_sweepA=new b2Sweep,this.m_sweepB=new b2Sweep,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new b2Vec2,this.m_axis=new b2Vec2}Initialize(e,i,s,o,n,r){this.m_proxyA=i,this.m_proxyB=o;const a=e.count;this.m_sweepA.Copy(s),this.m_sweepB.Copy(n);const h=Zt,l=Yt;if(this.m_sweepA.GetTransform(h,r),this.m_sweepB.GetTransform(l,r),1===a){this.m_type=t.b2SeparationFunctionType.e_points;const i=this.m_proxyA.GetVertex(e.indexA[0]),s=this.m_proxyB.GetVertex(e.indexB[0]),o=b2Transform.MulXV(h,i,Ut),n=b2Transform.MulXV(l,s,Qt);b2Vec2.SubVV(n,o,this.m_axis);return this.m_axis.Normalize()}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;const i=this.m_proxyB.GetVertex(e.indexB[0]),s=this.m_proxyB.GetVertex(e.indexB[1]);b2Vec2.CrossVOne(b2Vec2.SubVV(s,i,b2Vec2.s_t0),this.m_axis).SelfNormalize();const o=b2Rot.MulRV(l.q,this.m_axis,Kt);b2Vec2.MidVV(i,s,this.m_localPoint);const n=b2Transform.MulXV(l,this.m_localPoint,Qt),r=this.m_proxyA.GetVertex(e.indexA[0]),a=b2Transform.MulXV(h,r,Ut);let _=b2Vec2.DotVV(b2Vec2.SubVV(a,n,b2Vec2.s_t0),o);return _<0&&(this.m_axis.SelfNeg(),_=-_),_}{this.m_type=t.b2SeparationFunctionType.e_faceA;const i=this.m_proxyA.GetVertex(e.indexA[0]),s=this.m_proxyA.GetVertex(e.indexA[1]);b2Vec2.CrossVOne(b2Vec2.SubVV(s,i,b2Vec2.s_t0),this.m_axis).SelfNormalize();const o=b2Rot.MulRV(h.q,this.m_axis,Kt);b2Vec2.MidVV(i,s,this.m_localPoint);const n=b2Transform.MulXV(h,this.m_localPoint,Ut),r=this.m_proxyB.GetVertex(e.indexB[0]),a=b2Transform.MulXV(l,r,Qt);let _=b2Vec2.DotVV(b2Vec2.SubVV(a,n,b2Vec2.s_t0),o);return _<0&&(this.m_axis.SelfNeg(),_=-_),_}}FindMinSeparation(e,i,s){const o=Zt,n=Yt;switch(this.m_sweepA.GetTransform(o,s),this.m_sweepB.GetTransform(n,s),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=b2Rot.MulTRV(o.q,this.m_axis,Ht),s=b2Rot.MulTRV(n.q,b2Vec2.NegV(this.m_axis,b2Vec2.s_t0),$t);e[0]=this.m_proxyA.GetSupport(t),i[0]=this.m_proxyB.GetSupport(s);const r=this.m_proxyA.GetVertex(e[0]),a=this.m_proxyB.GetVertex(i[0]),h=b2Transform.MulXV(o,r,Ut),l=b2Transform.MulXV(n,a,Qt);return b2Vec2.DotVV(b2Vec2.SubVV(l,h,b2Vec2.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=b2Rot.MulRV(o.q,this.m_axis,Kt),s=b2Transform.MulXV(o,this.m_localPoint,Ut),r=b2Rot.MulTRV(n.q,b2Vec2.NegV(t,b2Vec2.s_t0),$t);e[0]=-1,i[0]=this.m_proxyB.GetSupport(r);const a=this.m_proxyB.GetVertex(i[0]),h=b2Transform.MulXV(n,a,Qt);return b2Vec2.DotVV(b2Vec2.SubVV(h,s,b2Vec2.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=b2Rot.MulRV(n.q,this.m_axis,Kt),s=b2Transform.MulXV(n,this.m_localPoint,Qt),r=b2Rot.MulTRV(o.q,b2Vec2.NegV(t,b2Vec2.s_t0),Ht);i[0]=-1,e[0]=this.m_proxyA.GetSupport(r);const a=this.m_proxyA.GetVertex(e[0]),h=b2Transform.MulXV(o,a,Ut);return b2Vec2.DotVV(b2Vec2.SubVV(h,s,b2Vec2.s_t0),t)}default:return e[0]=-1,i[0]=-1,0}}Evaluate(e,i,s){const o=Zt,n=Yt;switch(this.m_sweepA.GetTransform(o,s),this.m_sweepB.GetTransform(n,s),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=this.m_proxyA.GetVertex(e),s=this.m_proxyB.GetVertex(i),r=b2Transform.MulXV(o,t,Ut),a=b2Transform.MulXV(n,s,Qt);return b2Vec2.DotVV(b2Vec2.SubVV(a,r,b2Vec2.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=b2Rot.MulRV(o.q,this.m_axis,Kt),e=b2Transform.MulXV(o,this.m_localPoint,Ut),s=this.m_proxyB.GetVertex(i),r=b2Transform.MulXV(n,s,Qt);return b2Vec2.DotVV(b2Vec2.SubVV(r,e,b2Vec2.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=b2Rot.MulRV(n.q,this.m_axis,Kt),i=b2Transform.MulXV(n,this.m_localPoint,Qt),s=this.m_proxyA.GetVertex(e),r=b2Transform.MulXV(o,s,Ut);return b2Vec2.DotVV(b2Vec2.SubVV(r,i,b2Vec2.s_t0),t)}default:return 0}}}const ie=new b2Timer,se=new b2SimplexCache,oe=new b2DistanceInput,ne=new b2DistanceOutput,re=new b2SeparationFunction,ae=[0],he=[0],le=new b2Sweep,_e=new b2Sweep;function b2TimeOfImpact(e,i){const s=ie.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=i.tMax;const o=i.proxyA,n=i.proxyB,r=b2Max(8,b2Max(o.m_count,n.m_count)),h=le.Copy(i.sweepA),l=_e.Copy(i.sweepB);h.Normalize(),l.Normalize();const _=i.tMax,m=o.m_radius+n.m_radius,c=b2Max(a,m-.015),b=.00125;let u=0;let d=0;const p=se;p.count=0;const y=oe;for(y.proxyA.Copy(i.proxyA),y.proxyB.Copy(i.proxyB),y.useRadii=!1;;){const i=Zt,s=Yt;h.GetTransform(i,u),l.GetTransform(s,u),y.transformA.Copy(i),y.transformB.Copy(s);const a=ne;if(b2Distance(a,p,y),a.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(a.distance<c+b){e.state=t.b2TOIOutputState.e_touching,e.t=u;break}const m=re;m.Initialize(p,o,h,n,l,u);let V=!1,x=_,f=0;for(;;){const i=ae,s=he;let o=m.FindMinSeparation(i,s,x);if(o>c+b){e.state=t.b2TOIOutputState.e_separated,e.t=_,V=!0;break}if(o>c-b){u=x;break}let n=m.Evaluate(i[0],s[0],u);if(n<c-b){e.state=t.b2TOIOutputState.e_failed,e.t=u,V=!0;break}if(n<=c+b){e.state=t.b2TOIOutputState.e_touching,e.t=u,V=!0;break}let a=0,h=u,l=x;for(;;){let e=0;e=1&a?h+(c-n)*(l-h)/(o-n):.5*(h+l),++a,++t.b2_toiRootIters;const r=m.Evaluate(i[0],s[0],e);if(S(r-c)<b){x=e;break}if(r>c?(h=e,n=r):(l=e,o=r),50===a)break}if(t.b2_toiMaxRootIters=b2Max(t.b2_toiMaxRootIters,a),++f,f===r)break}if(++d,++t.b2_toiIters,V)break;if(20===d){e.state=t.b2TOIOutputState.e_failed,e.t=u;break}}t.b2_toiMaxIters=b2Max(t.b2_toiMaxIters,d);const V=s.GetMilliseconds();t.b2_toiMaxTime=b2Max(t.b2_toiMaxTime,V),t.b2_toiTime+=V}var me,ce;t.b2JointType=void 0,(me=t.b2JointType||(t.b2JointType={}))[me.e_unknownJoint=0]="e_unknownJoint",me[me.e_revoluteJoint=1]="e_revoluteJoint",me[me.e_prismaticJoint=2]="e_prismaticJoint",me[me.e_distanceJoint=3]="e_distanceJoint",me[me.e_pulleyJoint=4]="e_pulleyJoint",me[me.e_mouseJoint=5]="e_mouseJoint",me[me.e_gearJoint=6]="e_gearJoint",me[me.e_wheelJoint=7]="e_wheelJoint",me[me.e_weldJoint=8]="e_weldJoint",me[me.e_frictionJoint=9]="e_frictionJoint",me[me.e_ropeJoint=10]="e_ropeJoint",me[me.e_motorJoint=11]="e_motorJoint",me[me.e_areaJoint=12]="e_areaJoint";class b2JointEdge{constructor(t){this._other=null,this.prev=null,this.next=null,this.joint=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class b2JointDef{constructor(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e}}class b2Joint{constructor(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new b2JointEdge(this),this.m_edgeB=new b2JointEdge(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=b2Maybe(e.collideConnected,!1),this.m_userData=b2Maybe(e.userData,null)}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsEnabled(){return this.m_bodyA.IsEnabled()&&this.m_bodyB.IsEnabled()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t("// Dump is not supported for this joint type.\n")}ShiftOrigin(t){}Draw(e){const i=this.m_bodyA.GetTransform(),s=this.m_bodyB.GetTransform(),o=i.p,n=s.p,r=this.GetAnchorA(b2Joint.Draw_s_p1),a=this.GetAnchorB(b2Joint.Draw_s_p2),h=b2Joint.Draw_s_color.SetRGB(.5,.8,.8);switch(this.m_type){case t.b2JointType.e_distanceJoint:e.DrawSegment(r,a,h);break;case t.b2JointType.e_pulleyJoint:{const t=this,i=t.GetGroundAnchorA(),s=t.GetGroundAnchorB();e.DrawSegment(i,r,h),e.DrawSegment(s,a,h),e.DrawSegment(i,s,h)}break;case t.b2JointType.e_mouseJoint:{const t=b2Joint.Draw_s_c;t.Set(0,1,0),e.DrawPoint(r,4,t),e.DrawPoint(a,4,t),t.Set(.8,.8,.8),e.DrawSegment(r,a,t)}break;default:e.DrawSegment(o,r,h),e.DrawSegment(r,a,h),e.DrawSegment(n,a,h)}}}b2Joint.Draw_s_p1=new b2Vec2,b2Joint.Draw_s_p2=new b2Vec2,b2Joint.Draw_s_color=new b2Color(.5,.8,.8),b2Joint.Draw_s_c=new b2Color;class b2DistanceJointDef extends b2JointDef{constructor(){super(t.b2JointType.e_distanceJoint),this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.length=1,this.minLength=0,this.maxLength=i,this.stiffness=0,this.damping=0}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(s,this.localAnchorB),this.length=b2Max(b2Vec2.DistanceVV(i,s),a),this.minLength=this.length,this.maxLength=this.length}}class b2DistanceJoint extends b2Joint{constructor(t){super(t),this.m_stiffness=0,this.m_damping=0,this.m_bias=0,this.m_length=0,this.m_minLength=0,this.m_maxLength=0,this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_gamma=0,this.m_impulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new b2Vec2,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_currentLength=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_softMass=0,this.m_mass=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_localAnchorA.Copy(b2Maybe(t.localAnchorA,b2Vec2.ZERO)),this.m_localAnchorB.Copy(b2Maybe(t.localAnchorB,b2Vec2.ZERO)),this.m_length=b2Max(b2Maybe(t.length,this.GetCurrentLength()),a),this.m_minLength=b2Max(b2Maybe(t.minLength,this.m_length),a),this.m_maxLength=b2Max(b2Maybe(t.maxLength,this.m_length),this.m_minLength),this.m_stiffness=b2Maybe(t.stiffness,0),this.m_damping=b2Maybe(t.damping,0)}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_u.x,e.y=t*(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){return this.m_impulse=0,this.m_length=b2Max(a,t),this.m_length}GetLength(){return this.m_length}SetMinLength(t){return this.m_lowerImpulse=0,this.m_minLength=b2Clamp(t,a,this.m_maxLength),this.m_minLength}SetMaxLength(t){return this.m_upperImpulse=0,this.m_maxLength=b2Max(t,this.m_minLength),this.m_maxLength}GetCurrentLength(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,new b2Vec2),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,new b2Vec2);return b2Vec2.DistanceVV(t,e)}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.minLength = %.15f;\n",this.m_minLength),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  jd.stiffness = %.15f;\n",this.m_stiffness),t("  jd.damping = %.15f;\n",this.m_damping),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(r);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),b2Rot.MulRV(_,this.m_lalcA,this.m_rA),b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),b2Rot.MulRV(m,this.m_lalcB,this.m_rB),this.m_u.x=n.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=n.y+this.m_rB.y-e.y-this.m_rA.y,this.m_currentLength=this.m_u.Length(),this.m_currentLength>a?this.m_u.SelfMul(1/this.m_currentLength):(this.m_u.SetZero(),this.m_mass=0,this.m_impulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0);const c=b2Vec2.CrossVV(this.m_rA,this.m_u),b=b2Vec2.CrossVV(this.m_rB,this.m_u);let u=this.m_invMassA+this.m_invIA*c*c+this.m_invMassB+this.m_invIB*b*b;if(this.m_mass=0!==u?1/u:0,this.m_stiffness>0&&this.m_minLength<this.m_maxLength){const e=this.m_currentLength-this.m_length,i=this.m_damping,s=this.m_stiffness,o=t.step.dt;this.m_gamma=o*(i+o*s),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=e*o*s*this.m_gamma,u+=this.m_gamma,this.m_softMass=0!==u?1/u:0}else this.m_gamma=0,this.m_bias=0,this.m_softMass=this.m_mass;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=b2Vec2.MulSV(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse,this.m_u,b2DistanceJoint.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,e),o-=this.m_invIA*b2Vec2.CrossVV(this.m_rA,e),h.SelfMulAdd(this.m_invMassB,e),l+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;if(this.m_minLength<this.m_maxLength){if(this.m_stiffness>0){const t=b2Vec2.AddVCrossSV(e,i,this.m_rA,b2DistanceJoint.SolveVelocityConstraints_s_vpA),n=b2Vec2.AddVCrossSV(s,o,this.m_rB,b2DistanceJoint.SolveVelocityConstraints_s_vpB),r=b2Vec2.DotVV(this.m_u,b2Vec2.SubVV(n,t,b2Vec2.s_t0)),a=-this.m_softMass*(r+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=a;const h=b2Vec2.MulSV(a,this.m_u,b2DistanceJoint.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,h),i-=this.m_invIA*b2Vec2.CrossVV(this.m_rA,h),s.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,h)}{const n=b2Max(0,this.m_currentLength-this.m_minLength)*t.step.inv_dt,r=b2Vec2.AddVCrossSV(e,i,this.m_rA,b2DistanceJoint.SolveVelocityConstraints_s_vpA),a=b2Vec2.AddVCrossSV(s,o,this.m_rB,b2DistanceJoint.SolveVelocityConstraints_s_vpB),h=b2Vec2.DotVV(this.m_u,b2Vec2.SubVV(a,r,b2Vec2.s_t0));let l=-this.m_mass*(h+n);const _=this.m_lowerImpulse;this.m_lowerImpulse=b2Max(0,this.m_lowerImpulse+l),l=this.m_lowerImpulse-_;const m=b2Vec2.MulSV(l,this.m_u,b2DistanceJoint.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,m),i-=this.m_invIA*b2Vec2.CrossVV(this.m_rA,m),s.SelfMulAdd(this.m_invMassB,m),o+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,m)}{const n=b2Max(0,this.m_maxLength-this.m_currentLength)*t.step.inv_dt,r=b2Vec2.AddVCrossSV(e,i,this.m_rA,b2DistanceJoint.SolveVelocityConstraints_s_vpA),a=b2Vec2.AddVCrossSV(s,o,this.m_rB,b2DistanceJoint.SolveVelocityConstraints_s_vpB),h=b2Vec2.DotVV(this.m_u,b2Vec2.SubVV(r,a,b2Vec2.s_t0));let l=-this.m_mass*(h+n);const _=this.m_upperImpulse;this.m_upperImpulse=b2Max(0,this.m_upperImpulse+l),l=this.m_upperImpulse-_;const m=b2Vec2.MulSV(-l,this.m_u,b2DistanceJoint.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,m),i-=this.m_invIA*b2Vec2.CrossVV(this.m_rA,m),s.SelfMulAdd(this.m_invMassB,m),o+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,m)}}else{const t=b2Vec2.AddVCrossSV(e,i,this.m_rA,b2DistanceJoint.SolveVelocityConstraints_s_vpA),n=b2Vec2.AddVCrossSV(s,o,this.m_rB,b2DistanceJoint.SolveVelocityConstraints_s_vpB),r=b2Vec2.DotVV(this.m_u,b2Vec2.SubVV(n,t,b2Vec2.s_t0)),a=-this.m_mass*r;this.m_impulse+=a;const h=b2Vec2.MulSV(a,this.m_u,b2DistanceJoint.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,h),i-=this.m_invIA*b2Vec2.CrossVV(this.m_rA,h),s.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,h)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(o),h=b2Rot.MulRV(n,this.m_lalcA,this.m_rA),l=b2Rot.MulRV(r,this.m_lalcB,this.m_rB),_=this.m_u;_.x=s.x+l.x-e.x-h.x,_.y=s.y+l.y-e.y-h.y;const m=this.m_u.Normalize();let c;if(this.m_minLength==this.m_maxLength)c=m-this.m_minLength;else if(m<this.m_minLength)c=m-this.m_minLength;else{if(!(this.m_maxLength<m))return!0;c=m-this.m_maxLength}const b=-this.m_mass*c,u=b2Vec2.MulSV(b,_,b2DistanceJoint.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*b2Vec2.CrossVV(h,u),s.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*b2Vec2.CrossVV(l,u),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,S(c)<a}Draw(t){const e=this.m_bodyA.GetTransform(),s=this.m_bodyB.GetTransform(),o=b2Transform.MulXV(e,this.m_localAnchorA,b2DistanceJoint.Draw_s_pA),n=b2Transform.MulXV(s,this.m_localAnchorB,b2DistanceJoint.Draw_s_pB),r=b2Vec2.SubVV(n,o,b2DistanceJoint.Draw_s_axis);r.Normalize();const h=b2DistanceJoint.Draw_s_c1,l=b2DistanceJoint.Draw_s_c2,_=b2DistanceJoint.Draw_s_c3,m=b2DistanceJoint.Draw_s_c4;t.DrawSegment(o,n,m);const c=b2Vec2.AddVMulSV(o,this.m_length,r,b2DistanceJoint.Draw_s_pRest);if(t.DrawPoint(c,8,h),this.m_minLength!=this.m_maxLength){if(this.m_minLength>a){const e=b2Vec2.AddVMulSV(o,this.m_minLength,r,b2DistanceJoint.Draw_s_pMin);t.DrawPoint(e,4,l)}if(this.m_maxLength<i){const e=b2Vec2.AddVMulSV(o,this.m_maxLength,r,b2DistanceJoint.Draw_s_pMax);t.DrawPoint(e,4,_)}}}}b2DistanceJoint.InitVelocityConstraints_s_P=new b2Vec2,b2DistanceJoint.SolveVelocityConstraints_s_vpA=new b2Vec2,b2DistanceJoint.SolveVelocityConstraints_s_vpB=new b2Vec2,b2DistanceJoint.SolveVelocityConstraints_s_P=new b2Vec2,b2DistanceJoint.SolvePositionConstraints_s_P=new b2Vec2,b2DistanceJoint.Draw_s_pA=new b2Vec2,b2DistanceJoint.Draw_s_pB=new b2Vec2,b2DistanceJoint.Draw_s_axis=new b2Vec2,b2DistanceJoint.Draw_s_c1=new b2Color(.7,.7,.7),b2DistanceJoint.Draw_s_c2=new b2Color(.3,.9,.3),b2DistanceJoint.Draw_s_c3=new b2Color(.9,.3,.3),b2DistanceJoint.Draw_s_c4=new b2Color(.4,.4,.4),b2DistanceJoint.Draw_s_pRest=new b2Vec2,b2DistanceJoint.Draw_s_pMin=new b2Vec2,b2DistanceJoint.Draw_s_pMax=new b2Vec2;class b2AreaJoint extends b2Joint{constructor(t){super(t),this.m_stiffness=0,this.m_damping=0,this.m_impulse=0,this.m_targetArea=0,this.m_delta=new b2Vec2,this.m_bodies=t.bodies,this.m_stiffness=b2Maybe(t.stiffness,0),this.m_damping=b2Maybe(t.damping,0),this.m_targetLengths=b2MakeNumberArray(t.bodies.length),this.m_normals=b2Vec2.MakeArray(t.bodies.length),this.m_joints=[],this.m_deltas=b2Vec2.MakeArray(t.bodies.length);const e=new b2DistanceJointDef;e.stiffness=this.m_stiffness,e.damping=this.m_damping,this.m_targetArea=0;for(let t=0;t<this.m_bodies.length;++t){const i=this.m_bodies[t],s=this.m_bodies[(t+1)%this.m_bodies.length],o=i.GetWorldCenter(),n=s.GetWorldCenter();this.m_targetLengths[t]=b2Vec2.DistanceVV(o,n),this.m_targetArea+=b2Vec2.CrossVV(o,n),e.Initialize(i,s,o,n),this.m_joints[t]=i.GetWorld().CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetStiffness(t){this.m_stiffness=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetStiffness(t)}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDamping(t)}GetDamping(){return this.m_damping}Dump(t){t("Area joint dumping is not supported.\n")}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],s=this.m_bodies[(e+1)%this.m_bodies.length],o=t.positions[i.m_islandIndex].c,n=t.positions[s.m_islandIndex].c,r=this.m_deltas[e];b2Vec2.SubVV(n,o,r)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.velocities[i.m_islandIndex].v,o=this.m_deltas[e];s.x+=i.m_invMass*o.y*.5*this.m_impulse,s.y+=i.m_invMass*-o.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let s=0;s<this.m_bodies.length;++s){const o=this.m_bodies[s],n=t.velocities[o.m_islandIndex].v,r=this.m_deltas[s];e+=r.LengthSquared()/o.GetMass(),i+=b2Vec2.CrossVV(n,r)}const s=-2*i/e;this.m_impulse+=s;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],o=t.velocities[i.m_islandIndex].v,n=this.m_deltas[e];o.x+=i.m_invMass*n.y*.5*s,o.y+=i.m_invMass*-n.x*.5*s}}SolvePositionConstraints(t){let e=0,i=0;for(let o=0;o<this.m_bodies.length;++o){const n=this.m_bodies[o],r=this.m_bodies[(o+1)%this.m_bodies.length],a=t.positions[n.m_islandIndex].c,h=t.positions[r.m_islandIndex].c,l=b2Vec2.SubVV(h,a,this.m_delta);let _=l.Length();_<s&&(_=1),this.m_normals[o].x=l.y/_,this.m_normals[o].y=-l.x/_,e+=_,i+=b2Vec2.CrossVV(a,h)}i*=.5;const o=.5*(this.m_targetArea-i)/e;let n=!0;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.positions[i.m_islandIndex].c,r=(e+1)%this.m_bodies.length,h=b2Vec2.AddVV(this.m_normals[e],this.m_normals[r],this.m_delta);h.SelfMul(o);const l=h.LengthSquared();l>b2Sq(_)&&h.SelfMul(_/A(l)),l>b2Sq(a)&&(n=!1),s.x+=h.x,s.y+=h.y}return n}}class b2Filter{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return(new b2Filter).Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this}}b2Filter.DEFAULT=new b2Filter;class b2FixtureDef{constructor(){this.userData=null,this.friction=.2,this.restitution=0,this.restitutionThreshold=1,this.density=0,this.isSensor=!1,this.filter=new b2Filter}}class b2FixtureProxy{constructor(t,e){this.aabb=new b2AABB,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}Reset(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}Touch(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}Synchronize(t,e){if(t===e)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,b2Vec2.ZERO);else{const i=b2FixtureProxy.Synchronize_s_aabb1,s=b2FixtureProxy.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(i,t,this.childIndex),this.fixture.m_shape.ComputeAABB(s,e,this.childIndex),this.aabb.Combine2(i,s);const o=b2FixtureProxy.Synchronize_s_displacement;o.Copy(s.GetCenter()).SelfSub(i.GetCenter()),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,o)}}}b2FixtureProxy.Synchronize_s_aabb1=new b2AABB,b2FixtureProxy.Synchronize_s_aabb2=new b2AABB,b2FixtureProxy.Synchronize_s_displacement=new b2Vec2;class b2Fixture{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_restitutionThreshold=1,this.m_proxies=[],this.m_filter=new b2Filter,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=b2Maybe(e.userData,null),this.m_friction=b2Maybe(e.friction,.2),this.m_restitution=b2Maybe(e.restitution,0),this.m_restitutionThreshold=b2Maybe(e.restitutionThreshold,0),this.m_filter.Copy(b2Maybe(e.filter,b2Filter.DEFAULT)),this.m_isSensor=b2Maybe(e.isSensor,!1),this.m_density=b2Maybe(e.density,0)}get m_proxyCount(){return this.m_proxies.length}Create(t,e,i){}Destroy(){}Reset(){}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),s=e.GetFixtureB();i!==this&&s!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new b2MassData){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetRestitutionThreshold(){return this.m_restitutionThreshold}SetRestitutionThreshold(t){this.m_restitutionThreshold=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.restitutionThreshold = %.15f;\n",this.m_restitutionThreshold),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)}CreateProxies(){if(0!==this.m_proxies.length)throw new Error;for(let t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new b2FixtureProxy(this,t)}DestroyProxies(){for(const t of this.m_proxies)t.Reset();this.m_proxies.length=0}TouchProxies(){for(const t of this.m_proxies)t.Touch()}Synchronize(t,e,i){this.SynchronizeProxies(e,i)}SynchronizeProxies(t,e){for(const i of this.m_proxies)i.Synchronize(t,e)}}t.b2BodyType=void 0,(ce=t.b2BodyType||(t.b2BodyType={}))[ce.b2_unknown=-1]="b2_unknown",ce[ce.b2_staticBody=0]="b2_staticBody",ce[ce.b2_kinematicBody=1]="b2_kinematicBody",ce[ce.b2_dynamicBody=2]="b2_dynamicBody";class b2Body{constructor(e,i){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_enabledFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new b2Transform,this.m_sweep=new b2Sweep,this.m_linearVelocity=new b2Vec2,this.m_angularVelocity=0,this.m_force=new b2Vec2,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_bulletFlag=b2Maybe(e.bullet,!1),this.m_fixedRotationFlag=b2Maybe(e.fixedRotation,!1),this.m_autoSleepFlag=b2Maybe(e.allowSleep,!0),b2Maybe(e.awake,!1)&&b2Maybe(e.type,t.b2BodyType.b2_staticBody)!==t.b2BodyType.b2_staticBody&&(this.m_awakeFlag=!0),this.m_enabledFlag=b2Maybe(e.enabled,!0),this.m_world=i,this.m_xf.p.Copy(b2Maybe(e.position,b2Vec2.ZERO)),this.m_xf.q.SetAngle(b2Maybe(e.angle,0)),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(b2Maybe(e.linearVelocity,b2Vec2.ZERO)),this.m_angularVelocity=b2Maybe(e.angularVelocity,0),this.m_linearDamping=b2Maybe(e.linearDamping,0),this.m_angularDamping=b2Maybe(e.angularDamping,0),this.m_gravityScale=b2Maybe(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=b2Maybe(e.type,t.b2BodyType.b2_staticBody),this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0}CreateFixture(t,e=0){return t instanceof b2Shape?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)}CreateFixtureDef(t){if(this.m_world.IsLocked())throw new Error;const e=new b2Fixture(this,t);return this.m_enabledFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newContacts=!0,e}CreateFixtureShapeDensity(t,e=0){const i=b2Body.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())throw new Error;let e=this.m_fixtureList,i=null;for(;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let s=this.m_contactList;for(;s;){const e=s.contact;s=s.next;const i=e.GetFixtureA(),o=e.GetFixtureB();t!==i&&t!==o||this.m_world.m_contactManager.Destroy(e)}this.m_enabledFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),b2Transform.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(let t=this.m_fixtureList;t;t=t.m_next)t.SynchronizeProxies(this.m_xf,this.m_xf);this.m_world.m_newContacts=!0}SetTransform(t,e){this.SetTransformXY(t.x,t.y,e)}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(b2Vec2.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(e,i,s=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(s&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x))}ApplyForceToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))}ApplyTorque(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))}ApplyLinearImpulse(e,i,s=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(s&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x)))}ApplyLinearImpulseToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))}ApplyAngularImpulse(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*b2Vec2.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*b2Vec2.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==t.b2BodyType.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!this.m_fixedRotationFlag&&(this.m_I=e.I-this.m_mass*b2Vec2.DotVV(e.center,e.center),this.m_invI=1/this.m_I);const i=b2Body.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e.center),b2Transform.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),b2Vec2.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,b2Vec2.SubVV(this.m_sweep.c,i,b2Vec2.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);const e=b2Body.ResetMassData_s_localCenter.SetZero();for(let t=this.m_fixtureList;t;t=t.m_next){if(0===t.m_density)continue;const i=t.GetMassData(b2Body.ResetMassData_s_massData);this.m_mass+=i.mass,e.x+=i.center.x*i.mass,e.y+=i.center.y*i.mass,this.m_I+=i.I}this.m_mass>0&&(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*b2Vec2.DotVV(e,e),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const i=b2Body.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e),b2Transform.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),b2Vec2.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,b2Vec2.SubVV(this.m_sweep.c,i,b2Vec2.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return b2Transform.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return b2Rot.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return b2Transform.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return b2Rot.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return b2Vec2.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,b2Vec2.SubVV(t,this.m_sweep.c,b2Vec2.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type===e)return;this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_awakeFlag=!1,this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let i=this.m_contactList;for(;i;){const t=i;i=i.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null;for(let t=this.m_fixtureList;t;t=t.m_next)t.TouchProxies()}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0))}IsAwake(){return this.m_awakeFlag}SetEnabled(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsEnabled())if(this.m_enabledFlag=t,t){for(let t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies();this.m_world.m_newContacts=!0}else{for(let t=this.m_fixtureList;t;t=t.m_next)t.DestroyProxies();let t=this.m_contactList;for(;t;){const e=t;t=t.next,this.m_world.m_contactManager.Destroy(e.contact)}this.m_contactList=null}}IsEnabled(){return this.m_enabledFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(e){const i=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");let s="";switch(this.m_type){case t.b2BodyType.b2_staticBody:s="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:s="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:s="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",s),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_enabledFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(let t=this.m_fixtureList;t;t=t.m_next)e("  {\n"),t.Dump(e,i),e("  }\n");e("}\n")}SynchronizeFixtures(){if(this.m_awakeFlag){const t=b2Body.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),b2Rot.MulRV(t.q,this.m_sweep.localCenter,t.p),b2Vec2.SubVV(this.m_sweep.c0,t.p,t.p);for(let e=this.m_fixtureList;e;e=e.m_next)e.SynchronizeProxies(t,this.m_xf)}else for(let t=this.m_fixtureList;t;t=t.m_next)t.SynchronizeProxies(this.m_xf,this.m_xf)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),b2Rot.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),b2Vec2.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),b2Rot.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),b2Vec2.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}}function b2MixFriction(t,e){return A(t*e)}function b2MixRestitution(t,e){return t>e?t:e}function b2MixRestitutionThreshold(t,e){return t<e?t:e}b2Body.CreateFixtureShapeDensity_s_def=new b2FixtureDef,b2Body.SetMassData_s_oldCenter=new b2Vec2,b2Body.ResetMassData_s_localCenter=new b2Vec2,b2Body.ResetMassData_s_oldCenter=new b2Vec2,b2Body.ResetMassData_s_massData=new b2MassData,b2Body.SynchronizeFixtures_s_xf1=new b2Transform;class b2ContactEdge{constructor(t){this._other=null,this.prev=null,this.next=null,this.contact=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class b2Contact{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new b2ContactEdge(this),this.m_nodeB=new b2ContactEdge(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new b2Manifold,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_restitutionThreshold=0,this.m_tangentSpeed=0,this.m_oldManifold=new b2Manifold}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),s=this.GetShapeA(),o=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),s.m_radius,i.GetTransform(),o.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=b2MixFriction(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=b2MixRestitution(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetRestitutionThreshold(t){this.m_restitutionThreshold=t}GetRestitutionThreshold(){return this.m_restitutionThreshold}ResetRestitutionThreshold(){this.m_restitutionThreshold=b2MixRestitutionThreshold(this.m_fixtureA.m_restitutionThreshold,this.m_fixtureB.m_restitutionThreshold)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,s){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=s,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=b2MixFriction(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=b2MixRestitution(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution),this.m_restitutionThreshold=b2MixRestitutionThreshold(this.m_fixtureA.m_restitutionThreshold,this.m_fixtureB.m_restitutionThreshold)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const s=this.m_touchingFlag,o=this.m_fixtureA.IsSensor(),n=this.m_fixtureB.IsSensor(),r=o||n,a=this.m_fixtureA.GetBody(),h=this.m_fixtureB.GetBody(),l=a.GetTransform(),_=h.GetTransform();if(r){const t=this.GetShapeA(),e=this.GetShapeB();i=b2TestOverlapShape(t,this.m_indexA,e,this.m_indexB,l,_),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,_),i=this.m_manifold.pointCount>0;for(let t=0;t<this.m_manifold.pointCount;++t){const e=this.m_manifold.points[t];e.normalImpulse=0,e.tangentImpulse=0;const i=e.id;for(let t=0;t<this.m_oldManifold.pointCount;++t){const s=this.m_oldManifold.points[t];if(s.id.key===i.key){e.normalImpulse=s.normalImpulse,e.tangentImpulse=s.tangentImpulse;break}}}i!==s&&(a.SetAwake(!0),h.SetAwake(!0))}this.m_touchingFlag=i,!s&&i&&t&&t.BeginContact(this),s&&!i&&t&&t.EndContact(this),!r&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=b2Contact.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=a;const s=b2Contact.ComputeTOI_s_output;return b2TimeOfImpact(s,i),s.t}}b2Contact.ComputeTOI_s_input=new b2TOIInput,b2Contact.ComputeTOI_s_output=new b2TOIOutput;class b2ChainAndCircleContact extends b2Contact{static Create(){return new b2ChainAndCircleContact}static Destroy(t){}Evaluate(t,e,i){const s=b2ChainAndCircleContact.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),b2CollideEdgeAndCircle(t,s,e,this.GetShapeB(),i)}}b2ChainAndCircleContact.Evaluate_s_edge=new b2EdgeShape;class b2ChainAndPolygonContact extends b2Contact{static Create(){return new b2ChainAndPolygonContact}static Destroy(t){}Evaluate(t,e,i){const s=b2ChainAndPolygonContact.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),b2CollideEdgeAndPolygon(t,s,e,this.GetShapeB(),i)}}b2ChainAndPolygonContact.Evaluate_s_edge=new b2EdgeShape;class b2CircleContact extends b2Contact{static Create(){return new b2CircleContact}static Destroy(t){}Evaluate(t,e,i){b2CollideCircles(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class b2PolygonContact extends b2Contact{static Create(){return new b2PolygonContact}static Destroy(t){}Evaluate(t,e,i){b2CollidePolygons(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class b2PolygonAndCircleContact extends b2Contact{static Create(){return new b2PolygonAndCircleContact}static Destroy(t){}Evaluate(t,e,i){b2CollidePolygonAndCircle(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class b2EdgeAndCircleContact extends b2Contact{static Create(){return new b2EdgeAndCircleContact}static Destroy(t){}Evaluate(t,e,i){b2CollideEdgeAndCircle(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class b2EdgeAndPolygonContact extends b2Contact{static Create(){return new b2EdgeAndPolygonContact}static Destroy(t){}Evaluate(t,e,i){b2CollideEdgeAndPolygon(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class b2ContactRegister{constructor(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class b2ContactFactory{constructor(){this.m_registers=[],this.InitializeRegisters()}AddType(t,e,i,s){const o=[];function poolCreateFcn(){return o.pop()||t()}function poolDestroyFcn(t){o.push(t)}this.m_registers[i][s].pool=o,this.m_registers[i][s].createFcn=poolCreateFcn,this.m_registers[i][s].destroyFcn=poolDestroyFcn,this.m_registers[i][s].primary=!0,i!==s&&(this.m_registers[s][i].pool=o,this.m_registers[s][i].createFcn=poolCreateFcn,this.m_registers[s][i].destroyFcn=poolDestroyFcn,this.m_registers[s][i].primary=!1)}InitializeRegisters(){for(let e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(let i=0;i<t.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[e][i]=new b2ContactRegister}this.AddType(b2CircleContact.Create,b2CircleContact.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(b2PolygonAndCircleContact.Create,b2PolygonAndCircleContact.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(b2PolygonContact.Create,b2PolygonContact.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(b2EdgeAndCircleContact.Create,b2EdgeAndCircleContact.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(b2EdgeAndPolygonContact.Create,b2EdgeAndPolygonContact.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(b2ChainAndCircleContact.Create,b2ChainAndCircleContact.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(b2ChainAndPolygonContact.Create,b2ChainAndPolygonContact.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)}Create(t,e,i,s){const o=t.GetType(),n=i.GetType(),r=this.m_registers[o][n];if(r.createFcn){const o=r.createFcn();return r.primary?o.Reset(t,e,i,s):o.Reset(i,s,t,e),o}return null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),s=this.m_registers[e][i];s.destroyFcn&&s.destroyFcn(t)}}class b2ContactFilter{ShouldCollide(e,i){const s=e.GetBody(),o=i.GetBody();if(o.GetType()===t.b2BodyType.b2_staticBody&&s.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!o.ShouldCollideConnected(s))return!1;const n=e.GetFilterData(),r=i.GetFilterData();if(n.groupIndex===r.groupIndex&&0!==n.groupIndex)return n.groupIndex>0;return 0!=(n.maskBits&r.categoryBits)&&0!=(n.categoryBits&r.maskBits)}}b2ContactFilter.b2_defaultFilter=new b2ContactFilter;class b2ContactImpulse{constructor(){this.normalImpulses=b2MakeNumberArray(2),this.tangentImpulses=b2MakeNumberArray(2),this.count=0}}class b2ContactListener{BeginContact(t){}EndContact(t){}PreSolve(t,e){}PostSolve(t,e){}}b2ContactListener.b2_defaultListener=new b2ContactListener;class b2QueryCallback{ReportFixture(t){return!0}}class b2RayCastCallback{ReportFixture(t,e,i,s){return s}}class b2ContactManager{constructor(){this.m_broadPhase=new b2BroadPhase,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=b2ContactFilter.b2_defaultFilter,this.m_contactListener=b2ContactListener.b2_defaultListener,this.m_contactFactory=new b2ContactFactory}AddPair(t,e){let i=t.fixture,s=e.fixture,o=t.childIndex,n=e.childIndex,r=i.GetBody(),a=s.GetBody();if(r===a)return;let h=a.GetContactList();for(;h;){if(h.other===r){const t=h.contact.GetFixtureA(),e=h.contact.GetFixtureB(),r=h.contact.GetChildIndexA(),a=h.contact.GetChildIndexB();if(t===i&&e===s&&r===o&&a===n)return;if(t===s&&e===i&&r===n&&a===o)return}h=h.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,s))return;const l=this.m_contactFactory.Create(i,o,s,n);null!==l&&(i=l.GetFixtureA(),s=l.GetFixtureB(),o=l.GetChildIndexA(),n=l.GetChildIndexB(),r=i.m_body,a=s.m_body,l.m_prev=null,l.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=l),this.m_contactList=l,l.m_nodeA.other=a,l.m_nodeA.prev=null,l.m_nodeA.next=r.m_contactList,null!==r.m_contactList&&(r.m_contactList.prev=l.m_nodeA),r.m_contactList=l.m_nodeA,l.m_nodeB.other=r,l.m_nodeB.prev=null,l.m_nodeB.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=l.m_nodeB),a.m_contactList=l.m_nodeB,++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs(((t,e)=>{this.AddPair(t,e)}))}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),s=e.GetBody(),o=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===s.m_contactList&&(s.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===o.m_contactList&&(o.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let e=this.m_contactList;for(;e;){const i=e.GetFixtureA(),s=e.GetFixtureB(),o=e.GetChildIndexA(),n=e.GetChildIndexB(),r=i.GetBody(),a=s.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,s)){const t=e;e=t.m_next,this.Destroy(t);continue}e.m_filterFlag=!1}const h=r.IsAwake()&&r.m_type!==t.b2BodyType.b2_staticBody,l=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody;if(!h&&!l){e=e.m_next;continue}const _=i.m_proxies[o].treeNode,m=s.m_proxies[n].treeNode;if(b2TestOverlapAABB(_.aabb,m.aabb))e.Update(this.m_contactListener),e=e.m_next;else{const t=e;e=t.m_next,this.Destroy(t)}}}}class b2Profile{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class b2TimeStep{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.warmStarting=t.warmStarting,this}}class b2Position{constructor(){this.c=new b2Vec2,this.a=0}static MakeArray(t){return b2MakeArray(t,(t=>new b2Position))}}class b2Velocity{constructor(){this.v=new b2Vec2,this.w=0}static MakeArray(t){return b2MakeArray(t,(t=>new b2Velocity))}}class b2SolverData{constructor(){this.step=new b2TimeStep}}t.g_blockSolve=!0;class b2VelocityConstraintPoint{constructor(){this.rA=new b2Vec2,this.rB=new b2Vec2,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return b2MakeArray(t,(t=>new b2VelocityConstraintPoint))}}class b2ContactVelocityConstraint{constructor(){this.points=b2VelocityConstraintPoint.MakeArray(2),this.normal=new b2Vec2,this.tangent=new b2Vec2,this.normalMass=new b2Mat22,this.K=new b2Mat22,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.threshold=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return b2MakeArray(t,(t=>new b2ContactVelocityConstraint))}}class b2ContactPositionConstraint{constructor(){this.localPoints=b2Vec2.MakeArray(2),this.localNormal=new b2Vec2,this.localPoint=new b2Vec2,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new b2Vec2,this.localCenterB=new b2Vec2,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return b2MakeArray(t,(t=>new b2ContactPositionConstraint))}}class b2ContactSolverDef{constructor(){this.step=new b2TimeStep,this.count=0}}class b2PositionSolverManifold{constructor(){this.normal=new b2Vec2,this.point=new b2Vec2,this.separation=0}Initialize(e,i,s,o){const n=b2PositionSolverManifold.Initialize_s_pointA,r=b2PositionSolverManifold.Initialize_s_pointB,a=b2PositionSolverManifold.Initialize_s_planePoint,h=b2PositionSolverManifold.Initialize_s_clipPoint;switch(e.type){case t.b2ManifoldType.e_circles:b2Transform.MulXV(i,e.localPoint,n),b2Transform.MulXV(s,e.localPoints[0],r),b2Vec2.SubVV(r,n,this.normal).SelfNormalize(),b2Vec2.MidVV(n,r,this.point),this.separation=b2Vec2.DotVV(b2Vec2.SubVV(r,n,b2Vec2.s_t0),this.normal)-e.radiusA-e.radiusB;break;case t.b2ManifoldType.e_faceA:b2Rot.MulRV(i.q,e.localNormal,this.normal),b2Transform.MulXV(i,e.localPoint,a),b2Transform.MulXV(s,e.localPoints[o],h),this.separation=b2Vec2.DotVV(b2Vec2.SubVV(h,a,b2Vec2.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(h);break;case t.b2ManifoldType.e_faceB:b2Rot.MulRV(s.q,e.localNormal,this.normal),b2Transform.MulXV(s,e.localPoint,a),b2Transform.MulXV(i,e.localPoints[o],h),this.separation=b2Vec2.DotVV(b2Vec2.SubVV(h,a,b2Vec2.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(h),this.normal.SelfNeg()}}}b2PositionSolverManifold.Initialize_s_pointA=new b2Vec2,b2PositionSolverManifold.Initialize_s_pointB=new b2Vec2,b2PositionSolverManifold.Initialize_s_planePoint=new b2Vec2,b2PositionSolverManifold.Initialize_s_clipPoint=new b2Vec2;class b2ContactSolver{constructor(){this.m_step=new b2TimeStep,this.m_positionConstraints=b2ContactPositionConstraint.MakeArray(1024),this.m_velocityConstraints=b2ContactVelocityConstraint.MakeArray(1024),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const t=b2Max(2*this.m_positionConstraints.length,this.m_count);for(;this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new b2ContactPositionConstraint}if(this.m_velocityConstraints.length<this.m_count){const t=b2Max(2*this.m_velocityConstraints.length,this.m_count);for(;this.m_velocityConstraints.length<t;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new b2ContactVelocityConstraint}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let t=0;t<this.m_count;++t){const e=this.m_contacts[t],i=e.m_fixtureA,s=e.m_fixtureB,o=i.GetShape(),n=s.GetShape(),r=o.m_radius,a=n.m_radius,h=i.GetBody(),l=s.GetBody(),_=e.GetManifold(),m=_.pointCount,c=this.m_velocityConstraints[t];c.friction=e.m_friction,c.restitution=e.m_restitution,c.threshold=e.m_restitutionThreshold,c.tangentSpeed=e.m_tangentSpeed,c.indexA=h.m_islandIndex,c.indexB=l.m_islandIndex,c.invMassA=h.m_invMass,c.invMassB=l.m_invMass,c.invIA=h.m_invI,c.invIB=l.m_invI,c.contactIndex=t,c.pointCount=m,c.K.SetZero(),c.normalMass.SetZero();const b=this.m_positionConstraints[t];b.indexA=h.m_islandIndex,b.indexB=l.m_islandIndex,b.invMassA=h.m_invMass,b.invMassB=l.m_invMass,b.localCenterA.Copy(h.m_sweep.localCenter),b.localCenterB.Copy(l.m_sweep.localCenter),b.invIA=h.m_invI,b.invIB=l.m_invI,b.localNormal.Copy(_.localNormal),b.localPoint.Copy(_.localPoint),b.pointCount=m,b.radiusA=r,b.radiusB=a,b.type=_.type;for(let t=0;t<m;++t){const e=_.points[t],i=c.points[t];this.m_step.warmStarting?(i.normalImpulse=this.m_step.dtRatio*e.normalImpulse,i.tangentImpulse=this.m_step.dtRatio*e.tangentImpulse):(i.normalImpulse=0,i.tangentImpulse=0),i.rA.SetZero(),i.rB.SetZero(),i.normalMass=0,i.tangentMass=0,i.velocityBias=0,b.localPoints[t].Copy(e.localPoint)}}return this}InitializeVelocityConstraints(){const e=b2ContactSolver.InitializeVelocityConstraints_s_xfA,i=b2ContactSolver.InitializeVelocityConstraints_s_xfB,s=b2ContactSolver.InitializeVelocityConstraints_s_worldManifold;for(let o=0;o<this.m_count;++o){const n=this.m_velocityConstraints[o],r=this.m_positionConstraints[o],a=r.radiusA,h=r.radiusB,l=this.m_contacts[n.contactIndex].GetManifold(),_=n.indexA,m=n.indexB,c=n.invMassA,b=n.invMassB,u=n.invIA,d=n.invIB,p=r.localCenterA,y=r.localCenterB,V=this.m_positions[_].c,x=this.m_positions[_].a,S=this.m_velocities[_].v,f=this.m_velocities[_].w,A=this.m_positions[m].c,C=this.m_positions[m].a,w=this.m_velocities[m].v,g=this.m_velocities[m].w;e.q.SetAngle(x),i.q.SetAngle(C),b2Vec2.SubVV(V,b2Rot.MulRV(e.q,p,b2Vec2.s_t0),e.p),b2Vec2.SubVV(A,b2Rot.MulRV(i.q,y,b2Vec2.s_t0),i.p),s.Initialize(l,e,a,i,h),n.normal.Copy(s.normal),b2Vec2.CrossVOne(n.normal,n.tangent);const B=n.pointCount;for(let t=0;t<B;++t){const e=n.points[t];b2Vec2.SubVV(s.points[t],V,e.rA),b2Vec2.SubVV(s.points[t],A,e.rB);const i=b2Vec2.CrossVV(e.rA,n.normal),o=b2Vec2.CrossVV(e.rB,n.normal),r=c+b+u*i*i+d*o*o;e.normalMass=r>0?1/r:0;const a=n.tangent,h=b2Vec2.CrossVV(e.rA,a),l=b2Vec2.CrossVV(e.rB,a),_=c+b+u*h*h+d*l*l;e.tangentMass=_>0?1/_:0,e.velocityBias=0;const m=b2Vec2.DotVV(n.normal,b2Vec2.SubVV(b2Vec2.AddVCrossSV(w,g,e.rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(S,f,e.rA,b2Vec2.s_t1),b2Vec2.s_t0));m<-n.threshold&&(e.velocityBias+=-n.restitution*m)}if(2===n.pointCount&&t.g_blockSolve){const t=n.points[0],e=n.points[1],i=b2Vec2.CrossVV(t.rA,n.normal),s=b2Vec2.CrossVV(t.rB,n.normal),o=b2Vec2.CrossVV(e.rA,n.normal),r=b2Vec2.CrossVV(e.rB,n.normal),a=c+b+u*i*i+d*s*s,h=c+b+u*o*o+d*r*r,l=c+b+u*i*o+d*s*r;a*a<1e3*(a*h-l*l)?(n.K.ex.Set(a,l),n.K.ey.Set(l,h),n.K.GetInverse(n.normalMass)):n.pointCount=1}}}WarmStart(){const t=b2ContactSolver.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],s=i.indexA,o=i.indexB,n=i.invMassA,r=i.invIA,a=i.invMassB,h=i.invIB,l=i.pointCount,_=this.m_velocities[s].v;let m=this.m_velocities[s].w;const c=this.m_velocities[o].v;let b=this.m_velocities[o].w;const u=i.normal,d=i.tangent;for(let e=0;e<l;++e){const s=i.points[e];b2Vec2.AddVV(b2Vec2.MulSV(s.normalImpulse,u,b2Vec2.s_t0),b2Vec2.MulSV(s.tangentImpulse,d,b2Vec2.s_t1),t),m-=r*b2Vec2.CrossVV(s.rA,t),_.SelfMulSub(n,t),b+=h*b2Vec2.CrossVV(s.rB,t),c.SelfMulAdd(a,t)}this.m_velocities[s].w=m,this.m_velocities[o].w=b}}SolveVelocityConstraints(){const e=b2ContactSolver.SolveVelocityConstraints_s_dv,i=b2ContactSolver.SolveVelocityConstraints_s_dv1,s=b2ContactSolver.SolveVelocityConstraints_s_dv2,o=b2ContactSolver.SolveVelocityConstraints_s_P,n=b2ContactSolver.SolveVelocityConstraints_s_a,r=b2ContactSolver.SolveVelocityConstraints_s_b,a=b2ContactSolver.SolveVelocityConstraints_s_x,h=b2ContactSolver.SolveVelocityConstraints_s_d,l=b2ContactSolver.SolveVelocityConstraints_s_P1,_=b2ContactSolver.SolveVelocityConstraints_s_P2,m=b2ContactSolver.SolveVelocityConstraints_s_P1P2;for(let c=0;c<this.m_count;++c){const b=this.m_velocityConstraints[c],u=b.indexA,d=b.indexB,p=b.invMassA,y=b.invIA,V=b.invMassB,x=b.invIB,S=b.pointCount,f=this.m_velocities[u].v;let A=this.m_velocities[u].w;const C=this.m_velocities[d].v;let w=this.m_velocities[d].w;const g=b.normal,B=b.tangent,v=b.friction;for(let t=0;t<S;++t){const i=b.points[t];b2Vec2.SubVV(b2Vec2.AddVCrossSV(C,w,i.rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(f,A,i.rA,b2Vec2.s_t1),e);const s=b2Vec2.DotVV(e,B)-b.tangentSpeed;let n=i.tangentMass*-s;const r=v*i.normalImpulse,a=b2Clamp(i.tangentImpulse+n,-r,r);n=a-i.tangentImpulse,i.tangentImpulse=a,b2Vec2.MulSV(n,B,o),f.SelfMulSub(p,o),A-=y*b2Vec2.CrossVV(i.rA,o),C.SelfMulAdd(V,o),w+=x*b2Vec2.CrossVV(i.rB,o)}if(1===b.pointCount||!1===t.g_blockSolve)for(let t=0;t<S;++t){const i=b.points[t];b2Vec2.SubVV(b2Vec2.AddVCrossSV(C,w,i.rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(f,A,i.rA,b2Vec2.s_t1),e);const s=b2Vec2.DotVV(e,g);let n=-i.normalMass*(s-i.velocityBias);const r=b2Max(i.normalImpulse+n,0);n=r-i.normalImpulse,i.normalImpulse=r,b2Vec2.MulSV(n,g,o),f.SelfMulSub(p,o),A-=y*b2Vec2.CrossVV(i.rA,o),C.SelfMulAdd(V,o),w+=x*b2Vec2.CrossVV(i.rB,o)}else{const t=b.points[0],e=b.points[1];n.Set(t.normalImpulse,e.normalImpulse),b2Vec2.SubVV(b2Vec2.AddVCrossSV(C,w,t.rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(f,A,t.rA,b2Vec2.s_t1),i),b2Vec2.SubVV(b2Vec2.AddVCrossSV(C,w,e.rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(f,A,e.rA,b2Vec2.s_t1),s);let o=b2Vec2.DotVV(i,g),c=b2Vec2.DotVV(s,g);for(r.x=o-t.velocityBias,r.y=c-e.velocityBias,r.SelfSub(b2Mat22.MulMV(b.K,n,b2Vec2.s_t0));;){if(b2Mat22.MulMV(b.normalMass,r,a).SelfNeg(),a.x>=0&&a.y>=0){b2Vec2.SubVV(a,n,h),b2Vec2.MulSV(h.x,g,l),b2Vec2.MulSV(h.y,g,_),b2Vec2.AddVV(l,_,m),f.SelfMulSub(p,m),A-=y*(b2Vec2.CrossVV(t.rA,l)+b2Vec2.CrossVV(e.rA,_)),C.SelfMulAdd(V,m),w+=x*(b2Vec2.CrossVV(t.rB,l)+b2Vec2.CrossVV(e.rB,_)),t.normalImpulse=a.x,e.normalImpulse=a.y;break}if(a.x=-t.normalMass*r.x,a.y=0,o=0,c=b.K.ex.y*a.x+r.y,a.x>=0&&c>=0){b2Vec2.SubVV(a,n,h),b2Vec2.MulSV(h.x,g,l),b2Vec2.MulSV(h.y,g,_),b2Vec2.AddVV(l,_,m),f.SelfMulSub(p,m),A-=y*(b2Vec2.CrossVV(t.rA,l)+b2Vec2.CrossVV(e.rA,_)),C.SelfMulAdd(V,m),w+=x*(b2Vec2.CrossVV(t.rB,l)+b2Vec2.CrossVV(e.rB,_)),t.normalImpulse=a.x,e.normalImpulse=a.y;break}if(a.x=0,a.y=-e.normalMass*r.y,o=b.K.ey.x*a.y+r.x,c=0,a.y>=0&&o>=0){b2Vec2.SubVV(a,n,h),b2Vec2.MulSV(h.x,g,l),b2Vec2.MulSV(h.y,g,_),b2Vec2.AddVV(l,_,m),f.SelfMulSub(p,m),A-=y*(b2Vec2.CrossVV(t.rA,l)+b2Vec2.CrossVV(e.rA,_)),C.SelfMulAdd(V,m),w+=x*(b2Vec2.CrossVV(t.rB,l)+b2Vec2.CrossVV(e.rB,_)),t.normalImpulse=a.x,e.normalImpulse=a.y;break}if(a.x=0,a.y=0,o=r.x,c=r.y,o>=0&&c>=0){b2Vec2.SubVV(a,n,h),b2Vec2.MulSV(h.x,g,l),b2Vec2.MulSV(h.y,g,_),b2Vec2.AddVV(l,_,m),f.SelfMulSub(p,m),A-=y*(b2Vec2.CrossVV(t.rA,l)+b2Vec2.CrossVV(e.rA,_)),C.SelfMulAdd(V,m),w+=x*(b2Vec2.CrossVV(t.rB,l)+b2Vec2.CrossVV(e.rB,_)),t.normalImpulse=a.x,e.normalImpulse=a.y;break}break}}this.m_velocities[u].w=A,this.m_velocities[d].w=w}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let t=0;t<e.pointCount;++t)i.points[t].normalImpulse=e.points[t].normalImpulse,i.points[t].tangentImpulse=e.points[t].tangentImpulse}}SolvePositionConstraints(){const t=b2ContactSolver.SolvePositionConstraints_s_xfA,e=b2ContactSolver.SolvePositionConstraints_s_xfB,i=b2ContactSolver.SolvePositionConstraints_s_psm,s=b2ContactSolver.SolvePositionConstraints_s_rA,o=b2ContactSolver.SolvePositionConstraints_s_rB,n=b2ContactSolver.SolvePositionConstraints_s_P;let r=0;for(let h=0;h<this.m_count;++h){const l=this.m_positionConstraints[h],_=l.indexA,m=l.indexB,c=l.localCenterA,b=l.invMassA,u=l.invIA,d=l.localCenterB,p=l.invMassB,y=l.invIB,V=l.pointCount,x=this.m_positions[_].c;let S=this.m_positions[_].a;const f=this.m_positions[m].c;let A=this.m_positions[m].a;for(let h=0;h<V;++h){t.q.SetAngle(S),e.q.SetAngle(A),b2Vec2.SubVV(x,b2Rot.MulRV(t.q,c,b2Vec2.s_t0),t.p),b2Vec2.SubVV(f,b2Rot.MulRV(e.q,d,b2Vec2.s_t0),e.p),i.Initialize(l,t,e,h);const _=i.normal,m=i.point,V=i.separation;b2Vec2.SubVV(m,x,s),b2Vec2.SubVV(m,f,o),r=b2Min(r,V);const C=b2Clamp(.2*(V+a),-.2,0),w=b2Vec2.CrossVV(s,_),g=b2Vec2.CrossVV(o,_),B=b+p+u*w*w+y*g*g,v=B>0?-C/B:0;b2Vec2.MulSV(v,_,n),x.SelfMulSub(b,n),S-=u*b2Vec2.CrossVV(s,n),f.SelfMulAdd(p,n),A+=y*b2Vec2.CrossVV(o,n)}this.m_positions[_].a=S,this.m_positions[m].a=A}return r>-.015}SolveTOIPositionConstraints(t,e){const i=b2ContactSolver.SolveTOIPositionConstraints_s_xfA,s=b2ContactSolver.SolveTOIPositionConstraints_s_xfB,o=b2ContactSolver.SolveTOIPositionConstraints_s_psm,n=b2ContactSolver.SolveTOIPositionConstraints_s_rA,r=b2ContactSolver.SolveTOIPositionConstraints_s_rB,h=b2ContactSolver.SolveTOIPositionConstraints_s_P;let l=0;for(let _=0;_<this.m_count;++_){const m=this.m_positionConstraints[_],c=m.indexA,b=m.indexB,u=m.localCenterA,d=m.localCenterB,p=m.pointCount;let y=0,V=0;c!==t&&c!==e||(y=m.invMassA,V=m.invIA);let x=0,S=0;b!==t&&b!==e||(x=m.invMassB,S=m.invIB);const f=this.m_positions[c].c;let A=this.m_positions[c].a;const C=this.m_positions[b].c;let w=this.m_positions[b].a;for(let t=0;t<p;++t){i.q.SetAngle(A),s.q.SetAngle(w),b2Vec2.SubVV(f,b2Rot.MulRV(i.q,u,b2Vec2.s_t0),i.p),b2Vec2.SubVV(C,b2Rot.MulRV(s.q,d,b2Vec2.s_t0),s.p),o.Initialize(m,i,s,t);const e=o.normal,_=o.point,c=o.separation;b2Vec2.SubVV(_,f,n),b2Vec2.SubVV(_,C,r),l=b2Min(l,c);const b=b2Clamp(.75*(c+a),-.2,0),p=b2Vec2.CrossVV(n,e),g=b2Vec2.CrossVV(r,e),B=y+x+V*p*p+S*g*g,v=B>0?-b/B:0;b2Vec2.MulSV(v,e,h),f.SelfMulSub(y,h),A-=V*b2Vec2.CrossVV(n,h),C.SelfMulAdd(x,h),w+=S*b2Vec2.CrossVV(r,h)}this.m_positions[c].a=A,this.m_positions[b].a=w}return l>=-.0075}}b2ContactSolver.InitializeVelocityConstraints_s_xfA=new b2Transform,b2ContactSolver.InitializeVelocityConstraints_s_xfB=new b2Transform,b2ContactSolver.InitializeVelocityConstraints_s_worldManifold=new b2WorldManifold,b2ContactSolver.WarmStart_s_P=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_dv=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_dv1=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_dv2=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_P=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_a=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_b=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_x=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_d=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_P1=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_P2=new b2Vec2,b2ContactSolver.SolveVelocityConstraints_s_P1P2=new b2Vec2,b2ContactSolver.SolvePositionConstraints_s_xfA=new b2Transform,b2ContactSolver.SolvePositionConstraints_s_xfB=new b2Transform,b2ContactSolver.SolvePositionConstraints_s_psm=new b2PositionSolverManifold,b2ContactSolver.SolvePositionConstraints_s_rA=new b2Vec2,b2ContactSolver.SolvePositionConstraints_s_rB=new b2Vec2,b2ContactSolver.SolvePositionConstraints_s_P=new b2Vec2,b2ContactSolver.SolveTOIPositionConstraints_s_xfA=new b2Transform,b2ContactSolver.SolveTOIPositionConstraints_s_xfB=new b2Transform,b2ContactSolver.SolveTOIPositionConstraints_s_psm=new b2PositionSolverManifold,b2ContactSolver.SolveTOIPositionConstraints_s_rA=new b2Vec2,b2ContactSolver.SolveTOIPositionConstraints_s_rB=new b2Vec2,b2ContactSolver.SolveTOIPositionConstraints_s_P=new b2Vec2;class b2FrictionJoint extends b2Joint{constructor(t){super(t),this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_linearImpulse=new b2Vec2,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new b2Mat22,this.m_angularMass=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_K=new b2Mat22,this.m_localAnchorA.Copy(b2Maybe(t.localAnchorA,b2Vec2.ZERO)),this.m_localAnchorB.Copy(b2Maybe(t.localAnchorB,b2Vec2.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=b2Maybe(t.maxForce,0),this.m_maxTorque=b2Maybe(t.maxTorque,0),this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const a=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(o);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=b2Rot.MulRV(a,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const _=b2Rot.MulRV(h,this.m_lalcB,this.m_rB),m=this.m_invMassA,c=this.m_invMassB,b=this.m_invIA,u=this.m_invIB,d=this.m_K;if(d.ex.x=m+c+b*l.y*l.y+u*_.y*_.y,d.ex.y=-b*l.x*l.y-u*_.x*_.y,d.ey.x=d.ex.y,d.ey.y=m+c+b*l.x*l.x+u*_.x*_.x,d.GetInverse(this.m_linearMass),this.m_angularMass=b+u,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;i.SelfMulSub(m,e),s-=b*(b2Vec2.CrossVV(this.m_rA,e)+this.m_angularImpulse),n.SelfMulAdd(c,e),r+=u*(b2Vec2.CrossVV(this.m_rB,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=r}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB,l=t.step.dt;{const t=o-i;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,n=l*this.m_maxTorque;this.m_angularImpulse=b2Clamp(this.m_angularImpulse+e,-n,n),e=this.m_angularImpulse-s,i-=a*e,o+=h*e}{const t=b2Vec2.SubVV(b2Vec2.AddVCrossSV(s,o,this.m_rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(e,i,this.m_rA,b2Vec2.s_t1),b2FrictionJoint.SolveVelocityConstraints_s_Cdot_v2),_=b2Mat22.MulMV(this.m_linearMass,t,b2FrictionJoint.SolveVelocityConstraints_s_impulseV).SelfNeg(),m=b2FrictionJoint.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(_);const c=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>c*c&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(c)),b2Vec2.SubVV(this.m_linearImpulse,m,_),e.SelfMulSub(n,_),i-=a*b2Vec2.CrossVV(this.m_rA,_),s.SelfMulAdd(r,_),o+=h*b2Vec2.CrossVV(this.m_rB,_)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}b2FrictionJoint.SolveVelocityConstraints_s_Cdot_v2=new b2Vec2,b2FrictionJoint.SolveVelocityConstraints_s_impulseV=new b2Vec2,b2FrictionJoint.SolveVelocityConstraints_s_oldImpulseV=new b2Vec2;class b2GearJoint extends b2Joint{constructor(e){let i,s;super(e),this.m_typeA=t.b2JointType.e_unknownJoint,this.m_typeB=t.b2JointType.e_unknownJoint,this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_localAnchorC=new b2Vec2,this.m_localAnchorD=new b2Vec2,this.m_localAxisC=new b2Vec2,this.m_localAxisD=new b2Vec2,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new b2Vec2,this.m_lcB=new b2Vec2,this.m_lcC=new b2Vec2,this.m_lcD=new b2Vec2,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new b2Vec2,this.m_JvBD=new b2Vec2,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_qC=new b2Rot,this.m_qD=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_lalcC=new b2Vec2,this.m_lalcD=new b2Vec2,this.m_joint1=e.joint1,this.m_joint2=e.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType(),this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const o=this.m_bodyA.m_xf,n=this.m_bodyA.m_sweep.a,r=this.m_bodyC.m_xf,a=this.m_bodyC.m_sweep.a;if(this.m_typeA===t.b2JointType.e_revoluteJoint){const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.SetZero(),i=n-a-this.m_referenceAngleA}else{const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.Copy(t.m_localXAxisA);const s=this.m_localAnchorC,n=b2Rot.MulTRV(r.q,b2Vec2.AddVV(b2Rot.MulRV(o.q,this.m_localAnchorA,b2Vec2.s_t0),b2Vec2.SubVV(o.p,r.p,b2Vec2.s_t1),b2Vec2.s_t0),b2Vec2.s_t0);i=b2Vec2.DotVV(b2Vec2.SubVV(n,s,b2Vec2.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const h=this.m_bodyB.m_xf,l=this.m_bodyB.m_sweep.a,_=this.m_bodyD.m_xf,m=this.m_bodyD.m_sweep.a;if(this.m_typeB===t.b2JointType.e_revoluteJoint){const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.SetZero(),s=l-m-this.m_referenceAngleB}else{const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.Copy(t.m_localXAxisA);const i=this.m_localAnchorD,o=b2Rot.MulTRV(_.q,b2Vec2.AddVV(b2Rot.MulRV(h.q,this.m_localAnchorB,b2Vec2.s_t0),b2Vec2.SubVV(h.p,_.p,b2Vec2.s_t1),b2Vec2.s_t0),b2Vec2.s_t0);s=b2Vec2.DotVV(b2Vec2.SubVV(o,i,b2Vec2.s_t0),this.m_localAxisD)}this.m_ratio=b2Maybe(e.ratio,1),this.m_constant=i+this.m_ratio*s,this.m_impulse=0}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const i=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v;let o=e.velocities[this.m_indexA].w;const n=e.positions[this.m_indexB].a,r=e.velocities[this.m_indexB].v;let a=e.velocities[this.m_indexB].w;const h=e.positions[this.m_indexC].a,l=e.velocities[this.m_indexC].v;let _=e.velocities[this.m_indexC].w;const m=e.positions[this.m_indexD].a,c=e.velocities[this.m_indexD].v;let b=e.velocities[this.m_indexD].w;const u=this.m_qA.SetAngle(i),d=this.m_qB.SetAngle(n),p=this.m_qC.SetAngle(h),y=this.m_qD.SetAngle(m);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const t=b2Rot.MulRV(p,this.m_localAxisC,b2GearJoint.InitVelocityConstraints_s_u);b2Vec2.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const e=b2Rot.MulRV(p,this.m_lalcC,b2GearJoint.InitVelocityConstraints_s_rC);b2Vec2.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const i=b2Rot.MulRV(u,this.m_lalcA,b2GearJoint.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(t),this.m_JwC=b2Vec2.CrossVV(e,t),this.m_JwA=b2Vec2.CrossVV(i,t),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const t=b2Rot.MulRV(y,this.m_localAxisD,b2GearJoint.InitVelocityConstraints_s_u);b2Vec2.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const e=b2Rot.MulRV(y,this.m_lalcD,b2GearJoint.InitVelocityConstraints_s_rD);b2Vec2.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const i=b2Rot.MulRV(d,this.m_lalcB,b2GearJoint.InitVelocityConstraints_s_rB);b2Vec2.MulSV(this.m_ratio,t,this.m_JvBD),this.m_JwD=this.m_ratio*b2Vec2.CrossVV(e,t),this.m_JwB=this.m_ratio*b2Vec2.CrossVV(i,t),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(s.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,r.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),a+=this.m_iB*this.m_impulse*this.m_JwB,l.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),_-=this.m_iC*this.m_impulse*this.m_JwC,c.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),b-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=a,e.velocities[this.m_indexC].w=_,e.velocities[this.m_indexD].w=b}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const n=t.velocities[this.m_indexC].v;let r=t.velocities[this.m_indexC].w;const a=t.velocities[this.m_indexD].v;let h=t.velocities[this.m_indexD].w,l=b2Vec2.DotVV(this.m_JvAC,b2Vec2.SubVV(e,n,b2Vec2.s_t0))+b2Vec2.DotVV(this.m_JvBD,b2Vec2.SubVV(s,a,b2Vec2.s_t0));l+=this.m_JwA*i-this.m_JwC*r+(this.m_JwB*o-this.m_JwD*h);const _=-this.m_mass*l;this.m_impulse+=_,e.SelfMulAdd(this.m_mA*_,this.m_JvAC),i+=this.m_iA*_*this.m_JwA,s.SelfMulAdd(this.m_mB*_,this.m_JvBD),o+=this.m_iB*_*this.m_JwB,n.SelfMulSub(this.m_mC*_,this.m_JvAC),r-=this.m_iC*_*this.m_JwC,a.SelfMulSub(this.m_mD*_,this.m_JvBD),h-=this.m_iD*_*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o,t.velocities[this.m_indexC].w=r,t.velocities[this.m_indexD].w=h}SolvePositionConstraints(e){const i=e.positions[this.m_indexA].c;let s=e.positions[this.m_indexA].a;const o=e.positions[this.m_indexB].c;let n=e.positions[this.m_indexB].a;const r=e.positions[this.m_indexC].c;let a=e.positions[this.m_indexC].a;const h=e.positions[this.m_indexD].c;let l=e.positions[this.m_indexD].a;const _=this.m_qA.SetAngle(s),m=this.m_qB.SetAngle(n),c=this.m_qC.SetAngle(a),b=this.m_qD.SetAngle(l);let u,d;const p=this.m_JvAC,y=this.m_JvBD;let V,x,S,f,A=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)p.SetZero(),V=1,S=1,A+=this.m_iA+this.m_iC,u=s-a-this.m_referenceAngleA;else{const t=b2Rot.MulRV(c,this.m_localAxisC,b2GearJoint.SolvePositionConstraints_s_u),e=b2Rot.MulRV(c,this.m_lalcC,b2GearJoint.SolvePositionConstraints_s_rC),s=b2Rot.MulRV(_,this.m_lalcA,b2GearJoint.SolvePositionConstraints_s_rA);p.Copy(t),S=b2Vec2.CrossVV(e,t),V=b2Vec2.CrossVV(s,t),A+=this.m_mC+this.m_mA+this.m_iC*S*S+this.m_iA*V*V;const o=this.m_lalcC,n=b2Rot.MulTRV(c,b2Vec2.AddVV(s,b2Vec2.SubVV(i,r,b2Vec2.s_t0),b2Vec2.s_t0),b2Vec2.s_t0);u=b2Vec2.DotVV(b2Vec2.SubVV(n,o,b2Vec2.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)y.SetZero(),x=this.m_ratio,f=this.m_ratio,A+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),d=n-l-this.m_referenceAngleB;else{const t=b2Rot.MulRV(b,this.m_localAxisD,b2GearJoint.SolvePositionConstraints_s_u),e=b2Rot.MulRV(b,this.m_lalcD,b2GearJoint.SolvePositionConstraints_s_rD),i=b2Rot.MulRV(m,this.m_lalcB,b2GearJoint.SolvePositionConstraints_s_rB);b2Vec2.MulSV(this.m_ratio,t,y),f=this.m_ratio*b2Vec2.CrossVV(e,t),x=this.m_ratio*b2Vec2.CrossVV(i,t),A+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*f*f+this.m_iB*x*x;const s=this.m_lalcD,n=b2Rot.MulTRV(b,b2Vec2.AddVV(i,b2Vec2.SubVV(o,h,b2Vec2.s_t0),b2Vec2.s_t0),b2Vec2.s_t0);d=b2Vec2.DotVV(b2Vec2.SubVV(n,s,b2Vec2.s_t0),this.m_localAxisD)}const C=u+this.m_ratio*d-this.m_constant;let w=0;return A>0&&(w=-C/A),i.SelfMulAdd(this.m_mA*w,p),s+=this.m_iA*w*V,o.SelfMulAdd(this.m_mB*w,y),n+=this.m_iB*w*x,r.SelfMulSub(this.m_mC*w,p),a-=this.m_iC*w*S,h.SelfMulSub(this.m_mD*w,y),l-=this.m_iD*w*f,e.positions[this.m_indexA].a=s,e.positions[this.m_indexB].a=n,e.positions[this.m_indexC].a=a,e.positions[this.m_indexD].a=l,!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return b2Vec2.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,s=this.m_joint1.m_index,o=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",s),t("  jd.joint2 = joints[%d];\n",o),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}b2GearJoint.InitVelocityConstraints_s_u=new b2Vec2,b2GearJoint.InitVelocityConstraints_s_rA=new b2Vec2,b2GearJoint.InitVelocityConstraints_s_rB=new b2Vec2,b2GearJoint.InitVelocityConstraints_s_rC=new b2Vec2,b2GearJoint.InitVelocityConstraints_s_rD=new b2Vec2,b2GearJoint.SolvePositionConstraints_s_u=new b2Vec2,b2GearJoint.SolvePositionConstraints_s_rA=new b2Vec2,b2GearJoint.SolvePositionConstraints_s_rB=new b2Vec2,b2GearJoint.SolvePositionConstraints_s_rC=new b2Vec2,b2GearJoint.SolvePositionConstraints_s_rD=new b2Vec2;class b2Island{constructor(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=b2Position.MakeArray(1024),this.m_velocities=b2Velocity.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,s){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=s,this.m_positions.length<t){const e=b2Max(2*this.m_positions.length,t);for(;this.m_positions.length<e;)this.m_positions[this.m_positions.length]=new b2Position}if(this.m_velocities.length<t){const e=b2Max(2*this.m_velocities.length,t);for(;this.m_velocities.length<e;)this.m_velocities[this.m_velocities.length]=new b2Velocity}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(e,s,o,n){const r=b2Island.s_timer.Reset(),a=s.dt;for(let e=0;e<this.m_bodyCount;++e){const i=this.m_bodies[e];this.m_positions[e].c.Copy(i.m_sweep.c);const s=i.m_sweep.a,n=this.m_velocities[e].v.Copy(i.m_linearVelocity);let r=i.m_angularVelocity;i.m_sweep.c0.Copy(i.m_sweep.c),i.m_sweep.a0=i.m_sweep.a,i.m_type===t.b2BodyType.b2_dynamicBody&&(n.x+=a*i.m_invMass*(i.m_gravityScale*i.m_mass*o.x+i.m_force.x),n.y+=a*i.m_invMass*(i.m_gravityScale*i.m_mass*o.y+i.m_force.y),r+=a*i.m_invI*i.m_torque,n.SelfMul(1/(1+a*i.m_linearDamping)),r*=1/(1+a*i.m_angularDamping)),this.m_positions[e].a=s,this.m_velocities[e].w=r}r.Reset();const h=b2Island.s_solverData;h.step.Copy(s),h.positions=this.m_positions,h.velocities=this.m_velocities;const l=b2Island.s_contactSolverDef;l.step.Copy(s),l.contacts=this.m_contacts,l.count=this.m_contactCount,l.positions=this.m_positions,l.velocities=this.m_velocities;const _=b2Island.s_contactSolver.Initialize(l);_.InitializeVelocityConstraints(),s.warmStarting&&_.WarmStart();for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].InitVelocityConstraints(h);e.solveInit=r.GetMilliseconds(),r.Reset();for(let t=0;t<s.velocityIterations;++t){for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].SolveVelocityConstraints(h);_.SolveVelocityConstraints()}_.StoreImpulses(),e.solveVelocity=r.GetMilliseconds();for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const s=this.m_velocities[t].v;let o=this.m_velocities[t].w;const n=b2Vec2.MulSV(a,s,b2Island.s_translation);if(b2Vec2.DotVV(n,n)>4){const t=2/n.Length();s.SelfMul(t)}const r=a*o;if(r*r>b){o*=c/S(r)}e.x+=a*s.x,e.y+=a*s.y,i+=a*o,this.m_positions[t].a=i,this.m_velocities[t].w=o}r.Reset();let m=!1;for(let t=0;t<s.positionIterations;++t){const t=_.SolvePositionConstraints();let e=!0;for(let t=0;t<this.m_jointCount;++t){const i=this.m_joints[t].SolvePositionConstraints(h);e=e&&i}if(t&&e){m=!0;break}}for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];e.m_sweep.c.Copy(this.m_positions[t].c),e.m_sweep.a=this.m_positions[t].a,e.m_linearVelocity.Copy(this.m_velocities[t].v),e.m_angularVelocity=this.m_velocities[t].w,e.SynchronizeTransform()}if(e.solvePosition=r.GetMilliseconds(),this.Report(_.m_velocityConstraints),n){let e=i;const s=1e-4,o=.0012184696791469947;for(let i=0;i<this.m_bodyCount;++i){const n=this.m_bodies[i];n.GetType()!==t.b2BodyType.b2_staticBody&&(!n.m_autoSleepFlag||n.m_angularVelocity*n.m_angularVelocity>o||b2Vec2.DotVV(n.m_linearVelocity,n.m_linearVelocity)>s?(n.m_sleepTime=0,e=0):(n.m_sleepTime+=a,e=b2Min(e,n.m_sleepTime)))}if(e>=.5&&m)for(let t=0;t<this.m_bodyCount;++t){this.m_bodies[t].SetAwake(!1)}}}SolveTOI(t,e,i){for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c),this.m_positions[t].a=e.m_sweep.a,this.m_velocities[t].v.Copy(e.m_linearVelocity),this.m_velocities[t].w=e.m_angularVelocity}const s=b2Island.s_contactSolverDef;s.contacts=this.m_contacts,s.count=this.m_contactCount,s.step.Copy(t),s.positions=this.m_positions,s.velocities=this.m_velocities;const o=b2Island.s_contactSolver.Initialize(s);for(let s=0;s<t.positionIterations;++s){if(o.SolveTOIPositionConstraints(e,i))break}this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,o.InitializeVelocityConstraints();for(let e=0;e<t.velocityIterations;++e)o.SolveVelocityConstraints();const n=t.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const s=this.m_velocities[t].v;let o=this.m_velocities[t].w;const r=b2Vec2.MulSV(n,s,b2Island.s_translation);if(b2Vec2.DotVV(r,r)>4){const t=2/r.Length();s.SelfMul(t)}const a=n*o;if(a*a>b){o*=c/S(a)}e.SelfMulAdd(n,s),i+=n*o,this.m_positions[t].a=i,this.m_velocities[t].w=o;const h=this.m_bodies[t];h.m_sweep.c.Copy(e),h.m_sweep.a=i,h.m_linearVelocity.Copy(s),h.m_angularVelocity=o,h.SynchronizeTransform()}this.Report(o.m_velocityConstraints)}Report(t){if(null!==this.m_listener)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const s=t[e],o=b2Island.s_impulse;o.count=s.pointCount;for(let t=0;t<s.pointCount;++t)o.normalImpulses[t]=s.points[t].normalImpulse,o.tangentImpulses[t]=s.points[t].tangentImpulse;this.m_listener.PostSolve(i,o)}}}b2Island.s_timer=new b2Timer,b2Island.s_solverData=new b2SolverData,b2Island.s_contactSolverDef=new b2ContactSolverDef,b2Island.s_contactSolver=new b2ContactSolver,b2Island.s_translation=new b2Vec2,b2Island.s_impulse=new b2ContactImpulse;class b2MotorJoint extends b2Joint{constructor(t){super(t),this.m_linearOffset=new b2Vec2,this.m_angularOffset=0,this.m_linearImpulse=new b2Vec2,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_linearError=new b2Vec2,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new b2Mat22,this.m_angularMass=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_K=new b2Mat22,this.m_linearOffset.Copy(b2Maybe(t.linearOffset,b2Vec2.ZERO)),this.m_angularOffset=b2Maybe(t.angularOffset,0),this.m_linearImpulse.SetZero(),this.m_maxForce=b2Maybe(t.maxForce,0),this.m_maxTorque=b2Maybe(t.maxTorque,0),this.m_correctionFactor=b2Maybe(t.correctionFactor,.3)}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return b2Vec2.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){b2Vec2.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r),m=b2Rot.MulRV(l,b2Vec2.SubVV(this.m_linearOffset,this.m_localCenterA,b2Vec2.s_t0),this.m_rA),c=b2Rot.MulRV(_,b2Vec2.NegV(this.m_localCenterB,b2Vec2.s_t0),this.m_rB),b=this.m_invMassA,u=this.m_invMassB,d=this.m_invIA,p=this.m_invIB,y=this.m_K;if(y.ex.x=b+u+d*m.y*m.y+p*c.y*c.y,y.ex.y=-d*m.x*m.y-p*c.x*c.y,y.ey.x=y.ex.y,y.ey.y=b+u+d*m.x*m.x+p*c.x*c.x,y.GetInverse(this.m_linearMass),this.m_angularMass=d+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),b2Vec2.SubVV(b2Vec2.AddVV(n,c,b2Vec2.s_t0),b2Vec2.AddVV(e,m,b2Vec2.s_t1),this.m_linearError),this.m_angularError=r-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;s.SelfMulSub(b,e),o-=d*(b2Vec2.CrossVV(m,e)+this.m_angularImpulse),a.SelfMulAdd(u,e),h+=p*(b2Vec2.CrossVV(c,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB,l=t.step.dt,_=t.step.inv_dt;{const t=o-i+_*this.m_correctionFactor*this.m_angularError;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,n=l*this.m_maxTorque;this.m_angularImpulse=b2Clamp(this.m_angularImpulse+e,-n,n),e=this.m_angularImpulse-s,i-=a*e,o+=h*e}{const t=this.m_rA,m=this.m_rB,c=b2Vec2.AddVV(b2Vec2.SubVV(b2Vec2.AddVV(s,b2Vec2.CrossSV(o,m,b2Vec2.s_t0),b2Vec2.s_t0),b2Vec2.AddVV(e,b2Vec2.CrossSV(i,t,b2Vec2.s_t1),b2Vec2.s_t1),b2Vec2.s_t2),b2Vec2.MulSV(_*this.m_correctionFactor,this.m_linearError,b2Vec2.s_t3),b2MotorJoint.SolveVelocityConstraints_s_Cdot_v2),b=b2Mat22.MulMV(this.m_linearMass,c,b2MotorJoint.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),u=b2MotorJoint.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(b);const d=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>d*d&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(d)),b2Vec2.SubVV(this.m_linearImpulse,u,b),e.SelfMulSub(n,b),i-=a*b2Vec2.CrossVV(t,b),s.SelfMulAdd(r,b),o+=h*b2Vec2.CrossVV(m,b)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}b2MotorJoint.SolveVelocityConstraints_s_Cdot_v2=new b2Vec2,b2MotorJoint.SolveVelocityConstraints_s_impulse_v2=new b2Vec2,b2MotorJoint.SolveVelocityConstraints_s_oldImpulse_v2=new b2Vec2;class b2MouseJoint extends b2Joint{constructor(t){super(t),this.m_localAnchorB=new b2Vec2,this.m_targetA=new b2Vec2,this.m_stiffness=0,this.m_damping=0,this.m_beta=0,this.m_impulse=new b2Vec2,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new b2Mat22,this.m_C=new b2Vec2,this.m_qB=new b2Rot,this.m_lalcB=new b2Vec2,this.m_K=new b2Mat22,this.m_targetA.Copy(b2Maybe(t.target,b2Vec2.ZERO)),b2Transform.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=b2Maybe(t.maxForce,0),this.m_impulse.SetZero(),this.m_stiffness=b2Maybe(t.stiffness,0),this.m_damping=b2Maybe(t.damping,0),this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const r=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),h=2*n*this.m_stiffness,l=2*a*this.m_damping*h,_=a*(h*h),m=t.step.dt;this.m_gamma=m*(l+m*_),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=m*_*this.m_gamma,b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),b2Rot.MulRV(r,this.m_lalcB,this.m_rB);const c=this.m_K;c.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,c.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,c.ey.x=c.ex.y,c.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,c.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),o*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),s.x+=this.m_invMassB*this.m_impulse.x,s.y+=this.m_invMassB*this.m_impulse.y,o+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const s=b2Vec2.AddVCrossSV(e,i,this.m_rB,b2MouseJoint.SolveVelocityConstraints_s_Cdot),o=b2Mat22.MulMV(this.m_mass,b2Vec2.AddVV(s,b2Vec2.AddVV(this.m_C,b2Vec2.MulSV(this.m_gamma,this.m_impulse,b2Vec2.s_t0),b2Vec2.s_t0),b2Vec2.s_t0).SelfNeg(),b2MouseJoint.SolveVelocityConstraints_s_impulse),n=b2MouseJoint.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);const r=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>r*r&&this.m_impulse.SelfMul(r/this.m_impulse.Length()),b2Vec2.SubVV(this.m_impulse,n,o),e.SelfMulAdd(this.m_invMassB,o),i+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return b2Vec2.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t("Mouse joint dumping is not supported.\n")}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}b2MouseJoint.SolveVelocityConstraints_s_Cdot=new b2Vec2,b2MouseJoint.SolveVelocityConstraints_s_impulse=new b2Vec2,b2MouseJoint.SolveVelocityConstraints_s_oldImpulse=new b2Vec2;class b2PrismaticJoint extends b2Joint{constructor(t){super(t),this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_localXAxisA=new b2Vec2,this.m_localYAxisA=new b2Vec2,this.m_referenceAngle=0,this.m_impulse=new b2Vec2(0,0),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new b2Vec2(0,0),this.m_perp=new b2Vec2(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new b2Mat22,this.m_K3=new b2Mat33,this.m_K2=new b2Mat22,this.m_translation=0,this.m_axialMass=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localAnchorA.Copy(b2Maybe(t.localAnchorA,b2Vec2.ZERO)),this.m_localAnchorB.Copy(b2Maybe(t.localAnchorB,b2Vec2.ZERO)),this.m_localXAxisA.Copy(b2Maybe(t.localAxisA,new b2Vec2(1,0))).SelfNormalize(),b2Vec2.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=b2Maybe(t.referenceAngle,0),this.m_lowerTranslation=b2Maybe(t.lowerTranslation,0),this.m_upperTranslation=b2Maybe(t.upperTranslation,0),this.m_maxMotorForce=b2Maybe(t.maxMotorForce,0),this.m_motorSpeed=b2Maybe(t.motorSpeed,0),this.m_enableLimit=b2Maybe(t.enableLimit,!1),this.m_enableMotor=b2Maybe(t.enableMotor,!1)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const m=b2Rot.MulRV(l,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const c=b2Rot.MulRV(_,this.m_lalcB,this.m_rB),b=b2Vec2.AddVV(b2Vec2.SubVV(n,e,b2Vec2.s_t0),b2Vec2.SubVV(c,m,b2Vec2.s_t1),b2PrismaticJoint.InitVelocityConstraints_s_d),u=this.m_invMassA,d=this.m_invMassB,p=this.m_invIA,y=this.m_invIB;if(b2Rot.MulRV(l,this.m_localXAxisA,this.m_axis),this.m_a1=b2Vec2.CrossVV(b2Vec2.AddVV(b,m,b2Vec2.s_t0),this.m_axis),this.m_a2=b2Vec2.CrossVV(c,this.m_axis),this.m_axialMass=u+d+p*this.m_a1*this.m_a1+y*this.m_a2*this.m_a2,this.m_axialMass>0&&(this.m_axialMass=1/this.m_axialMass),b2Rot.MulRV(l,this.m_localYAxisA,this.m_perp),this.m_s1=b2Vec2.CrossVV(b2Vec2.AddVV(b,m,b2Vec2.s_t0),this.m_perp),this.m_s2=b2Vec2.CrossVV(c,this.m_perp),this.m_K.ex.x=u+d+p*this.m_s1*this.m_s1+y*this.m_s2*this.m_s2,this.m_K.ex.y=p*this.m_s1+y*this.m_s2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=p+y,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_enableLimit?this.m_translation=b2Vec2.DotVV(this.m_axis,b):(this.m_lowerImpulse=0,this.m_upperImpulse=0),this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse,i=b2Vec2.AddVV(b2Vec2.MulSV(this.m_impulse.x,this.m_perp,b2Vec2.s_t0),b2Vec2.MulSV(e,this.m_axis,b2Vec2.s_t1),b2PrismaticJoint.InitVelocityConstraints_s_P),n=this.m_impulse.x*this.m_s1+this.m_impulse.y+e*this.m_a1,r=this.m_impulse.x*this.m_s2+this.m_impulse.y+e*this.m_a2;s.SelfMulSub(u,i),o-=p*n,a.SelfMulAdd(d,i),h+=y*r}else this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB;if(this.m_enableMotor){const l=b2Vec2.DotVV(this.m_axis,b2Vec2.SubVV(s,e,b2Vec2.s_t0))+this.m_a2*o-this.m_a1*i;let _=this.m_axialMass*(this.m_motorSpeed-l);const m=this.m_motorImpulse,c=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=b2Clamp(this.m_motorImpulse+_,-c,c),_=this.m_motorImpulse-m;const b=b2Vec2.MulSV(_,this.m_axis,b2PrismaticJoint.SolveVelocityConstraints_s_P),u=_*this.m_a1,d=_*this.m_a2;e.SelfMulSub(n,b),i-=a*u,s.SelfMulAdd(r,b),o+=h*d}if(this.m_enableLimit){{const l=this.m_translation-this.m_lowerTranslation,_=b2Vec2.DotVV(this.m_axis,b2Vec2.SubVV(s,e,b2Vec2.s_t0))+this.m_a2*o-this.m_a1*i;let m=-this.m_axialMass*(_+b2Max(l,0)*t.step.inv_dt);const c=this.m_lowerImpulse;this.m_lowerImpulse=b2Max(this.m_lowerImpulse+m,0),m=this.m_lowerImpulse-c;const b=b2Vec2.MulSV(m,this.m_axis,b2PrismaticJoint.SolveVelocityConstraints_s_P),u=m*this.m_a1,d=m*this.m_a2;e.SelfMulSub(n,b),i-=a*u,s.SelfMulAdd(r,b),o+=h*d}{const l=this.m_upperTranslation-this.m_translation,_=b2Vec2.DotVV(this.m_axis,b2Vec2.SubVV(e,s,b2Vec2.s_t0))+this.m_a1*i-this.m_a2*o;let m=-this.m_axialMass*(_+b2Max(l,0)*t.step.inv_dt);const c=this.m_upperImpulse;this.m_upperImpulse=b2Max(this.m_upperImpulse+m,0),m=this.m_upperImpulse-c;const b=b2Vec2.MulSV(m,this.m_axis,b2PrismaticJoint.SolveVelocityConstraints_s_P),u=m*this.m_a1,d=m*this.m_a2;e.SelfMulAdd(n,b),i+=a*u,s.SelfMulSub(r,b),o-=h*d}}{const t=b2Vec2.DotVV(this.m_perp,b2Vec2.SubVV(s,e,b2Vec2.s_t0))+this.m_s2*o-this.m_s1*i,l=o-i,_=this.m_K.Solve(-t,-l,b2PrismaticJoint.SolveVelocityConstraints_s_df);this.m_impulse.SelfAdd(_);const m=b2Vec2.MulSV(_.x,this.m_perp,b2PrismaticJoint.SolveVelocityConstraints_s_P),c=_.x*this.m_s1+_.y,b=_.x*this.m_s2+_.y;e.SelfMulSub(n,m),i-=a*c,s.SelfMulAdd(r,m),o+=h*b}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(o),l=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,c=this.m_invIB,b=b2Rot.MulRV(n,this.m_lalcA,this.m_rA),u=b2Rot.MulRV(r,this.m_lalcB,this.m_rB),d=b2Vec2.SubVV(b2Vec2.AddVV(s,u,b2Vec2.s_t0),b2Vec2.AddVV(e,b,b2Vec2.s_t1),b2PrismaticJoint.SolvePositionConstraints_s_d),p=b2Rot.MulRV(n,this.m_localXAxisA,this.m_axis),y=b2Vec2.CrossVV(b2Vec2.AddVV(d,b,b2Vec2.s_t0),p),V=b2Vec2.CrossVV(u,p),x=b2Rot.MulRV(n,this.m_localYAxisA,this.m_perp),f=b2Vec2.CrossVV(b2Vec2.AddVV(d,b,b2Vec2.s_t0),x),A=b2Vec2.CrossVV(u,x);let C=b2PrismaticJoint.SolvePositionConstraints_s_impulse;const w=b2Vec2.DotVV(x,d),g=o-i-this.m_referenceAngle;let B=S(w);const v=S(g);let M=!1,I=0;if(this.m_enableLimit){const t=b2Vec2.DotVV(p,d);S(this.m_upperTranslation-this.m_lowerTranslation)<.01?(I=t,B=b2Max(B,S(t)),M=!0):t<=this.m_lowerTranslation?(I=b2Min(t-this.m_lowerTranslation,0),B=b2Max(B,this.m_lowerTranslation-t),M=!0):t>=this.m_upperTranslation&&(I=b2Max(t-this.m_upperTranslation,0),B=b2Max(B,t-this.m_upperTranslation),M=!0)}if(M){const t=l+_+m*f*f+c*A*A,e=m*f+c*A,i=m*f*y+c*A*V;let s=m+c;0===s&&(s=1);const o=m*y+c*V,n=l+_+m*y*y+c*V*V,r=this.m_K3;r.ex.SetXYZ(t,e,i),r.ey.SetXYZ(e,s,o),r.ez.SetXYZ(i,o,n),C=r.Solve33(-w,-g,-I,C)}else{const t=l+_+m*f*f+c*A*A,e=m*f+c*A;let i=m+c;0===i&&(i=1);const s=this.m_K2;s.ex.Set(t,e),s.ey.Set(e,i);const o=s.Solve(-w,-g,b2PrismaticJoint.SolvePositionConstraints_s_impulse1);C.x=o.x,C.y=o.y,C.z=0}const P=b2Vec2.AddVV(b2Vec2.MulSV(C.x,x,b2Vec2.s_t0),b2Vec2.MulSV(C.z,p,b2Vec2.s_t1),b2PrismaticJoint.SolvePositionConstraints_s_P),D=C.x*f+C.y+C.z*y,T=C.x*A+C.y+C.z*V;return e.SelfMulSub(l,P),i-=m*D,s.SelfMulAdd(_,P),o+=c*T,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,B<=a&&v<=h}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_axis.x),e.y=t*(this.m_impulse.y*this.m_perp.y+(this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,b2PrismaticJoint.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,b2PrismaticJoint.GetJointTranslation_s_pB),i=b2Vec2.SubVV(e,t,b2PrismaticJoint.GetJointTranslation_s_d),s=this.m_bodyA.GetWorldVector(this.m_localXAxisA,b2PrismaticJoint.GetJointTranslation_s_axis);return b2Vec2.DotVV(i,s)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;b2Vec2.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=b2Rot.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const s=b2Rot.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),o=b2Vec2.AddVV(t.m_sweep.c,i,b2Vec2.s_t0),n=b2Vec2.AddVV(e.m_sweep.c,s,b2Vec2.s_t1),r=b2Vec2.SubVV(n,o,b2Vec2.s_t2),a=t.GetWorldVector(this.m_localXAxisA,this.m_axis),h=t.m_linearVelocity,l=e.m_linearVelocity,_=t.m_angularVelocity,m=e.m_angularVelocity;return b2Vec2.DotVV(r,b2Vec2.CrossSV(_,a,b2Vec2.s_t0))+b2Vec2.DotVV(a,b2Vec2.SubVV(b2Vec2.AddVCrossSV(l,m,s,b2Vec2.s_t0),b2Vec2.AddVCrossSV(h,_,i,b2Vec2.s_t1),b2Vec2.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_lowerImpulse=0,this.m_upperImpulse=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=b2Transform.MulXV(e,this.m_localAnchorA,b2PrismaticJoint.Draw_s_pA),o=b2Transform.MulXV(i,this.m_localAnchorB,b2PrismaticJoint.Draw_s_pB),n=b2Rot.MulRV(e.q,this.m_localXAxisA,b2PrismaticJoint.Draw_s_axis),r=b2PrismaticJoint.Draw_s_c1,a=b2PrismaticJoint.Draw_s_c2,h=b2PrismaticJoint.Draw_s_c3,l=b2PrismaticJoint.Draw_s_c4,_=b2PrismaticJoint.Draw_s_c5;if(t.DrawSegment(s,o,_),this.m_enableLimit){const i=b2Vec2.AddVMulSV(s,this.m_lowerTranslation,n,b2PrismaticJoint.Draw_s_lower),o=b2Vec2.AddVMulSV(s,this.m_upperTranslation,n,b2PrismaticJoint.Draw_s_upper),l=b2Rot.MulRV(e.q,this.m_localYAxisA,b2PrismaticJoint.Draw_s_perp);t.DrawSegment(i,o,r),t.DrawSegment(b2Vec2.AddVMulSV(i,-.5,l,b2Vec2.s_t0),b2Vec2.AddVMulSV(i,.5,l,b2Vec2.s_t1),a),t.DrawSegment(b2Vec2.AddVMulSV(o,-.5,l,b2Vec2.s_t0),b2Vec2.AddVMulSV(o,.5,l,b2Vec2.s_t1),h)}else t.DrawSegment(b2Vec2.AddVMulSV(s,-1,n,b2Vec2.s_t0),b2Vec2.AddVMulSV(s,1,n,b2Vec2.s_t1),r);t.DrawPoint(s,5,r),t.DrawPoint(o,5,l)}}b2PrismaticJoint.InitVelocityConstraints_s_d=new b2Vec2,b2PrismaticJoint.InitVelocityConstraints_s_P=new b2Vec2,b2PrismaticJoint.SolveVelocityConstraints_s_P=new b2Vec2,b2PrismaticJoint.SolveVelocityConstraints_s_df=new b2Vec2,b2PrismaticJoint.SolvePositionConstraints_s_d=new b2Vec2,b2PrismaticJoint.SolvePositionConstraints_s_impulse=new b2Vec3,b2PrismaticJoint.SolvePositionConstraints_s_impulse1=new b2Vec2,b2PrismaticJoint.SolvePositionConstraints_s_P=new b2Vec2,b2PrismaticJoint.GetJointTranslation_s_pA=new b2Vec2,b2PrismaticJoint.GetJointTranslation_s_pB=new b2Vec2,b2PrismaticJoint.GetJointTranslation_s_d=new b2Vec2,b2PrismaticJoint.GetJointTranslation_s_axis=new b2Vec2,b2PrismaticJoint.Draw_s_pA=new b2Vec2,b2PrismaticJoint.Draw_s_pB=new b2Vec2,b2PrismaticJoint.Draw_s_axis=new b2Vec2,b2PrismaticJoint.Draw_s_c1=new b2Color(.7,.7,.7),b2PrismaticJoint.Draw_s_c2=new b2Color(.3,.9,.3),b2PrismaticJoint.Draw_s_c3=new b2Color(.9,.3,.3),b2PrismaticJoint.Draw_s_c4=new b2Color(.3,.3,.9),b2PrismaticJoint.Draw_s_c5=new b2Color(.4,.4,.4),b2PrismaticJoint.Draw_s_lower=new b2Vec2,b2PrismaticJoint.Draw_s_upper=new b2Vec2,b2PrismaticJoint.Draw_s_perp=new b2Vec2;class b2PulleyJoint extends b2Joint{constructor(t){super(t),this.m_groundAnchorA=new b2Vec2,this.m_groundAnchorB=new b2Vec2,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new b2Vec2,this.m_uB=new b2Vec2,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_groundAnchorA.Copy(b2Maybe(t.groundAnchorA,new b2Vec2(-1,1))),this.m_groundAnchorB.Copy(b2Maybe(t.groundAnchorB,new b2Vec2(1,0))),this.m_localAnchorA.Copy(b2Maybe(t.localAnchorA,new b2Vec2(-1,0))),this.m_localAnchorB.Copy(b2Maybe(t.localAnchorB,new b2Vec2(1,0))),this.m_lengthA=b2Maybe(t.lengthA,0),this.m_lengthB=b2Maybe(t.lengthB,0),this.m_ratio=b2Maybe(t.ratio,1),this.m_constant=b2Maybe(t.lengthA,0)+this.m_ratio*b2Maybe(t.lengthB,0),this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(r);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),b2Rot.MulRV(l,this.m_lalcA,this.m_rA),b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),b2Rot.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(n).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const m=this.m_uA.Length(),c=this.m_uB.Length();m>.05?this.m_uA.SelfMul(1/m):this.m_uA.SetZero(),c>.05?this.m_uB.SelfMul(1/c):this.m_uB.SetZero();const b=b2Vec2.CrossVV(this.m_rA,this.m_uA),u=b2Vec2.CrossVV(this.m_rB,this.m_uB),d=this.m_invMassA+this.m_invIA*b*b,p=this.m_invMassB+this.m_invIB*u*u;if(this.m_mass=d+this.m_ratio*this.m_ratio*p,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=b2Vec2.MulSV(-this.m_impulse,this.m_uA,b2PulleyJoint.InitVelocityConstraints_s_PA),i=b2Vec2.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,b2PulleyJoint.InitVelocityConstraints_s_PB);s.SelfMulAdd(this.m_invMassA,e),o+=this.m_invIA*b2Vec2.CrossVV(this.m_rA,e),a.SelfMulAdd(this.m_invMassB,i),h+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,i)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=h}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const n=b2Vec2.AddVCrossSV(e,i,this.m_rA,b2PulleyJoint.SolveVelocityConstraints_s_vpA),r=b2Vec2.AddVCrossSV(s,o,this.m_rB,b2PulleyJoint.SolveVelocityConstraints_s_vpB),a=-b2Vec2.DotVV(this.m_uA,n)-this.m_ratio*b2Vec2.DotVV(this.m_uB,r),h=-this.m_mass*a;this.m_impulse+=h;const l=b2Vec2.MulSV(-h,this.m_uA,b2PulleyJoint.SolveVelocityConstraints_s_PA),_=b2Vec2.MulSV(-this.m_ratio*h,this.m_uB,b2PulleyJoint.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,l),i+=this.m_invIA*b2Vec2.CrossVV(this.m_rA,l),s.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*b2Vec2.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(o);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=b2Rot.MulRV(n,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const l=b2Rot.MulRV(r,this.m_lalcB,this.m_rB),_=this.m_uA.Copy(e).SelfAdd(h).SelfSub(this.m_groundAnchorA),m=this.m_uB.Copy(s).SelfAdd(l).SelfSub(this.m_groundAnchorB),c=_.Length(),b=m.Length();c>.05?_.SelfMul(1/c):_.SetZero(),b>.05?m.SelfMul(1/b):m.SetZero();const u=b2Vec2.CrossVV(h,_),d=b2Vec2.CrossVV(l,m),p=this.m_invMassA+this.m_invIA*u*u,y=this.m_invMassB+this.m_invIB*d*d;let V=p+this.m_ratio*this.m_ratio*y;V>0&&(V=1/V);const x=this.m_constant-c-this.m_ratio*b,f=S(x),A=-V*x,C=b2Vec2.MulSV(-A,_,b2PulleyJoint.SolvePositionConstraints_s_PA),w=b2Vec2.MulSV(-this.m_ratio*A,m,b2PulleyJoint.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,C),i+=this.m_invIA*b2Vec2.CrossVV(h,C),s.SelfMulAdd(this.m_invMassB,w),o+=this.m_invIB*b2Vec2.CrossVV(l,w),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,f<a}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,b2PulleyJoint.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return b2Vec2.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,b2PulleyJoint.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return b2Vec2.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}b2PulleyJoint.InitVelocityConstraints_s_PA=new b2Vec2,b2PulleyJoint.InitVelocityConstraints_s_PB=new b2Vec2,b2PulleyJoint.SolveVelocityConstraints_s_vpA=new b2Vec2,b2PulleyJoint.SolveVelocityConstraints_s_vpB=new b2Vec2,b2PulleyJoint.SolveVelocityConstraints_s_PA=new b2Vec2,b2PulleyJoint.SolveVelocityConstraints_s_PB=new b2Vec2,b2PulleyJoint.SolvePositionConstraints_s_PA=new b2Vec2,b2PulleyJoint.SolvePositionConstraints_s_PB=new b2Vec2,b2PulleyJoint.GetCurrentLengthA_s_p=new b2Vec2,b2PulleyJoint.GetCurrentLengthB_s_p=new b2Vec2;class b2RevoluteJoint extends b2Joint{constructor(t){super(t),this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_impulse=new b2Vec2,this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_K=new b2Mat22,this.m_angle=0,this.m_axialMass=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_localAnchorA.Copy(b2Maybe(t.localAnchorA,b2Vec2.ZERO)),this.m_localAnchorB.Copy(b2Maybe(t.localAnchorB,b2Vec2.ZERO)),this.m_referenceAngle=b2Maybe(t.referenceAngle,0),this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=b2Maybe(t.lowerAngle,0),this.m_upperAngle=b2Maybe(t.upperAngle,0),this.m_maxMotorTorque=b2Maybe(t.maxMotorTorque,0),this.m_motorSpeed=b2Maybe(t.motorSpeed,0),this.m_enableLimit=b2Maybe(t.enableLimit,!1),this.m_enableMotor=b2Maybe(t.enableMotor,!1)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const a=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(o);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),b2Rot.MulRV(a,this.m_lalcA,this.m_rA),b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),b2Rot.MulRV(h,this.m_lalcB,this.m_rB);const l=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,c=this.m_invIB;let b;if(this.m_K.ex.x=l+_+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*c,this.m_K.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*c,this.m_K.ex.y=this.m_K.ey.x,this.m_K.ey.y=l+_+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*c,this.m_axialMass=m+c,this.m_axialMass>0?(this.m_axialMass=1/this.m_axialMass,b=!1):b=!0,this.m_angle=o-e-this.m_referenceAngle,(!1===this.m_enableLimit||b)&&(this.m_lowerImpulse=0,this.m_upperImpulse=0),(!1===this.m_enableMotor||b)&&(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse,o=b2RevoluteJoint.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(l,o),s-=m*(b2Vec2.CrossVV(this.m_rA,o)+e),n.SelfMulAdd(_,o),r+=c*(b2Vec2.CrossVV(this.m_rB,o)+e)}else this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=r}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB,l=a+h===0;if(this.m_enableMotor&&!l){const e=o-i-this.m_motorSpeed;let s=-this.m_axialMass*e;const n=this.m_motorImpulse,r=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=b2Clamp(this.m_motorImpulse+s,-r,r),s=this.m_motorImpulse-n,i-=a*s,o+=h*s}if(this.m_enableLimit&&!l){{const e=this.m_angle-this.m_lowerAngle,s=o-i;let n=-this.m_axialMass*(s+b2Max(e,0)*t.step.inv_dt);const r=this.m_lowerImpulse;this.m_lowerImpulse=b2Max(this.m_lowerImpulse+n,0),n=this.m_lowerImpulse-r,i-=a*n,o+=h*n}{const e=this.m_upperAngle-this.m_angle,s=i-o;let n=-this.m_axialMass*(s+b2Max(e,0)*t.step.inv_dt);const r=this.m_upperImpulse;this.m_upperImpulse=b2Max(this.m_upperImpulse+n,0),n=this.m_upperImpulse-r,i+=a*n,o-=h*n}}{const t=b2Vec2.SubVV(b2Vec2.AddVCrossSV(s,o,this.m_rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(e,i,this.m_rA,b2Vec2.s_t1),b2RevoluteJoint.SolveVelocityConstraints_s_Cdot_v2),l=this.m_K.Solve(-t.x,-t.y,b2RevoluteJoint.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=l.x,this.m_impulse.y+=l.y,e.SelfMulSub(n,l),i-=a*b2Vec2.CrossVV(this.m_rA,l),s.SelfMulAdd(r,l),o+=h*b2Vec2.CrossVV(this.m_rB,l)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(o);let l=0,_=0;const c=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&!c){const t=o-i-this.m_referenceAngle;let e=0;S(this.m_upperAngle-this.m_lowerAngle)<2*h?e=b2Clamp(t-this.m_lowerAngle,-.13962634015955555,m):t<=this.m_lowerAngle?e=b2Clamp(t-this.m_lowerAngle+h,-.13962634015955555,0):t>=this.m_upperAngle&&(e=b2Clamp(t-this.m_upperAngle-h,0,m));const s=-this.m_axialMass*e;i-=this.m_invIA*s,o+=this.m_invIB*s,l=S(e)}{n.SetAngle(i),r.SetAngle(o),b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const t=b2Rot.MulRV(n,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const a=b2Rot.MulRV(r,this.m_lalcB,this.m_rB),h=b2Vec2.SubVV(b2Vec2.AddVV(s,a,b2Vec2.s_t0),b2Vec2.AddVV(e,t,b2Vec2.s_t1),b2RevoluteJoint.SolvePositionConstraints_s_C_v2);_=h.Length();const l=this.m_invMassA,m=this.m_invMassB,c=this.m_invIA,b=this.m_invIB,u=this.m_K;u.ex.x=l+m+c*t.y*t.y+b*a.y*a.y,u.ex.y=-c*t.x*t.y-b*a.x*a.y,u.ey.x=u.ex.y,u.ey.y=l+m+c*t.x*t.x+b*a.x*a.x;const d=u.Solve(h.x,h.y,b2RevoluteJoint.SolvePositionConstraints_s_impulse).SelfNeg();e.SelfMulSub(l,d),i-=c*b2Vec2.CrossVV(t,d),s.SelfMulAdd(m,d),o+=b*b2Vec2.CrossVV(a,d)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,_<=a&&l<=h}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*(this.m_lowerImpulse-this.m_upperImpulse)}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=b2Transform.MulXV(e,this.m_localAnchorA,b2RevoluteJoint.Draw_s_pA),o=b2Transform.MulXV(i,this.m_localAnchorB,b2RevoluteJoint.Draw_s_pB),n=b2RevoluteJoint.Draw_s_c1,r=b2RevoluteJoint.Draw_s_c2,a=b2RevoluteJoint.Draw_s_c3,h=b2RevoluteJoint.Draw_s_c4,l=b2RevoluteJoint.Draw_s_c5;t.DrawPoint(s,5,h),t.DrawPoint(o,5,l);const _=this.m_bodyA.GetAngle(),m=this.m_bodyB.GetAngle()-_-this.m_referenceAngle,c=.5,b=b2RevoluteJoint.Draw_s_r.Set(c*Math.cos(m),c*Math.sin(m));if(t.DrawSegment(o,b2Vec2.AddVV(o,b,b2Vec2.s_t0),n),t.DrawCircle(o,c,n),this.m_enableLimit){const e=b2RevoluteJoint.Draw_s_rlo.Set(c*Math.cos(this.m_lowerAngle),c*Math.sin(this.m_lowerAngle)),i=b2RevoluteJoint.Draw_s_rhi.Set(c*Math.cos(this.m_upperAngle),c*Math.sin(this.m_upperAngle));t.DrawSegment(o,b2Vec2.AddVV(o,e,b2Vec2.s_t0),r),t.DrawSegment(o,b2Vec2.AddVV(o,i,b2Vec2.s_t0),a)}const u=b2RevoluteJoint.Draw_s_color_;t.DrawSegment(e.p,s,u),t.DrawSegment(s,o,u),t.DrawSegment(i.p,o,u)}}b2RevoluteJoint.InitVelocityConstraints_s_P=new b2Vec2,b2RevoluteJoint.SolveVelocityConstraints_s_Cdot_v2=new b2Vec2,b2RevoluteJoint.SolveVelocityConstraints_s_impulse_v2=new b2Vec2,b2RevoluteJoint.SolvePositionConstraints_s_C_v2=new b2Vec2,b2RevoluteJoint.SolvePositionConstraints_s_impulse=new b2Vec2,b2RevoluteJoint.Draw_s_pA=new b2Vec2,b2RevoluteJoint.Draw_s_pB=new b2Vec2,b2RevoluteJoint.Draw_s_c1=new b2Color(.7,.7,.7),b2RevoluteJoint.Draw_s_c2=new b2Color(.3,.9,.3),b2RevoluteJoint.Draw_s_c3=new b2Color(.9,.3,.3),b2RevoluteJoint.Draw_s_c4=new b2Color(.3,.3,.9),b2RevoluteJoint.Draw_s_c5=new b2Color(.4,.4,.4),b2RevoluteJoint.Draw_s_color_=new b2Color(.5,.8,.8),b2RevoluteJoint.Draw_s_r=new b2Vec2,b2RevoluteJoint.Draw_s_rlo=new b2Vec2,b2RevoluteJoint.Draw_s_rhi=new b2Vec2;class b2WeldJoint extends b2Joint{constructor(t){super(t),this.m_stiffness=0,this.m_damping=0,this.m_bias=0,this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new b2Vec3(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new b2Mat33,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_K=new b2Mat33,this.m_stiffness=b2Maybe(t.stiffness,0),this.m_damping=b2Maybe(t.damping,0),this.m_localAnchorA.Copy(b2Maybe(t.localAnchorA,b2Vec2.ZERO)),this.m_localAnchorB.Copy(b2Maybe(t.localAnchorB,b2Vec2.ZERO)),this.m_referenceAngle=b2Maybe(t.referenceAngle,0),this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const a=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(o);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),b2Rot.MulRV(a,this.m_lalcA,this.m_rA),b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),b2Rot.MulRV(h,this.m_lalcB,this.m_rB);const l=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,c=this.m_invIB,b=this.m_K;if(b.ex.x=l+_+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*c,b.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*c,b.ez.x=-this.m_rA.y*m-this.m_rB.y*c,b.ex.y=b.ey.x,b.ey.y=l+_+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*c,b.ez.y=this.m_rA.x*m+this.m_rB.x*c,b.ex.z=b.ez.x,b.ey.z=b.ez.y,b.ez.z=m+c,this.m_stiffness>0){b.GetInverse22(this.m_mass);let i=m+c;const s=o-e-this.m_referenceAngle,n=this.m_damping,r=this.m_stiffness,a=t.step.dt;this.m_gamma=a*(n+a*r),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=s*a*r*this.m_gamma,i+=this.m_gamma,this.m_mass.ez.z=0!==i?1/i:0}else b.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const e=b2WeldJoint.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(l,e),s-=m*(b2Vec2.CrossVV(this.m_rA,e)+this.m_impulse.z),n.SelfMulAdd(_,e),r+=c*(b2Vec2.CrossVV(this.m_rB,e)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=r}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const n=this.m_invMassA,r=this.m_invMassB,a=this.m_invIA,h=this.m_invIB;if(this.m_stiffness>0){const t=o-i,l=-this.m_mass.ez.z*(t+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=l,i-=a*l,o+=h*l;const _=b2Vec2.SubVV(b2Vec2.AddVCrossSV(s,o,this.m_rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(e,i,this.m_rA,b2Vec2.s_t1),b2WeldJoint.SolveVelocityConstraints_s_Cdot1),m=b2Mat33.MulM33XY(this.m_mass,_.x,_.y,b2WeldJoint.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=m.x,this.m_impulse.y+=m.y;const c=m;e.SelfMulSub(n,c),i-=a*b2Vec2.CrossVV(this.m_rA,c),s.SelfMulAdd(r,c),o+=h*b2Vec2.CrossVV(this.m_rB,c)}else{const t=b2Vec2.SubVV(b2Vec2.AddVCrossSV(s,o,this.m_rB,b2Vec2.s_t0),b2Vec2.AddVCrossSV(e,i,this.m_rA,b2Vec2.s_t1),b2WeldJoint.SolveVelocityConstraints_s_Cdot1),l=o-i,_=b2Mat33.MulM33XYZ(this.m_mass,t.x,t.y,l,b2WeldJoint.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(_);const m=b2WeldJoint.SolveVelocityConstraints_s_P.Set(_.x,_.y);e.SelfMulSub(n,m),i-=a*(b2Vec2.CrossVV(this.m_rA,m)+_.z),s.SelfMulAdd(r,m),o+=h*(b2Vec2.CrossVV(this.m_rB,m)+_.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(o),l=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,c=this.m_invIB;b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const b=b2Rot.MulRV(n,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const u=b2Rot.MulRV(r,this.m_lalcB,this.m_rB);let d,p;const y=this.m_K;if(y.ex.x=l+_+b.y*b.y*m+u.y*u.y*c,y.ey.x=-b.y*b.x*m-u.y*u.x*c,y.ez.x=-b.y*m-u.y*c,y.ex.y=y.ey.x,y.ey.y=l+_+b.x*b.x*m+u.x*u.x*c,y.ez.y=b.x*m+u.x*c,y.ex.z=y.ez.x,y.ey.z=y.ez.y,y.ez.z=m+c,this.m_stiffness>0){const t=b2Vec2.SubVV(b2Vec2.AddVV(s,u,b2Vec2.s_t0),b2Vec2.AddVV(e,b,b2Vec2.s_t1),b2WeldJoint.SolvePositionConstraints_s_C1);d=t.Length(),p=0;const n=y.Solve22(t.x,t.y,b2WeldJoint.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(l,n),i-=m*b2Vec2.CrossVV(b,n),s.SelfMulAdd(_,n),o+=c*b2Vec2.CrossVV(u,n)}else{const t=b2Vec2.SubVV(b2Vec2.AddVV(s,u,b2Vec2.s_t0),b2Vec2.AddVV(e,b,b2Vec2.s_t1),b2WeldJoint.SolvePositionConstraints_s_C1),n=o-i-this.m_referenceAngle;d=t.Length(),p=S(n);const r=y.Solve33(t.x,t.y,n,b2WeldJoint.SolvePositionConstraints_s_impulse).SelfNeg(),a=b2WeldJoint.SolvePositionConstraints_s_P.Set(r.x,r.y);e.SelfMulSub(l,a),i-=m*(b2Vec2.CrossVV(this.m_rA,a)+r.z),s.SelfMulAdd(_,a),o+=c*(b2Vec2.CrossVV(this.m_rB,a)+r.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,d<=a&&p<=h}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.stiffness = %.15f;\n",this.m_stiffness),t("  jd.damping = %.15f;\n",this.m_damping),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}b2WeldJoint.InitVelocityConstraints_s_P=new b2Vec2,b2WeldJoint.SolveVelocityConstraints_s_Cdot1=new b2Vec2,b2WeldJoint.SolveVelocityConstraints_s_impulse1=new b2Vec2,b2WeldJoint.SolveVelocityConstraints_s_impulse=new b2Vec3,b2WeldJoint.SolveVelocityConstraints_s_P=new b2Vec2,b2WeldJoint.SolvePositionConstraints_s_C1=new b2Vec2,b2WeldJoint.SolvePositionConstraints_s_P=new b2Vec2,b2WeldJoint.SolvePositionConstraints_s_impulse=new b2Vec3;class b2WheelJoint extends b2Joint{constructor(t){super(t),this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_localXAxisA=new b2Vec2,this.m_localYAxisA=new b2Vec2,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_translation=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_stiffness=0,this.m_damping=0,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new b2Vec2,this.m_ay=new b2Vec2,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_axialMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new b2Rot,this.m_qB=new b2Rot,this.m_lalcA=new b2Vec2,this.m_lalcB=new b2Vec2,this.m_rA=new b2Vec2,this.m_rB=new b2Vec2,this.m_localAnchorA.Copy(b2Maybe(t.localAnchorA,b2Vec2.ZERO)),this.m_localAnchorB.Copy(b2Maybe(t.localAnchorB,b2Vec2.ZERO)),this.m_localXAxisA.Copy(b2Maybe(t.localAxisA,b2Vec2.UNITX)),b2Vec2.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_lowerTranslation=b2Maybe(t.lowerTranslation,0),this.m_upperTranslation=b2Maybe(t.upperTranslation,0),this.m_enableLimit=b2Maybe(t.enableLimit,!1),this.m_maxMotorTorque=b2Maybe(t.maxMotorTorque,0),this.m_motorSpeed=b2Maybe(t.motorSpeed,0),this.m_enableMotor=b2Maybe(t.enableMotor,!1),this.m_ax.SetZero(),this.m_ay.SetZero(),this.m_stiffness=b2Maybe(t.stiffness,0),this.m_damping=b2Maybe(t.damping,0)}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,o=this.m_invIB,n=t.positions[this.m_indexA].c,r=t.positions[this.m_indexA].a,a=t.velocities[this.m_indexA].v;let h=t.velocities[this.m_indexA].w;const l=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,m=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const b=this.m_qA.SetAngle(r),u=this.m_qB.SetAngle(_);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const d=b2Rot.MulRV(b,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const p=b2Rot.MulRV(u,this.m_lalcB,this.m_rB),y=b2Vec2.SubVV(b2Vec2.AddVV(l,p,b2Vec2.s_t0),b2Vec2.AddVV(n,d,b2Vec2.s_t1),b2WheelJoint.InitVelocityConstraints_s_d);b2Rot.MulRV(b,this.m_localYAxisA,this.m_ay),this.m_sAy=b2Vec2.CrossVV(b2Vec2.AddVV(y,d,b2Vec2.s_t0),this.m_ay),this.m_sBy=b2Vec2.CrossVV(p,this.m_ay),this.m_mass=e+i+s*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),b2Rot.MulRV(b,this.m_localXAxisA,this.m_ax),this.m_sAx=b2Vec2.CrossVV(b2Vec2.AddVV(y,d,b2Vec2.s_t0),this.m_ax),this.m_sBx=b2Vec2.CrossVV(p,this.m_ax);const V=e+i+s*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(this.m_axialMass=V>0?1/V:0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_stiffness>0&&V>0){this.m_springMass=1/V;const e=b2Vec2.DotVV(y,this.m_ax),i=t.step.dt;this.m_gamma=i*(this.m_damping+i*this.m_stiffness),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=e*i*this.m_stiffness*this.m_gamma,this.m_springMass=V+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}else this.m_springImpulse=0;if(this.m_enableLimit?this.m_translation=b2Vec2.DotVV(this.m_ax,y):(this.m_lowerImpulse=0,this.m_upperImpulse=0),this.m_enableMotor?(this.m_motorMass=s+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const e=this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse,i=b2Vec2.AddVV(b2Vec2.MulSV(this.m_impulse,this.m_ay,b2Vec2.s_t0),b2Vec2.MulSV(e,this.m_ax,b2Vec2.s_t1),b2WheelJoint.InitVelocityConstraints_s_P),s=this.m_impulse*this.m_sAy+e*this.m_sAx+this.m_motorImpulse,o=this.m_impulse*this.m_sBy+e*this.m_sBx+this.m_motorImpulse;a.SelfMulSub(this.m_invMassA,i),h-=this.m_invIA*s,m.SelfMulAdd(this.m_invMassB,i),c+=this.m_invIB*o}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=h,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,o=this.m_invIB,n=t.velocities[this.m_indexA].v;let r=t.velocities[this.m_indexA].w;const a=t.velocities[this.m_indexB].v;let h=t.velocities[this.m_indexB].w;{const t=b2Vec2.DotVV(this.m_ax,b2Vec2.SubVV(a,n,b2Vec2.s_t0))+this.m_sBx*h-this.m_sAx*r,l=-this.m_springMass*(t+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=l;const _=b2Vec2.MulSV(l,this.m_ax,b2WheelJoint.SolveVelocityConstraints_s_P),m=l*this.m_sAx,c=l*this.m_sBx;n.SelfMulSub(e,_),r-=s*m,a.SelfMulAdd(i,_),h+=o*c}{const e=h-r-this.m_motorSpeed;let i=-this.m_motorMass*e;const n=this.m_motorImpulse,a=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=b2Clamp(this.m_motorImpulse+i,-a,a),i=this.m_motorImpulse-n,r-=s*i,h+=o*i}if(this.m_enableLimit){{const l=this.m_translation-this.m_lowerTranslation,_=b2Vec2.DotVV(this.m_ax,b2Vec2.SubVV(a,n,b2Vec2.s_t0))+this.m_sBx*h-this.m_sAx*r;let m=-this.m_axialMass*(_+b2Max(l,0)*t.step.inv_dt);const c=this.m_lowerImpulse;this.m_lowerImpulse=b2Max(this.m_lowerImpulse+m,0),m=this.m_lowerImpulse-c;const b=b2Vec2.MulSV(m,this.m_ax,b2WheelJoint.SolveVelocityConstraints_s_P),u=m*this.m_sAx,d=m*this.m_sBx;n.SelfMulSub(e,b),r-=s*u,a.SelfMulAdd(i,b),h+=o*d}{const l=this.m_upperTranslation-this.m_translation,_=b2Vec2.DotVV(this.m_ax,b2Vec2.SubVV(n,a,b2Vec2.s_t0))+this.m_sAx*r-this.m_sBx*h;let m=-this.m_axialMass*(_+b2Max(l,0)*t.step.inv_dt);const c=this.m_upperImpulse;this.m_upperImpulse=b2Max(this.m_upperImpulse+m,0),m=this.m_upperImpulse-c;const b=b2Vec2.MulSV(m,this.m_ax,b2WheelJoint.SolveVelocityConstraints_s_P),u=m*this.m_sAx,d=m*this.m_sBx;n.SelfMulAdd(e,b),r+=s*u,a.SelfMulSub(i,b),h-=o*d}}{const t=b2Vec2.DotVV(this.m_ay,b2Vec2.SubVV(a,n,b2Vec2.s_t0))+this.m_sBy*h-this.m_sAy*r,l=-this.m_mass*t;this.m_impulse+=l;const _=b2Vec2.MulSV(l,this.m_ay,b2WheelJoint.SolveVelocityConstraints_s_P),m=l*this.m_sAy,c=l*this.m_sBy;n.SelfMulSub(e,_),r-=s*m,a.SelfMulAdd(i,_),h+=o*c}t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=h}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let o=t.positions[this.m_indexB].a,n=0;if(this.m_enableLimit){const t=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(o);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=b2Rot.MulRV(t,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=b2Rot.MulRV(r,this.m_lalcB,this.m_rB),l=b2Vec2.AddVV(b2Vec2.SubVV(s,e,b2Vec2.s_t0),b2Vec2.SubVV(h,a,b2Vec2.s_t1),b2WheelJoint.SolvePositionConstraints_s_d),_=b2Rot.MulRV(t,this.m_localXAxisA,this.m_ax),m=b2Vec2.CrossVV(b2Vec2.AddVV(l,a,b2Vec2.s_t0),this.m_ax),c=b2Vec2.CrossVV(h,this.m_ax);let b=0;const u=b2Vec2.DotVV(_,l);if(S(this.m_upperTranslation-this.m_lowerTranslation)<.01?b=u:u<=this.m_lowerTranslation?b=b2Min(u-this.m_lowerTranslation,0):u>=this.m_upperTranslation&&(b=b2Max(u-this.m_upperTranslation,0)),0!==b){const t=this.m_invMassA+this.m_invMassB+this.m_invIA*m*m+this.m_invIB*c*c;let r=0;0!==t&&(r=-b/t);const a=b2Vec2.MulSV(r,_,b2WheelJoint.SolvePositionConstraints_s_P),h=r*m,l=r*c;e.SelfMulSub(this.m_invMassA,a),i-=this.m_invIA*h,s.SelfMulAdd(this.m_invMassB,a),o+=this.m_invIB*l,n=S(b)}}{const t=this.m_qA.SetAngle(i),r=this.m_qB.SetAngle(o);b2Vec2.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=b2Rot.MulRV(t,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=b2Rot.MulRV(r,this.m_lalcB,this.m_rB),l=b2Vec2.AddVV(b2Vec2.SubVV(s,e,b2Vec2.s_t0),b2Vec2.SubVV(h,a,b2Vec2.s_t1),b2WheelJoint.SolvePositionConstraints_s_d),_=b2Rot.MulRV(t,this.m_localYAxisA,this.m_ay),m=b2Vec2.CrossVV(b2Vec2.AddVV(l,a,b2Vec2.s_t0),_),c=b2Vec2.CrossVV(h,_),b=b2Vec2.DotVV(l,_),u=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let d=0;0!==u&&(d=-b/u);const p=b2Vec2.MulSV(d,_,b2WheelJoint.SolvePositionConstraints_s_P),y=d*m,V=d*c;e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*y,s.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*V,n=b2Max(n,S(b))}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,n<=a}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+(this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+(this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointLinearSpeed(){return this.GetPrismaticJointSpeed()}GetJointAngle(){return this.GetRevoluteJointAngle()}GetJointAngularSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new b2Vec2),s=e.GetWorldPoint(this.m_localAnchorB,new b2Vec2),o=b2Vec2.SubVV(s,i,new b2Vec2),n=t.GetWorldVector(this.m_localXAxisA,new b2Vec2);return b2Vec2.DotVV(o,n)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;b2Vec2.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=b2Rot.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);b2Vec2.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const s=b2Rot.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),o=b2Vec2.AddVV(t.m_sweep.c,i,b2Vec2.s_t0),n=b2Vec2.AddVV(e.m_sweep.c,s,b2Vec2.s_t1),r=b2Vec2.SubVV(n,o,b2Vec2.s_t2),a=t.GetWorldVector(this.m_localXAxisA,new b2Vec2),h=t.m_linearVelocity,l=e.m_linearVelocity,_=t.m_angularVelocity,m=e.m_angularVelocity;return b2Vec2.DotVV(r,b2Vec2.CrossSV(_,a,b2Vec2.s_t0))+b2Vec2.DotVV(a,b2Vec2.SubVV(b2Vec2.AddVCrossSV(l,m,s,b2Vec2.s_t0),b2Vec2.AddVCrossSV(h,_,i,b2Vec2.s_t1),b2Vec2.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_lowerImpulse=0,this.m_upperImpulse=0)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.stiffness = %.15f;\n",this.m_stiffness),t("  jd.damping = %.15f;\n",this.m_damping),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=b2Transform.MulXV(e,this.m_localAnchorA,b2WheelJoint.Draw_s_pA),o=b2Transform.MulXV(i,this.m_localAnchorB,b2WheelJoint.Draw_s_pB),n=b2Rot.MulRV(e.q,this.m_localXAxisA,b2WheelJoint.Draw_s_axis),r=b2WheelJoint.Draw_s_c1,a=b2WheelJoint.Draw_s_c2,h=b2WheelJoint.Draw_s_c3,l=b2WheelJoint.Draw_s_c4,_=b2WheelJoint.Draw_s_c5;if(t.DrawSegment(s,o,_),this.m_enableLimit){const i=b2Vec2.AddVMulSV(s,this.m_lowerTranslation,n,b2WheelJoint.Draw_s_lower),o=b2Vec2.AddVMulSV(s,this.m_upperTranslation,n,b2WheelJoint.Draw_s_upper),l=b2Rot.MulRV(e.q,this.m_localYAxisA,b2WheelJoint.Draw_s_perp);t.DrawSegment(i,o,r),t.DrawSegment(b2Vec2.AddVMulSV(i,-.5,l,b2Vec2.s_t0),b2Vec2.AddVMulSV(i,.5,l,b2Vec2.s_t1),a),t.DrawSegment(b2Vec2.AddVMulSV(o,-.5,l,b2Vec2.s_t0),b2Vec2.AddVMulSV(o,.5,l,b2Vec2.s_t1),h)}else t.DrawSegment(b2Vec2.AddVMulSV(s,-1,n,b2Vec2.s_t0),b2Vec2.AddVMulSV(s,1,n,b2Vec2.s_t1),r);t.DrawPoint(s,5,r),t.DrawPoint(o,5,l)}}b2WheelJoint.InitVelocityConstraints_s_d=new b2Vec2,b2WheelJoint.InitVelocityConstraints_s_P=new b2Vec2,b2WheelJoint.SolveVelocityConstraints_s_P=new b2Vec2,b2WheelJoint.SolvePositionConstraints_s_d=new b2Vec2,b2WheelJoint.SolvePositionConstraints_s_P=new b2Vec2,b2WheelJoint.Draw_s_pA=new b2Vec2,b2WheelJoint.Draw_s_pB=new b2Vec2,b2WheelJoint.Draw_s_axis=new b2Vec2,b2WheelJoint.Draw_s_c1=new b2Color(.7,.7,.7),b2WheelJoint.Draw_s_c2=new b2Color(.3,.9,.3),b2WheelJoint.Draw_s_c3=new b2Color(.9,.3,.3),b2WheelJoint.Draw_s_c4=new b2Color(.3,.3,.9),b2WheelJoint.Draw_s_c5=new b2Color(.4,.4,.4),b2WheelJoint.Draw_s_lower=new b2Vec2,b2WheelJoint.Draw_s_upper=new b2Vec2,b2WheelJoint.Draw_s_perp=new b2Vec2;class b2World{constructor(t){this.m_contactManager=new b2ContactManager,this.m_bodyList=null,this.m_jointList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new b2Vec2,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_newContacts=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new b2Profile,this.m_island=new b2Island,this.s_stack=[],this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t={}){if(this.IsLocked())throw new Error;const e=new b2Body(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())throw new Error;let e=t.m_jointList;for(;e;){const i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_contactList;for(;i;){const t=i;i=i.next,this.m_contactManager.Destroy(t.contact)}t.m_contactList=null;let s=t.m_fixtureList;for(;s;){const e=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(e),e.DestroyProxies(),e.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static _Joint_Create(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new b2DistanceJoint(e);case t.b2JointType.e_mouseJoint:return new b2MouseJoint(e);case t.b2JointType.e_prismaticJoint:return new b2PrismaticJoint(e);case t.b2JointType.e_revoluteJoint:return new b2RevoluteJoint(e);case t.b2JointType.e_pulleyJoint:return new b2PulleyJoint(e);case t.b2JointType.e_gearJoint:return new b2GearJoint(e);case t.b2JointType.e_wheelJoint:return new b2WheelJoint(e);case t.b2JointType.e_weldJoint:return new b2WeldJoint(e);case t.b2JointType.e_frictionJoint:return new b2FrictionJoint(e);case t.b2JointType.e_motorJoint:return new b2MotorJoint(e);case t.b2JointType.e_areaJoint:return new b2AreaJoint(e)}throw new Error}static _Joint_Destroy(t){}CreateJoint(t){if(this.IsLocked())throw new Error;const e=b2World._Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,s=e.m_bodyB;if(!e.m_collideConnected){let t=s.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}return e}DestroyJoint(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,s=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),b2World._Joint_Destroy(t),--this.m_jointCount,!s){let t=i.GetContactList();for(;t;)t.other===e&&t.contact.FlagForFiltering(),t=t.next}}Step(t,e,i){const s=b2World.Step_s_stepTimer.Reset();this.m_newContacts&&(this.m_contactManager.FindNewContacts(),this.m_newContacts=!1),this.m_locked=!0;const o=b2World.Step_s_step;o.dt=t,o.velocityIterations=e,o.positionIterations=i,o.inv_dt=t>0?1/t:0,o.dtRatio=this.m_inv_dt0*t,o.warmStarting=this.m_warmStarting;const n=b2World.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=n.GetMilliseconds(),this.m_stepComplete&&o.dt>0){const t=b2World.Step_s_timer.Reset();this.Solve(o),this.m_profile.solve=t.GetMilliseconds()}if(this.m_continuousPhysics&&o.dt>0){const t=b2World.Step_s_timer.Reset();this.SolveTOI(o),this.m_profile.solveTOI=t.GetMilliseconds()}o.dt>0&&(this.m_inv_dt0=o.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=s.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DebugDraw(){if(null===this.m_debugDraw)return;const e=this.m_debugDraw.GetFlags(),i=b2World.DebugDraw_s_color.SetRGB(0,0,0);if(e&t.b2DrawFlags.e_shapeBit)for(let e=this.m_bodyList;e;e=e.m_next){const s=e.m_xf;this.m_debugDraw.PushTransform(s);for(let s=e.GetFixtureList();s;s=s.m_next)e.GetType()===t.b2BodyType.b2_dynamicBody&&0===e.m_mass?this.DrawShape(s,new b2Color(1,0,0)):e.IsEnabled()?e.GetType()===t.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(s,i)):e.GetType()===t.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(s,i)):e.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(s,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(s,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(s,i));this.m_debugDraw.PopTransform(s)}if(e&t.b2DrawFlags.e_jointBit)for(let t=this.m_jointList;t;t=t.m_next)t.Draw(this.m_debugDraw);if(e&t.b2DrawFlags.e_pairBit){i.SetRGB(.3,.9,.9);for(let t=this.m_contactManager.m_contactList;t;t=t.m_next){const e=t.GetFixtureA(),s=t.GetFixtureB(),o=t.GetChildIndexA(),n=t.GetChildIndexB(),r=e.GetAABB(o).GetCenter(),a=s.GetAABB(n).GetCenter();this.m_debugDraw.DrawSegment(r,a,i)}}if(e&t.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);const t=b2World.DebugDraw_s_vs;for(let e=this.m_bodyList;e;e=e.m_next)if(e.IsEnabled())for(let s=e.GetFixtureList();s;s=s.m_next)for(let e=0;e<s.m_proxyCount;++e){const o=s.m_proxies[e].treeNode.aabb;t[0].Set(o.lowerBound.x,o.lowerBound.y),t[1].Set(o.upperBound.x,o.lowerBound.y),t[2].Set(o.upperBound.x,o.upperBound.y),t[3].Set(o.lowerBound.x,o.upperBound.y),this.m_debugDraw.DrawPolygon(t,4,i)}}if(e&t.b2DrawFlags.e_centerOfMassBit)for(let t=this.m_bodyList;t;t=t.m_next){const e=b2World.DebugDraw_s_xf;e.q.Copy(t.m_xf.q),e.p.Copy(t.GetWorldCenter()),this.m_debugDraw.DrawTransform(e)}}QueryAABB(...t){t[0]instanceof b2QueryCallback?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])}_QueryAABB(t,e,i){this.m_contactManager.m_broadPhase.Query(e,(e=>{const s=e.userData.fixture;return t?t.ReportFixture(s):!i||i(s)}))}QueryAllAABB(t,e=[]){return this.QueryAABB(t,(t=>(e.push(t),!0))),e}QueryPointAABB(...t){t[0]instanceof b2QueryCallback?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])}_QueryPointAABB(t,e,i){this.m_contactManager.m_broadPhase.QueryPoint(e,(e=>{const s=e.userData.fixture;return t?t.ReportFixture(s):!i||i(s)}))}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,(t=>(e.push(t),!0))),e}QueryFixtureShape(...t){t[0]instanceof b2QueryCallback?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])}_QueryFixtureShape(t,e,i,s,o){const n=b2World.QueryFixtureShape_s_aabb;e.ComputeAABB(n,s,i),this.m_contactManager.m_broadPhase.Query(n,(n=>{const r=n.userData,a=r.fixture;if(b2TestOverlapShape(e,i,a.GetShape(),r.childIndex,s,a.GetBody().GetTransform())){if(t)return t.ReportFixture(a);if(o)return o(a)}return!0}))}QueryAllFixtureShape(t,e,i,s=[]){return this.QueryFixtureShape(t,e,i,(t=>(s.push(t),!0))),s}QueryFixturePoint(...t){t[0]instanceof b2QueryCallback?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])}_QueryFixturePoint(t,e,i){this.m_contactManager.m_broadPhase.QueryPoint(e,(s=>{const o=s.userData.fixture;if(o.TestPoint(e)){if(t)return t.ReportFixture(o);if(i)return i(o)}return!0}))}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,(t=>(e.push(t),!0))),e}RayCast(...t){t[0]instanceof b2RayCastCallback?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])}_RayCast(t,e,i,s){const o=b2World.RayCast_s_input;o.maxFraction=1,o.p1.Copy(e),o.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(o,((o,n)=>{const r=n.userData,a=r.fixture,h=r.childIndex,l=b2World.RayCast_s_output;if(a.RayCast(l,o,h)){const o=l.fraction,n=b2World.RayCast_s_point;if(n.Set((1-o)*e.x+o*i.x,(1-o)*e.y+o*i.y),t)return t.ReportFixture(a,n,l.normal,o);if(s)return s(a,n,l.normal,o)}return o.maxFraction}))}RayCastOne(t,e){let i=null,s=1;return this.RayCast(t,e,((t,e,o,n)=>(n<s&&(s=n,i=t),s))),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,((t,e,s,o)=>(i.push(t),1))),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!b2Vec2.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(this.IsLocked())throw new Error;for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(e){if(this.m_locked)return;e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");let i=0;for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandIndex=i,t.Dump(e),++i;i=0;for(let t=this.m_jointList;t;t=t.m_next)t.m_index=i,++i;for(let i=this.m_jointList;i;i=i.m_next)i.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"));for(let i=this.m_jointList;i;i=i.m_next)i.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"))}DrawShape(e,i){if(null===this.m_debugDraw)return;const s=e.GetShape();switch(s.m_type){case t.b2ShapeType.e_circleShape:{const t=s,e=t.m_p,o=t.m_radius,n=b2Vec2.UNITX;this.m_debugDraw.DrawSolidCircle(e,o,n,i);break}case t.b2ShapeType.e_edgeShape:{const t=s,e=t.m_vertex1,o=t.m_vertex2;this.m_debugDraw.DrawSegment(e,o,i),!1===t.m_oneSided&&(this.m_debugDraw.DrawPoint(e,4,i),this.m_debugDraw.DrawPoint(o,4,i));break}case t.b2ShapeType.e_chainShape:{const t=s,e=t.m_count,o=t.m_vertices;let n=o[0];for(let t=1;t<e;++t){const e=o[t];this.m_debugDraw.DrawSegment(n,e,i),n=e}break}case t.b2ShapeType.e_polygonShape:{const t=s,e=t.m_count,o=t.m_vertices;this.m_debugDraw.DrawSolidPolygon(o,e,i);break}}}Solve(e){this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const i=this.m_island;i.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_jointList;t;t=t.m_next)t.m_islandFlag=!1;const s=this.s_stack;for(let o=this.m_bodyList;o;o=o.m_next){if(o.m_islandFlag)continue;if(!o.IsAwake()||!o.IsEnabled())continue;if(o.GetType()===t.b2BodyType.b2_staticBody)continue;i.Clear();let n=0;for(s[n++]=o,o.m_islandFlag=!0;n>0;){const e=s[--n];if(!e)throw new Error;if(i.AddBody(e),e.GetType()!==t.b2BodyType.b2_staticBody){e.m_awakeFlag=!0;for(let t=e.m_contactList;t;t=t.next){const e=t.contact;if(e.m_islandFlag)continue;if(!e.IsEnabled()||!e.IsTouching())continue;const o=e.m_fixtureA.m_isSensor,r=e.m_fixtureB.m_isSensor;if(o||r)continue;i.AddContact(e),e.m_islandFlag=!0;const a=t.other;a.m_islandFlag||(s[n++]=a,a.m_islandFlag=!0)}for(let t=e.m_jointList;t;t=t.next){if(t.joint.m_islandFlag)continue;const e=t.other;e.IsEnabled()&&(i.AddJoint(t.joint),t.joint.m_islandFlag=!0,e.m_islandFlag||(s[n++]=e,e.m_islandFlag=!0))}}}const r=new b2Profile;i.Solve(r,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=r.solveInit,this.m_profile.solveVelocity+=r.solveVelocity,this.m_profile.solvePosition+=r.solvePosition;for(let e=0;e<i.m_bodyCount;++e){const s=i.m_bodies[e];s.GetType()===t.b2BodyType.b2_staticBody&&(s.m_islandFlag=!1)}}for(let t=0;t<s.length&&s[t];++t)s[t]=null;const o=new b2Timer;for(let e=this.m_bodyList;e;e=e.m_next)e.m_islandFlag&&e.GetType()!==t.b2BodyType.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=o.GetMilliseconds()}SolveTOI(e){const i=this.m_island;if(i.Initialize(64,32,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1,t.m_sweep.alpha0=0;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_toiFlag=!1,t.m_islandFlag=!1,t.m_toiCount=0,t.m_toi=1}for(;;){let s=null,o=1;for(let e=this.m_contactManager.m_contactList;e;e=e.m_next){if(!e.IsEnabled())continue;if(e.m_toiCount>8)continue;let i=1;if(e.m_toiFlag)i=e.m_toi;else{const s=e.GetFixtureA(),o=e.GetFixtureB();if(s.IsSensor()||o.IsSensor())continue;const n=s.GetBody(),r=o.GetBody(),a=n.m_type,h=r.m_type,l=n.IsAwake()&&a!==t.b2BodyType.b2_staticBody,_=r.IsAwake()&&h!==t.b2BodyType.b2_staticBody;if(!l&&!_)continue;const m=n.IsBullet()||a!==t.b2BodyType.b2_dynamicBody,c=r.IsBullet()||h!==t.b2BodyType.b2_dynamicBody;if(!m&&!c)continue;let b=n.m_sweep.alpha0;n.m_sweep.alpha0<r.m_sweep.alpha0?(b=r.m_sweep.alpha0,n.m_sweep.Advance(b)):r.m_sweep.alpha0<n.m_sweep.alpha0&&(b=n.m_sweep.alpha0,r.m_sweep.Advance(b));const u=e.GetChildIndexA(),d=e.GetChildIndexB(),p=b2World.SolveTOI_s_toi_input;p.proxyA.SetShape(s.GetShape(),u),p.proxyB.SetShape(o.GetShape(),d),p.sweepA.Copy(n.m_sweep),p.sweepB.Copy(r.m_sweep),p.tMax=1;const y=b2World.SolveTOI_s_toi_output;b2TimeOfImpact(y,p);const V=y.t;i=y.state===t.b2TOIOutputState.e_touching?b2Min(b+(1-b)*V,1):1,e.m_toi=i,e.m_toiFlag=!0}i<o&&(s=e,o=i)}if(null===s||.9999<o){this.m_stepComplete=!0;break}const n=s.GetFixtureA(),r=s.GetFixtureB(),a=n.GetBody(),h=r.GetBody(),l=b2World.SolveTOI_s_backup1.Copy(a.m_sweep),_=b2World.SolveTOI_s_backup2.Copy(h.m_sweep);if(a.Advance(o),h.Advance(o),s.Update(this.m_contactManager.m_contactListener),s.m_toiFlag=!1,++s.m_toiCount,!s.IsEnabled()||!s.IsTouching()){s.SetEnabled(!1),a.m_sweep.Copy(l),h.m_sweep.Copy(_),a.SynchronizeTransform(),h.SynchronizeTransform();continue}a.SetAwake(!0),h.SetAwake(!0),i.Clear(),i.AddBody(a),i.AddBody(h),i.AddContact(s),a.m_islandFlag=!0,h.m_islandFlag=!0,s.m_islandFlag=!0;for(let e=0;e<2;++e){const s=0===e?a:h;if(s.m_type===t.b2BodyType.b2_dynamicBody)for(let e=s.m_contactList;e&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;e=e.next){const n=e.contact;if(n.m_islandFlag)continue;const r=e.other;if(r.m_type===t.b2BodyType.b2_dynamicBody&&!s.IsBullet()&&!r.IsBullet())continue;const a=n.m_fixtureA.m_isSensor,h=n.m_fixtureB.m_isSensor;if(a||h)continue;const l=b2World.SolveTOI_s_backup.Copy(r.m_sweep);r.m_islandFlag||r.Advance(o),n.Update(this.m_contactManager.m_contactListener),n.IsEnabled()&&n.IsTouching()?(n.m_islandFlag=!0,i.AddContact(n),r.m_islandFlag||(r.m_islandFlag=!0,r.m_type!==t.b2BodyType.b2_staticBody&&r.SetAwake(!0),i.AddBody(r))):(r.m_sweep.Copy(l),r.SynchronizeTransform())}}const m=b2World.SolveTOI_s_subStep;m.dt=(1-o)*e.dt,m.inv_dt=1/m.dt,m.dtRatio=1,m.positionIterations=20,m.velocityIterations=e.velocityIterations,m.warmStarting=!1,i.SolveTOI(m,a.m_islandIndex,h.m_islandIndex);for(let e=0;e<i.m_bodyCount;++e){const s=i.m_bodies[e];if(s.m_islandFlag=!1,s.m_type===t.b2BodyType.b2_dynamicBody){s.SynchronizeFixtures();for(let t=s.m_contactList;t;t=t.next)t.contact.m_toiFlag=!1,t.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}}var be,ue;b2World.Step_s_step=new b2TimeStep,b2World.Step_s_stepTimer=new b2Timer,b2World.Step_s_timer=new b2Timer,b2World.DebugDraw_s_color=new b2Color(0,0,0),b2World.DebugDraw_s_vs=b2Vec2.MakeArray(4),b2World.DebugDraw_s_xf=new b2Transform,b2World.QueryFixtureShape_s_aabb=new b2AABB,b2World.RayCast_s_input=new b2RayCastInput,b2World.RayCast_s_output=new b2RayCastOutput,b2World.RayCast_s_point=new b2Vec2,b2World.SolveTOI_s_subStep=new b2TimeStep,b2World.SolveTOI_s_backup=new b2Sweep,b2World.SolveTOI_s_backup1=new b2Sweep,b2World.SolveTOI_s_backup2=new b2Sweep,b2World.SolveTOI_s_toi_input=new b2TOIInput,b2World.SolveTOI_s_toi_output=new b2TOIOutput,t.b2StretchingModel=void 0,(be=t.b2StretchingModel||(t.b2StretchingModel={}))[be.b2_pbdStretchingModel=0]="b2_pbdStretchingModel",be[be.b2_xpbdStretchingModel=1]="b2_xpbdStretchingModel",t.b2BendingModel=void 0,(ue=t.b2BendingModel||(t.b2BendingModel={}))[ue.b2_springAngleBendingModel=0]="b2_springAngleBendingModel",ue[ue.b2_pbdAngleBendingModel=1]="b2_pbdAngleBendingModel",ue[ue.b2_xpbdAngleBendingModel=2]="b2_xpbdAngleBendingModel",ue[ue.b2_pbdDistanceBendingModel=3]="b2_pbdDistanceBendingModel",ue[ue.b2_pbdHeightBendingModel=4]="b2_pbdHeightBendingModel",ue[ue.b2_pbdTriangleBendingModel=5]="b2_pbdTriangleBendingModel";class b2RopeTuning{constructor(){this.stretchingModel=t.b2StretchingModel.b2_pbdStretchingModel,this.bendingModel=t.b2BendingModel.b2_pbdAngleBendingModel,this.damping=0,this.stretchStiffness=1,this.stretchHertz=0,this.stretchDamping=0,this.bendStiffness=.5,this.bendHertz=1,this.bendDamping=0,this.isometric=!1,this.fixedEffectiveMass=!1,this.warmStart=!1}Copy(t){return this.stretchingModel=t.stretchingModel,this.bendingModel=t.bendingModel,this.damping=t.damping,this.stretchStiffness=t.stretchStiffness,this.stretchHertz=t.stretchHertz,this.stretchDamping=t.stretchDamping,this.bendStiffness=t.bendStiffness,this.bendHertz=t.bendHertz,this.bendDamping=t.bendDamping,this.isometric=t.isometric,this.fixedEffectiveMass=t.fixedEffectiveMass,this.warmStart=t.warmStart,this}}class b2RopeStretch{constructor(){this.i1=0,this.i2=0,this.invMass1=0,this.invMass2=0,this.L=0,this.lambda=0,this.spring=0,this.damper=0}}class b2RopeBend{constructor(){this.i1=0,this.i2=0,this.i3=0,this.invMass1=0,this.invMass2=0,this.invMass3=0,this.invEffectiveMass=0,this.lambda=0,this.L1=0,this.L2=0,this.alpha1=0,this.alpha2=0,this.spring=0,this.damper=0}}const de=t.b2BodyType.b2_staticBody,pe=t.b2BodyType.b2_kinematicBody,ye=t.b2BodyType.b2_dynamicBody,Ve=t.b2BendingModel.b2_springAngleBendingModel,xe=t.b2BendingModel.b2_pbdAngleBendingModel,Se=t.b2BendingModel.b2_xpbdAngleBendingModel,fe=t.b2BendingModel.b2_pbdDistanceBendingModel,Ae=t.b2BendingModel.b2_pbdHeightBendingModel,Ce=t.b2BendingModel.b2_pbdTriangleBendingModel,we=t.b2StretchingModel.b2_pbdStretchingModel,ge=t.b2StretchingModel.b2_xpbdStretchingModel;return t.b2AABB=b2AABB,t.b2Abs=S,t.b2Acos=B,t.b2Alloc=function(t){return null},t.b2AngularStiffness=function(t,e,i,s,o){const r=s.GetInertia(),a=o.GetInertia();let h;h=r>0&&a>0?r*a/(r+a):r>0?r:a;const l=2*n*e;t.stiffness=h*l*l,t.damping=2*h*i*l},t.b2AreaJoint=b2AreaJoint,t.b2AreaJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_areaJoint),this.bodies=[],this.stiffness=0,this.damping=0}AddBody(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)}},t.b2Asin=v,t.b2Assert=function(t,...e){if(!t)throw new Error(...e)},t.b2Atan2=M,t.b2BlockAllocator=class{},t.b2Body=b2Body,t.b2BodyDef=class{constructor(){this.type=t.b2BodyType.b2_staticBody,this.position=new b2Vec2(0,0),this.angle=0,this.linearVelocity=new b2Vec2(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.enabled=!0,this.userData=null,this.gravityScale=1}},t.b2BroadPhase=b2BroadPhase,t.b2ChainAndCircleContact=b2ChainAndCircleContact,t.b2ChainAndPolygonContact=b2ChainAndPolygonContact,t.b2ChainShape=b2ChainShape,t.b2CircleContact=b2CircleContact,t.b2CircleShape=b2CircleShape,t.b2Clamp=b2Clamp,t.b2ClipSegmentToLine=b2ClipSegmentToLine,t.b2ClipVertex=b2ClipVertex,t.b2CollideCircles=b2CollideCircles,t.b2CollideEdgeAndCircle=b2CollideEdgeAndCircle,t.b2CollideEdgeAndPolygon=b2CollideEdgeAndPolygon,t.b2CollidePolygonAndCircle=b2CollidePolygonAndCircle,t.b2CollidePolygons=b2CollidePolygons,t.b2Color=b2Color,t.b2Contact=b2Contact,t.b2ContactEdge=b2ContactEdge,t.b2ContactFactory=b2ContactFactory,t.b2ContactFeature=b2ContactFeature,t.b2ContactFilter=b2ContactFilter,t.b2ContactID=b2ContactID,t.b2ContactImpulse=b2ContactImpulse,t.b2ContactListener=b2ContactListener,t.b2ContactManager=b2ContactManager,t.b2ContactPositionConstraint=b2ContactPositionConstraint,t.b2ContactRegister=b2ContactRegister,t.b2ContactSolver=b2ContactSolver,t.b2ContactSolverDef=b2ContactSolverDef,t.b2ContactVelocityConstraint=b2ContactVelocityConstraint,t.b2Cos=w,t.b2Counter=class{constructor(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}GetCount(){return this.m_count}GetMinCount(){return this.m_min_count}GetMaxCount(){return this.m_max_count}ResetCount(){const t=this.m_count;return this.m_count=0,t}ResetMinCount(){this.m_min_count=0}ResetMaxCount(){this.m_max_count=0}Increment(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}Decrement(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}},t.b2DegToRad=function(t){return t*y},t.b2DestructionListener=class{SayGoodbyeJoint(t){}SayGoodbyeFixture(t){}},t.b2Distance=b2Distance,t.b2DistanceInput=b2DistanceInput,t.b2DistanceJoint=b2DistanceJoint,t.b2DistanceJointDef=b2DistanceJointDef,t.b2DistanceOutput=b2DistanceOutput,t.b2DistanceProxy=b2DistanceProxy,t.b2Draw=class{constructor(){this.m_drawFlags=0}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}},t.b2DynamicTree=b2DynamicTree,t.b2EdgeAndCircleContact=b2EdgeAndCircleContact,t.b2EdgeAndPolygonContact=b2EdgeAndPolygonContact,t.b2EdgeShape=b2EdgeShape,t.b2Filter=b2Filter,t.b2Fixture=b2Fixture,t.b2FixtureDef=b2FixtureDef,t.b2FixtureProxy=b2FixtureProxy,t.b2Free=function(t){},t.b2FrictionJoint=b2FrictionJoint,t.b2FrictionJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_frictionJoint),this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.maxForce=0,this.maxTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}},t.b2GearJoint=b2GearJoint,t.b2GearJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_gearJoint),this.ratio=1}},t.b2GetPointStates=function(e,i,s,o){let n;for(n=0;n<s.pointCount;++n){const i=s.points[n].id.key;e[n]=t.b2PointState.b2_removeState;for(let s=0,r=o.pointCount;s<r;++s)if(o.points[s].id.key===i){e[n]=t.b2PointState.b2_persistState;break}}for(;n<2;++n)e[n]=t.b2PointState.b2_nullState;for(n=0;n<o.pointCount;++n){const e=o.points[n].id.key;i[n]=t.b2PointState.b2_addState;for(let o=0,r=s.pointCount;o<r;++o)if(s.points[o].id.key===e){i[n]=t.b2PointState.b2_persistState;break}}for(;n<2;++n)i[n]=t.b2PointState.b2_nullState},t.b2GrowableStack=b2GrowableStack,t.b2InvSqrt=function(t){return 1/Math.sqrt(t)},t.b2IsPowerOfTwo=function(t){return t>0&&0==(t&t-1)},t.b2IsValid=f,t.b2Island=b2Island,t.b2Jacobian=class{constructor(){this.linear=new b2Vec2,this.angularA=0,this.angularB=0}SetZero(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}Set(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this}},t.b2Joint=b2Joint,t.b2JointDef=b2JointDef,t.b2JointEdge=b2JointEdge,t.b2LinearStiffness=function(t,e,i,s,o){const r=s.GetMass(),a=o.GetMass();let h;h=r>0&&a>0?r*a/(r+a):r>0?r:a;const l=2*n*e;t.stiffness=h*l*l,t.damping=2*h*i*l},t.b2Log=function(t,...e){},t.b2MakeArray=b2MakeArray,t.b2MakeNullArray=function(t){const e=new Array(t);for(let i=0;i<t;++i)e[i]=null;return e},t.b2MakeNumberArray=b2MakeNumberArray,t.b2Manifold=b2Manifold,t.b2ManifoldPoint=b2ManifoldPoint,t.b2MassData=b2MassData,t.b2Mat22=b2Mat22,t.b2Mat33=b2Mat33,t.b2Max=b2Max,t.b2Maybe=b2Maybe,t.b2Min=b2Min,t.b2MixFriction=b2MixFriction,t.b2MixRestitution=b2MixRestitution,t.b2MixRestitutionThreshold=b2MixRestitutionThreshold,t.b2MotorJoint=b2MotorJoint,t.b2MotorJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_motorJoint),this.linearOffset=new b2Vec2(0,0),this.angularOffset=0,this.maxForce=1,this.maxTorque=1,this.correctionFactor=.3}Initialize(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);const i=this.bodyA.GetAngle(),s=this.bodyB.GetAngle();this.angularOffset=s-i}},t.b2MouseJoint=b2MouseJoint,t.b2MouseJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_mouseJoint),this.target=new b2Vec2,this.maxForce=0,this.stiffness=5,this.damping=.7}},t.b2NextPowerOfTwo=function(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,t|=t>>8&16777215,(t|=t>>16&65535)+1},t.b2Pair=b2Pair,t.b2ParseInt=function(t){return parseInt(t,10)},t.b2ParseUInt=function(t){return Math.abs(parseInt(t,10))},t.b2PolygonAndCircleContact=b2PolygonAndCircleContact,t.b2PolygonContact=b2PolygonContact,t.b2PolygonShape=b2PolygonShape,t.b2Position=b2Position,t.b2PositionSolverManifold=b2PositionSolverManifold,t.b2Pow=C,t.b2PrismaticJoint=b2PrismaticJoint,t.b2PrismaticJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_prismaticJoint),this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.localAxisA=new b2Vec2(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(s,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}},t.b2Profile=b2Profile,t.b2PulleyJoint=b2PulleyJoint,t.b2PulleyJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_pulleyJoint),this.groundAnchorA=new b2Vec2(-1,1),this.groundAnchorB=new b2Vec2(1,1),this.localAnchorA=new b2Vec2(-1,0),this.localAnchorB=new b2Vec2(1,0),this.lengthA=0,this.lengthB=0,this.ratio=1,this.collideConnected=!0}Initialize(t,e,i,s,o,n,r){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(s),this.bodyA.GetLocalPoint(o,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.lengthA=b2Vec2.DistanceVV(o,i),this.lengthB=b2Vec2.DistanceVV(n,s),this.ratio=r}},t.b2QueryCallback=b2QueryCallback,t.b2RadToDeg=function(t){return t*V},t.b2Random=function(){return 2*Math.random()-1},t.b2RandomRange=function(t,e){return(e-t)*Math.random()+t},t.b2RayCastCallback=b2RayCastCallback,t.b2RayCastInput=b2RayCastInput,t.b2RayCastOutput=b2RayCastOutput,t.b2RevoluteJoint=b2RevoluteJoint,t.b2RevoluteJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_revoluteJoint),this.localAnchorA=new b2Vec2(0,0),this.localAnchorB=new b2Vec2(0,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerAngle=0,this.upperAngle=0,this.enableMotor=!1,this.motorSpeed=0,this.maxMotorTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}},t.b2Rope=class{constructor(){this.m_position=new b2Vec2,this.m_count=0,this.m_stretchCount=0,this.m_bendCount=0,this.m_stretchConstraints=[],this.m_bendConstraints=[],this.m_bindPositions=[],this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_invMasses=[],this.m_gravity=new b2Vec2,this.m_tuning=new b2RopeTuning}Create(t){function make_array(t,e,i){for(let s=0;s<e;++s)t[s]=i(s)}this.m_position.Copy(t.position),this.m_count=t.count,make_array(this.m_bindPositions,this.m_count,(()=>new b2Vec2)),make_array(this.m_ps,this.m_count,(()=>new b2Vec2)),make_array(this.m_p0s,this.m_count,(()=>new b2Vec2)),make_array(this.m_vs,this.m_count,(()=>new b2Vec2)),make_array(this.m_invMasses,this.m_count,(()=>0));for(let e=0;e<this.m_count;++e){this.m_bindPositions[e].Copy(t.vertices[e]),this.m_ps[e].Copy(t.vertices[e]).SelfAdd(this.m_position),this.m_p0s[e].Copy(t.vertices[e]).SelfAdd(this.m_position),this.m_vs[e].SetZero();const i=t.masses[e];this.m_invMasses[e]=i>0?1/i:0}this.m_stretchCount=this.m_count-1,this.m_bendCount=this.m_count-2,make_array(this.m_stretchConstraints,this.m_stretchCount,(()=>new b2RopeStretch)),make_array(this.m_bendConstraints,this.m_bendCount,(()=>new b2RopeBend));for(let t=0;t<this.m_stretchCount;++t){const e=this.m_stretchConstraints[t],i=this.m_ps[t],s=this.m_ps[t+1];e.i1=t,e.i2=t+1,e.L=b2Vec2.DistanceVV(i,s),e.invMass1=this.m_invMasses[t],e.invMass2=this.m_invMasses[t+1],e.lambda=0,e.damper=0,e.spring=0}for(let t=0;t<this.m_bendCount;++t){const e=this.m_bendConstraints[t],i=this.m_ps[t],s=this.m_ps[t+1],o=this.m_ps[t+2];e.i1=t,e.i2=t+1,e.i3=t+2,e.invMass1=this.m_invMasses[t],e.invMass2=this.m_invMasses[t+1],e.invMass3=this.m_invMasses[t+2],e.invEffectiveMass=0,e.L1=b2Vec2.DistanceVV(i,s),e.L2=b2Vec2.DistanceVV(s,o),e.lambda=0;const n=b2Vec2.SubVV(s,i,new b2Vec2),r=b2Vec2.SubVV(o,s,new b2Vec2),a=n.LengthSquared(),h=r.LengthSquared();if(a*h==0)continue;const l=(new b2Vec2).Copy(n).SelfSkew().SelfMul(-1/a),_=(new b2Vec2).Copy(r).SelfSkew().SelfMul(1/h),m=l.Clone().SelfNeg(),c=l.Clone().SelfSub(_),b=_.Clone();e.invEffectiveMass=e.invMass1*b2Vec2.DotVV(m,m)+e.invMass2*b2Vec2.DotVV(c,c)+e.invMass3*b2Vec2.DotVV(b,b);const u=b2Vec2.SubVV(o,i,new b2Vec2),d=u.LengthSquared();0!==d&&(e.alpha1=b2Vec2.DotVV(r,u)/d,e.alpha2=b2Vec2.DotVV(n,u)/d)}this.m_gravity.Copy(t.gravity),this.SetTuning(t.tuning)}SetTuning(t){this.m_tuning.Copy(t);const e=2*n*this.m_tuning.bendHertz;for(let t=0;t<this.m_bendCount;++t){const i=this.m_bendConstraints[t],s=i.L1*i.L1,o=i.L2*i.L2;if(s*o==0){i.spring=0,i.damper=0;continue}const n=1/i.L1+1/i.L2,r=i.invMass1/s+i.invMass2*n*n+i.invMass3/o;if(0===r){i.spring=0,i.damper=0;continue}const a=1/r;i.spring=a*e*e,i.damper=2*a*this.m_tuning.bendDamping*e}const i=2*n*this.m_tuning.stretchHertz;for(let t=0;t<this.m_stretchCount;++t){const e=this.m_stretchConstraints[t],s=e.invMass1+e.invMass2;if(0===s)continue;const o=1/s;e.spring=o*i*i,e.damper=2*o*this.m_tuning.stretchDamping*i}}Step(e,i,s){if(0===e)return;const o=1/e,n=Math.exp(-e*this.m_tuning.damping);for(let t=0;t<this.m_count;++t)this.m_invMasses[t]>0?(this.m_vs[t].x*=n,this.m_vs[t].y*=n,this.m_vs[t].x+=e*this.m_gravity.x,this.m_vs[t].y+=e*this.m_gravity.y):(this.m_vs[t].x=o*(this.m_bindPositions[t].x+s.x-this.m_p0s[t].x),this.m_vs[t].y=o*(this.m_bindPositions[t].y+s.y-this.m_p0s[t].y));this.m_tuning.bendingModel===t.b2BendingModel.b2_springAngleBendingModel&&this.ApplyBendForces(e);for(let t=0;t<this.m_bendCount;++t)this.m_bendConstraints[t].lambda=0;for(let t=0;t<this.m_stretchCount;++t)this.m_stretchConstraints[t].lambda=0;for(let t=0;t<this.m_count;++t)this.m_ps[t].x+=e*this.m_vs[t].x,this.m_ps[t].y+=e*this.m_vs[t].y;for(let s=0;s<i;++s)this.m_tuning.bendingModel===t.b2BendingModel.b2_pbdAngleBendingModel?this.SolveBend_PBD_Angle():this.m_tuning.bendingModel===t.b2BendingModel.b2_xpbdAngleBendingModel?this.SolveBend_XPBD_Angle(e):this.m_tuning.bendingModel===t.b2BendingModel.b2_pbdDistanceBendingModel?this.SolveBend_PBD_Distance():this.m_tuning.bendingModel===t.b2BendingModel.b2_pbdHeightBendingModel?this.SolveBend_PBD_Height():this.m_tuning.bendingModel===t.b2BendingModel.b2_pbdTriangleBendingModel&&this.SolveBend_PBD_Triangle(),this.m_tuning.stretchingModel===t.b2StretchingModel.b2_pbdStretchingModel?this.SolveStretch_PBD():this.m_tuning.stretchingModel===t.b2StretchingModel.b2_xpbdStretchingModel&&this.SolveStretch_XPBD(e);for(let t=0;t<this.m_count;++t)this.m_vs[t].x=o*(this.m_ps[t].x-this.m_p0s[t].x),this.m_vs[t].y=o*(this.m_ps[t].y-this.m_p0s[t].y),this.m_p0s[t].Copy(this.m_ps[t])}Reset(t){this.m_position.Copy(t);for(let t=0;t<this.m_count;++t)this.m_ps[t].x=this.m_bindPositions[t].x+this.m_position.x,this.m_ps[t].y=this.m_bindPositions[t].y+this.m_position.y,this.m_p0s[t].x=this.m_bindPositions[t].x+this.m_position.x,this.m_p0s[t].y=this.m_bindPositions[t].y+this.m_position.y,this.m_vs[t].SetZero();for(let t=0;t<this.m_bendCount;++t)this.m_bendConstraints[t].lambda=0;for(let t=0;t<this.m_stretchCount;++t)this.m_stretchConstraints[t].lambda=0}Draw(t){const e=new b2Color(.4,.5,.7),i=new b2Color(.1,.8,.1),s=new b2Color(.7,.2,.4);for(let o=0;o<this.m_count-1;++o){t.DrawSegment(this.m_ps[o],this.m_ps[o+1],e);const n=this.m_invMasses[o]>0?s:i;t.DrawPoint(this.m_ps[o],5,n)}const o=this.m_invMasses[this.m_count-1]>0?s:i;t.DrawPoint(this.m_ps[this.m_count-1],5,o)}SolveStretch_PBD(){const t=this.m_tuning.stretchStiffness;for(let e=0;e<this.m_stretchCount;++e){const i=this.m_stretchConstraints[e],s=this.m_ps[i.i1].Clone(),o=this.m_ps[i.i2].Clone(),n=o.Clone().SelfSub(s),r=n.Normalize(),a=i.invMass1+i.invMass2;if(0===a)continue;const h=i.invMass1/a,l=i.invMass2/a;s.x-=t*h*(i.L-r)*n.x,s.y-=t*h*(i.L-r)*n.y,o.x+=t*l*(i.L-r)*n.x,o.y+=t*l*(i.L-r)*n.y,this.m_ps[i.i1].Copy(s),this.m_ps[i.i2].Copy(o)}}SolveStretch_XPBD(t){for(let e=0;e<this.m_stretchCount;++e){const i=this.m_stretchConstraints[e],s=this.m_ps[i.i1].Clone(),o=this.m_ps[i.i2].Clone(),n=s.Clone().SelfSub(this.m_p0s[i.i1]),r=o.Clone().SelfSub(this.m_p0s[i.i2]),a=o.Clone().SelfSub(s),h=a.Normalize(),l=a.Clone().SelfNeg(),_=a,m=i.invMass1+i.invMass2;if(0===m)continue;const c=1/(i.spring*t*t),b=c*(t*t*i.damper)/t,u=h-i.L,d=b2Vec2.DotVV(l,n)+b2Vec2.DotVV(_,r),p=-(u+c*i.lambda+b*d)/((1+b)*m+c);s.x+=i.invMass1*p*l.x,s.y+=i.invMass1*p*l.y,o.x+=i.invMass2*p*_.x,o.y+=i.invMass2*p*_.y,this.m_ps[i.i1].Copy(s),this.m_ps[i.i2].Copy(o),i.lambda+=p}}SolveBend_PBD_Angle(){const t=this.m_tuning.bendStiffness;for(let e=0;e<this.m_bendCount;++e){const i=this.m_bendConstraints[e],s=this.m_ps[i.i1],o=this.m_ps[i.i2],n=this.m_ps[i.i3],r=o.Clone().SelfSub(s),a=n.Clone().SelfSub(o),h=b2Vec2.CrossVV(r,a),l=b2Vec2.DotVV(r,a),_=M(h,l);let m=0,c=0;if(this.m_tuning.isometric?(m=i.L1*i.L1,c=i.L2*i.L2):(m=r.LengthSquared(),c=a.LengthSquared()),m*c==0)continue;const b=(new b2Vec2).Copy(r).SelfSkew().SelfMul(-1/m),u=(new b2Vec2).Copy(a).SelfSkew().SelfMul(1/c),d=b.Clone().SelfNeg(),p=b.Clone().SelfSub(u),y=u;let V=0;V=this.m_tuning.fixedEffectiveMass?i.invEffectiveMass:i.invMass1*b2Vec2.DotVV(d,d)+i.invMass2*b2Vec2.DotVV(p,p)+i.invMass3*b2Vec2.DotVV(y,y),0===V&&(V=i.invEffectiveMass);const x=-t*_/V;s.x+=i.invMass1*x*d.x,s.y+=i.invMass1*x*d.y,o.x+=i.invMass2*x*p.x,o.y+=i.invMass2*x*p.y,n.x+=i.invMass3*x*y.x,n.y+=i.invMass3*x*y.y,this.m_ps[i.i1].Copy(s),this.m_ps[i.i2].Copy(o),this.m_ps[i.i3].Copy(n)}}SolveBend_XPBD_Angle(t){for(let e=0;e<this.m_bendCount;++e){const i=this.m_bendConstraints[e],s=this.m_ps[i.i1],o=this.m_ps[i.i2],n=this.m_ps[i.i3],r=s.Clone().SelfSub(this.m_p0s[i.i1]),a=o.Clone().SelfSub(this.m_p0s[i.i2]),h=n.Clone().SelfSub(this.m_p0s[i.i3]),l=o.Clone().SelfSub(s),_=n.Clone().SelfSub(o);let m,c;if(this.m_tuning.isometric?(m=i.L1*i.L1,c=i.L2*i.L2):(m=l.LengthSquared(),c=_.LengthSquared()),m*c==0)continue;const b=b2Vec2.CrossVV(l,_),u=b2Vec2.DotVV(l,_),d=M(b,u),p=(new b2Vec2).Copy(l).SelfSkew().SelfMul(-1/m),y=(new b2Vec2).Copy(_).SelfSkew().SelfMul(1/c),V=p.Clone().SelfNeg(),x=p.Clone().SelfSub(y),S=y;let f;if(f=this.m_tuning.fixedEffectiveMass?i.invEffectiveMass:i.invMass1*b2Vec2.DotVV(V,V)+i.invMass2*b2Vec2.DotVV(x,x)+i.invMass3*b2Vec2.DotVV(S,S),0===f)continue;const A=1/(i.spring*t*t),C=A*(t*t*i.damper)/t,w=d,g=b2Vec2.DotVV(V,r)+b2Vec2.DotVV(x,a)+b2Vec2.DotVV(S,h),B=-(w+A*i.lambda+C*g)/((1+C)*f+A);s.x+=i.invMass1*B*V.x,s.y+=i.invMass1*B*V.y,o.x+=i.invMass2*B*x.x,o.y+=i.invMass2*B*x.y,n.x+=i.invMass3*B*S.x,n.y+=i.invMass3*B*S.y,this.m_ps[i.i1].Copy(s),this.m_ps[i.i2].Copy(o),this.m_ps[i.i3].Copy(n),i.lambda+=B}}SolveBend_PBD_Distance(){const t=this.m_tuning.bendStiffness;for(let e=0;e<this.m_bendCount;++e){const i=this.m_bendConstraints[e],s=i.i1,o=i.i3,n=this.m_ps[s].Clone(),r=this.m_ps[o].Clone(),a=r.Clone().SelfSub(n),h=a.Normalize(),l=i.invMass1+i.invMass3;if(0===l)continue;const _=i.invMass1/l,m=i.invMass3/l;n.x-=t*_*(i.L1+i.L2-h)*a.x,n.y-=t*_*(i.L1+i.L2-h)*a.y,r.x+=t*m*(i.L1+i.L2-h)*a.x,r.y+=t*m*(i.L1+i.L2-h)*a.y,this.m_ps[s].Copy(n),this.m_ps[o].Copy(r)}}SolveBend_PBD_Height(){const t=this.m_tuning.bendStiffness;for(let e=0;e<this.m_bendCount;++e){const i=this.m_bendConstraints[e],s=this.m_ps[i.i1].Clone(),o=this.m_ps[i.i2].Clone(),n=this.m_ps[i.i3].Clone(),r=new b2Vec2;r.x=i.alpha1*s.x+i.alpha2*n.x-o.x,r.y=i.alpha1*s.y+i.alpha2*n.y-o.y;const a=r.Length();if(0===a)continue;const h=r.Clone().SelfMul(1/a),l=h.Clone().SelfMul(i.alpha1),_=h.Clone().SelfNeg(),m=h.Clone().SelfMul(i.alpha2),c=i.invMass1*i.alpha1*i.alpha1+i.invMass2+i.invMass3*i.alpha2*i.alpha2;if(0===c)continue;const b=-t*(1/c)*a;s.x+=i.invMass1*b*l.x,s.y+=i.invMass1*b*l.y,o.x+=i.invMass2*b*_.x,o.y+=i.invMass2*b*_.y,n.x+=i.invMass3*b*m.x,n.y+=i.invMass3*b*m.y,this.m_ps[i.i1].Copy(s),this.m_ps[i.i2].Copy(o),this.m_ps[i.i3].Copy(n)}}SolveBend_PBD_Triangle(){const t=this.m_tuning.bendStiffness;for(let e=0;e<this.m_bendCount;++e){const i=this.m_bendConstraints[e],s=this.m_ps[i.i1].Clone(),o=this.m_ps[i.i2].Clone(),n=this.m_ps[i.i3].Clone(),r=i.invMass1,a=i.invMass2,h=i.invMass3,l=t/(r+h+2*a),_=new b2Vec2;_.x=o.x-1/3*(s.x+o.x+n.x),_.y=o.y-1/3*(s.y+o.y+n.y);const m=new b2Vec2;m.x=2*r*l*_.x,m.y=2*r*l*_.y;const c=new b2Vec2;c.x=-4*a*l*_.x,c.y=-4*a*l*_.y;const b=new b2Vec2;b.x=2*h*l*_.x,b.y=2*h*l*_.y,s.SelfAdd(m),o.SelfAdd(c),n.SelfAdd(b),this.m_ps[i.i1].Copy(s),this.m_ps[i.i2].Copy(o),this.m_ps[i.i3].Copy(n)}}ApplyBendForces(t){const e=2*n*this.m_tuning.bendHertz;for(let i=0;i<this.m_bendCount;++i){const s=this.m_bendConstraints[i],o=this.m_ps[s.i1].Clone(),n=this.m_ps[s.i2].Clone(),r=this.m_ps[s.i3].Clone(),a=this.m_vs[s.i1],h=this.m_vs[s.i2],l=this.m_vs[s.i3],_=o.Clone().SelfSub(o),m=r.Clone().SelfSub(n);let c,b;if(this.m_tuning.isometric?(c=s.L1*s.L1,b=s.L2*s.L2):(c=_.LengthSquared(),b=m.LengthSquared()),c*b==0)continue;const u=b2Vec2.CrossVV(_,m),d=b2Vec2.DotVV(_,m),p=M(u,d),y=(new b2Vec2).Copy(_).SelfSkew().SelfMul(-1/c),V=(new b2Vec2).Copy(m).SelfSkew().SelfMul(1/b),x=y.Clone().SelfNeg(),S=y.Clone().SelfSub(V),f=V;let A=0;if(A=this.m_tuning.fixedEffectiveMass?s.invEffectiveMass:s.invMass1*b2Vec2.DotVV(x,x)+s.invMass2*b2Vec2.DotVV(S,S)+s.invMass3*b2Vec2.DotVV(f,f),0===A)continue;const C=1/A,w=-t*(C*e*e*p+2*C*this.m_tuning.bendDamping*e*(b2Vec2.DotVV(x,a)+b2Vec2.DotVV(S,h)+b2Vec2.DotVV(f,l)));this.m_vs[s.i1].x+=s.invMass1*w*x.x,this.m_vs[s.i1].y+=s.invMass1*w*x.y,this.m_vs[s.i2].x+=s.invMass2*w*S.x,this.m_vs[s.i2].y+=s.invMass2*w*S.y,this.m_vs[s.i3].x+=s.invMass3*w*f.x,this.m_vs[s.i3].y+=s.invMass3*w*f.y}}},t.b2RopeDef=class{constructor(){this.position=new b2Vec2,this.vertices=[],this.count=0,this.masses=[],this.gravity=new b2Vec2,this.tuning=new b2RopeTuning}},t.b2RopeTuning=b2RopeTuning,t.b2Rot=b2Rot,t.b2SeparationFunction=b2SeparationFunction,t.b2Shape=b2Shape,t.b2ShapeCast=function(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();const i=e.proxyA,s=e.proxyB,o=b2Max(i.m_radius,l)+b2Max(s.m_radius,l),n=e.transformA,r=e.transformB,a=e.translationB,h=E.Set(0,0);let _=0;const m=j;m.m_count=0;const c=m.m_vertices;let b=i.GetSupport(b2Rot.MulTRV(n.q,b2Vec2.NegV(a,b2Vec2.s_t1),b2Vec2.s_t0)),u=b2Transform.MulXV(n,i.GetVertex(b),q),d=s.GetSupport(b2Rot.MulTRV(r.q,a,b2Vec2.s_t0)),p=b2Transform.MulXV(r,s.GetVertex(d),O);const y=b2Vec2.SubVV(u,p,z),V=b2Max(l,o-l);let x=0;for(;x<20&&y.Length()-V>.0025;){t.iterations+=1,b=i.GetSupport(b2Rot.MulTRV(n.q,b2Vec2.NegV(y,b2Vec2.s_t1),b2Vec2.s_t0)),u=b2Transform.MulXV(n,i.GetVertex(b),q),d=s.GetSupport(b2Rot.MulTRV(r.q,y,b2Vec2.s_t0)),p=b2Transform.MulXV(r,s.GetVertex(d),O);const e=b2Vec2.SubVV(u,p,X);y.Normalize();const o=b2Vec2.DotVV(y,e),l=b2Vec2.DotVV(y,a);if(o-V>_*l){if(l<=0)return!1;if(_=(o-V)/l,_>1)return!1;h.Copy(y).SelfNeg(),m.m_count=0}const S=c[m.m_count];switch(S.indexA=d,S.wA.Copy(p).SelfMulAdd(_,a),S.indexB=b,S.wB.Copy(u),S.w.Copy(S.wB).SelfSub(S.wA),S.a=1,m.m_count+=1,m.m_count){case 1:break;case 2:m.Solve2();break;case 3:m.Solve3()}if(3===m.m_count)return!1;m.GetClosestPoint(y),++x}if(0===x)return!1;const S=W,f=N;return m.GetWitnessPoints(S,f),y.LengthSquared()>0&&(h.Copy(y).SelfNeg(),h.Normalize()),t.normal.Copy(h),t.lambda=_,t.iterations=x,!0},t.b2ShapeCastInput=class{constructor(){this.proxyA=new b2DistanceProxy,this.proxyB=new b2DistanceProxy,this.transformA=new b2Transform,this.transformB=new b2Transform,this.translationB=new b2Vec2}},t.b2ShapeCastOutput=class{constructor(){this.point=new b2Vec2,this.normal=new b2Vec2,this.lambda=0,this.iterations=0}},t.b2Simplex=b2Simplex,t.b2SimplexCache=b2SimplexCache,t.b2SimplexVertex=b2SimplexVertex,t.b2Sin=g,t.b2SolverData=b2SolverData,t.b2Sq=b2Sq,t.b2Sqrt=A,t.b2StackAllocator=class{},t.b2Swap=function(t,e){const i=t[0];t[0]=e[0],e[0]=i},t.b2Sweep=b2Sweep,t.b2TOIInput=b2TOIInput,t.b2TOIOutput=b2TOIOutput,t.b2TestOverlapAABB=b2TestOverlapAABB,t.b2TestOverlapShape=b2TestOverlapShape,t.b2TimeOfImpact=b2TimeOfImpact,t.b2TimeStep=b2TimeStep,t.b2Timer=b2Timer,t.b2Transform=b2Transform,t.b2TreeNode=b2TreeNode,t.b2Vec2=b2Vec2,t.b2Vec2_zero=I,t.b2Vec3=b2Vec3,t.b2Velocity=b2Velocity,t.b2VelocityConstraintPoint=b2VelocityConstraintPoint,t.b2Version=b2Version,t.b2WeldJoint=b2WeldJoint,t.b2WeldJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_weldJoint),this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.referenceAngle=0,this.stiffness=0,this.damping=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}},t.b2WheelJoint=b2WheelJoint,t.b2WheelJointDef=class extends b2JointDef{constructor(){super(t.b2JointType.e_wheelJoint),this.localAnchorA=new b2Vec2(0,0),this.localAnchorB=new b2Vec2(0,0),this.localAxisA=new b2Vec2(1,0),this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorTorque=0,this.motorSpeed=0,this.stiffness=0,this.damping=0}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(s,this.localAxisA)}},t.b2World=b2World,t.b2WorldManifold=b2WorldManifold,t.b2_180_over_pi=V,t.b2_aabbExtension=r,t.b2_aabbMultiplier=4,t.b2_angularSleepTolerance=d,t.b2_angularSlop=h,t.b2_baumgarte=.2,t.b2_branch="master",t.b2_commit="9ebbbcd960ad424e03e5de6e66a40764c16f51bc",t.b2_epsilon=s,t.b2_epsilon_sq=o,t.b2_gjk_reset=function(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0},t.b2_lengthUnitsPerMeter=1,t.b2_linearSleepTolerance=u,t.b2_linearSlop=a,t.b2_maxAngularCorrection=m,t.b2_maxFloat=i,t.b2_maxLinearCorrection=_,t.b2_maxManifoldPoints=2,t.b2_maxPolygonVertices=8,t.b2_maxRotation=c,t.b2_maxRotationSquared=b,t.b2_maxSubSteps=8,t.b2_maxTOIContacts=32,t.b2_maxTranslation=2,t.b2_maxTranslationSquared=4,t.b2_minPulleyLength=2,t.b2_pi=n,t.b2_pi_over_180=y,t.b2_polygonRadius=l,t.b2_timeToSleep=.5,t.b2_toiBaumgarte=.75,t.b2_toi_reset=function(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0},t.b2_two_pi=x,t.b2_version=p,t.dynamicBody=ye,t.get_g_blockSolve=function(){return t.g_blockSolve},t.kinematicBody=pe,t.pbdAngleBendingModel=xe,t.pbdDistanceBendingModel=fe,t.pbdHeightBendingModel=Ae,t.pbdStretchingModel=we,t.pbdTriangleBendingModel=Ce,t.set_g_blockSolve=function(e){t.g_blockSolve=e},t.springAngleBendingModel=Ve,t.staticBody=de,t.xpbdAngleBendingModel=Se,t.xpbdStretchingModel=ge,Object.defineProperty(t,"__esModule",{value:!0}),t}({});!function(t,e){"use strict";class DestructionListener{SayGoodbyeJoint(t){t.m_userData&&(t.m_userData.isDestroy=!0)}SayGoodbyeFixture(t){}SayGoodbyeParticleGroup(t){}SayGoodbyeParticle(t){}}class Physics extends e.EventDispatcher{constructor(){super(),this.box2d=window.box2d,this.velocityIterations=8,this.positionIterations=3,this._eventList=[]}static get I(){return Physics._I||(Physics._I=new Physics)}static enable(t=null){Physics.I.start(t)}start(t=null){if(!this._enabled){this._enabled=!0,t||(t={});var i=window.box2d;if(null==i)return void console.error("Can not find box2d libs, you should request box2d.js first.");var s=new i.b2Vec2(0,t.gravity||500/Physics.PIXEL_RATIO);this.world=new i.b2World(s),this.world.SetDestructionListener(new DestructionListener),this.world.SetContactListener(new ContactListener),this.allowSleeping=null==t.allowSleeping||t.allowSleeping,!t.customUpdate&&e.LayaEnv.isPlaying&&e.ILaya.physicsTimer.frameLoop(1,this,this._update),this._emptyBody=this._createBody(new window.box2d.b2BodyDef)}}_update(){var t=e.ILaya.timer.delta/1e3;t>.033&&(t=.033),this.world.Step(t,this.velocityIterations,this.positionIterations,3);var i=this._eventList.length;if(i>0){for(var s=0;s<i;s+=2)this._sendEvent(this._eventList[s],this._eventList[s+1]);this._eventList.length=0}}_sendEvent(t,i){var s=i.GetFixtureA().collider,o=i.GetFixtureB().collider,n=s.owner,r=o.owner;if(i.getHitInfo=function(){var t=new this.box2d.b2WorldManifold;this.GetWorldManifold(t);var e=t.points[0];return e.x*=Physics.PIXEL_RATIO,e.y*=Physics.PIXEL_RATIO,t},n){var a=[o,s,i];0===t?(n.event(e.Event.TRIGGER_ENTER,a),n._triggered?n.event(e.Event.TRIGGER_STAY,a):n._triggered=!0):(n._triggered=!1,n.event(e.Event.TRIGGER_EXIT,a))}r&&(a=[s,o,i],0===t?(r.event(e.Event.TRIGGER_ENTER,a),r._triggered?r.event(e.Event.TRIGGER_STAY,a):r._triggered=!0):(r._triggered=!1,r.event(e.Event.TRIGGER_EXIT,a)))}_createBody(t){return this.world?this.world.CreateBody(t):(console.error('The physical engine should be initialized first.use "Physics.enable()"'),null)}_removeBody(t){this.world?this.world.DestroyBody(t):console.error('The physical engine should be initialized first.use "Physics.enable()"')}_createJoint(t){if(this.world){let e=this.world.CreateJoint(t);return e.m_userData={},e.m_userData.isDestroy=!1,e}return console.error('The physical engine should be initialized first.use "Physics.enable()"'),null}_removeJoint(t){this.world?this.world.DestroyJoint(t):console.error('The physical engine should be initialized first.use "Physics.enable()"')}stop(){e.ILaya.physicsTimer.clear(this,this._update)}get allowSleeping(){return this.world.GetAllowSleeping()}set allowSleeping(t){this.world.SetAllowSleeping(t)}get gravity(){return this.world.GetGravity()}set gravity(t){this.world.SetGravity(t)}getBodyCount(){return this.world.GetBodyCount()}getContactCount(){return this.world.GetContactCount()}getJointCount(){return this.world.GetJointCount()}get worldRoot(){return this._worldRoot||e.ILaya.stage}set worldRoot(t){if(this._worldRoot=t,t){var i=t.localToGlobal(e.Point.TEMP.setTo(0,0));this.world.ShiftOrigin({x:-i.x/Physics.PIXEL_RATIO,y:-i.y/Physics.PIXEL_RATIO})}}updatePhysicsByWorldRoot(){if(this.worldRoot){var t=this.worldRoot.localToGlobal(e.Point.TEMP.setTo(0,0));this.world.ShiftOrigin({x:-t.x/Physics.PIXEL_RATIO,y:-t.y/Physics.PIXEL_RATIO})}}}Physics.PIXEL_RATIO=50;class ContactListener{BeginContact(t){Physics.I._eventList.push(0,t)}EndContact(t){Physics.I._eventList.push(1,t)}PreSolve(t,e){}PostSolve(t,e){}}class RigidBody extends e.Component{constructor(){super(...arguments),this._type="dynamic",this._allowSleep=!0,this._angularVelocity=0,this._angularDamping=0,this._linearVelocity={x:0,y:0},this._linearDamping=0,this._bullet=!1,this._allowRotation=!0,this._gravityScale=1,this.group=0,this.category=1,this.mask=-1,this.label="RigidBody"}_createBody(){if(!this._body&&this.owner){var t=this.owner,i=window.box2d,s=new i.b2BodyDef,o=t.localToGlobal(e.Point.TEMP.setTo(0,0),!1,Physics.I.worldRoot);s.position.Set(o.x/Physics.PIXEL_RATIO,o.y/Physics.PIXEL_RATIO),s.angle=e.Utils.toRadian(t.rotation),s.allowSleep=this._allowSleep,s.angularDamping=this._angularDamping,s.angularVelocity=this._angularVelocity,s.bullet=this._bullet,s.fixedRotation=!this._allowRotation,s.gravityScale=this._gravityScale,s.linearDamping=this._linearDamping;var n=this._linearVelocity;(n&&0!=n.x||0!=n.y)&&(s.linearVelocity=new i.b2Vec2(n.x,n.y)),s.type=i.b2BodyType["b2_"+this._type+"Body"],this._body=Physics.I._createBody(s),this.resetCollider(!1)}}_onAwake(){this._createBody()}_onEnable(){var t=this;this._createBody();var e=this.owner;if(this.accessGetSetFunc(e,"x","set")&&!e._changeByRigidBody){function setX(i){t.accessGetSetFunc(e,"x","set")(i),t._sysPosToPhysic()}function setY(i){t.accessGetSetFunc(e,"y","set")(i),t._sysPosToPhysic()}function setRotation(i){t.accessGetSetFunc(e,"rotation","set")(i),t._sysNodeToPhysic()}function setScaleX(i){t.accessGetSetFunc(e,"scaleX","set")(i),t.resetCollider(!0)}function setScaleY(i){t.accessGetSetFunc(e,"scaleY","set")(i),t.resetCollider(!0)}e._changeByRigidBody=!0,this._overSet(e,"x",setX),this._overSet(e,"y",setY),this._overSet(e,"rotation",setRotation),this._overSet(e,"scaleX",setScaleX),this._overSet(e,"scaleY",setScaleY)}}accessGetSetFunc(t,e,i){if(-1===["get","set"].indexOf(i))return;let s=`_$${i}_${e}`;if(t[s])return t[s];let o,n=t.constructor;for(;n;){if(o=Object.getOwnPropertyDescriptor(n.prototype,e),o&&o[i]){t[s]=o[i].bind(t);break}n=Object.getPrototypeOf(n)}return t[s]}resetCollider(t){var e=this.owner.getComponents(ColliderBase);if(e)for(var i=0,s=e.length;i<s;i++){var o=e[i];o.rigidBody=this,t?o.resetShape():o.refresh()}}onUpdate(){if("static"!=this.type&&this._body.IsAwake()){var t=this._body.GetPosition(),i=this._body.GetAngle(),s=this.owner;this.accessGetSetFunc(s,"rotation","set")(e.Utils.toAngle(i)-s.parent.globalRotation);var o=s.globalToLocal(e.Point.TEMP.setTo(t.x*Physics.PIXEL_RATIO,t.y*Physics.PIXEL_RATIO),!1,Physics.I.worldRoot);o.x+=s.pivotX,o.y+=s.pivotY,o=s.toParentPoint(o),this.accessGetSetFunc(s,"x","set")(o.x),this.accessGetSetFunc(s,"y","set")(o.y)}}_sysNodeToPhysic(){var t=this.owner;this._body.SetAngle(e.Utils.toRadian(t.rotation));var i=t.localToGlobal(e.Point.TEMP.setTo(0,0),!1,Physics.I.worldRoot);this._body.SetPositionXY(i.x/Physics.PIXEL_RATIO,i.y/Physics.PIXEL_RATIO)}_sysPosToPhysic(){var t=this.owner.localToGlobal(e.Point.TEMP.setTo(0,0),!1,Physics.I.worldRoot);this._body.SetPositionXY(t.x/Physics.PIXEL_RATIO,t.y/Physics.PIXEL_RATIO)}_overSet(t,e,i){Object.defineProperty(t,e,{get:this.accessGetSetFunc(t,e,"get"),set:i,enumerable:!1,configurable:!0})}_onDisable(){this._body&&Physics.I._removeBody(this._body),this._body=null;var t=this.owner;t._changeByRigidBody&&(this._overSet(t,"x",this.accessGetSetFunc(t,"x","set")),this._overSet(t,"y",this.accessGetSetFunc(t,"y","set")),this._overSet(t,"rotation",this.accessGetSetFunc(t,"rotation","set")),this._overSet(t,"scaleX",this.accessGetSetFunc(t,"scaleX","set")),this._overSet(t,"scaleY",this.accessGetSetFunc(t,"scaleY","set")),t._changeByRigidBody=!1)}getBody(){return this._body||this._onAwake(),this._body}_getOriBody(){return this._body}get body(){return this._body||this._onAwake(),this._body}applyForce(t,e){this._body||this._onAwake(),this._body.ApplyForce(e,t)}applyForceToCenter(t){this._body||this._onAwake(),this._body.ApplyForceToCenter(t)}applyLinearImpulse(t,e){this._body||this._onAwake(),this._body.ApplyLinearImpulse(e,t)}applyLinearImpulseToCenter(t){this._body||this._onAwake(),this._body.ApplyLinearImpulseToCenter(t)}applyTorque(t){this._body||this._onAwake(),this._body.ApplyTorque(t)}setVelocity(t){this._body||this._onAwake(),this._body.SetLinearVelocity(t)}setAngle(t){this._body||this._onAwake(),this._body.SetAngle(t),this._body.SetAwake(!0)}getMass(){return this._body?this._body.GetMass():0}getCenter(){this._body||this._onAwake();var t=this._body.GetLocalCenter();return t.x=t.x*Physics.PIXEL_RATIO,t.y=t.y*Physics.PIXEL_RATIO,t}getWorldCenter(){this._body||this._onAwake();var t=this._body.GetWorldCenter();return t.x=t.x*Physics.PIXEL_RATIO,t.y=t.y*Physics.PIXEL_RATIO,t}get type(){return this._type}set type(t){this._type=t,this._body&&this._body.SetType(window.box2d.b2BodyType["b2_"+this._type+"Body"])}get gravityScale(){return this._gravityScale}set gravityScale(t){this._gravityScale=t,this._body&&this._body.SetGravityScale(t)}get allowRotation(){return this._allowRotation}set allowRotation(t){this._allowRotation=t,this._body&&this._body.SetFixedRotation(!t)}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this._body&&this._body.SetSleepingAllowed(t)}get angularDamping(){return this._angularDamping}set angularDamping(t){this._angularDamping=t,this._body&&this._body.SetAngularDamping(t)}get angularVelocity(){return this._body?this._body.GetAngularVelocity():this._angularVelocity}set angularVelocity(t){this._angularVelocity=t,this._body&&this._body.SetAngularVelocity(t)}get linearDamping(){return this._linearDamping}set linearDamping(t){this._linearDamping=t,this._body&&this._body.SetLinearDamping(t)}get linearVelocity(){if(this._body){var t=this._body.GetLinearVelocity();return{x:t.x,y:t.y}}return this._linearVelocity}set linearVelocity(t){t&&(t instanceof Array&&(t={x:t[0],y:t[1]}),this._linearVelocity=t,this._body&&this._body.SetLinearVelocity(new window.box2d.b2Vec2(t.x,t.y)))}get bullet(){return this._bullet}set bullet(t){this._bullet=t,this._body&&this._body.SetBullet(t)}}class ColliderBase extends e.Component{constructor(){super(),this._isSensor=!1,this._density=10,this._friction=.2,this._restitution=0,this._singleton=!1}getDef(){if(!this._def){var t=new window.box2d.b2FixtureDef;t.density=this.density,t.friction=this.friction,t.isSensor=this.isSensor,t.restitution=this.restitution,t.shape=this._shape,this._def=t}return this._def}_onEnable(){this.rigidBody?this.refresh():e.ILaya.systemTimer.callLater(this,this._checkRigidBody)}_checkRigidBody(){if(!this.rigidBody){var t=this.owner.getComponent(RigidBody);t&&(this.rigidBody=t,this.refresh())}}_onDestroy(){this.rigidBody&&(this.fixture&&(this.fixture.GetBody()==this.rigidBody._getOriBody()&&this.rigidBody.body.DestroyFixture(this.fixture),this.fixture=null),this.rigidBody=null,this._shape=null,this._def=null)}get isSensor(){return this._isSensor}set isSensor(t){this._isSensor=t,this._def&&(this._def.isSensor=t,this.refresh())}get density(){return this._density}set density(t){this._density=t,this._def&&(this._def.density=t,this.refresh())}get friction(){return this._friction}set friction(t){this._friction=t,this._def&&(this._def.friction=t,this.refresh())}get restitution(){return this._restitution}set restitution(t){this._restitution=t,this._def&&(this._def.restitution=t,this.refresh())}refresh(){if(this.enabled&&this.rigidBody){var t=this.rigidBody.body;this.fixture&&(this.fixture.GetBody()==this.rigidBody.body&&this.rigidBody.body.DestroyFixture(this.fixture),this.fixture.Destroy(),this.fixture=null);var e=this.getDef();e.filter.groupIndex=this.rigidBody.group,e.filter.categoryBits=this.rigidBody.category,e.filter.maskBits=this.rigidBody.mask,this.fixture=t.CreateFixture(e),this.fixture.collider=this}}resetShape(t=!0){}}class BoxCollider extends ColliderBase{constructor(){super(...arguments),this._x=0,this._y=0,this._width=100,this._height=100}getDef(){return this._shape||(this._shape=new window.box2d.b2PolygonShape,this._setShape(!1)),this.label=this.label||"BoxCollider",super.getDef()}_onAdded(){let t=this.owner;t&&0<t.width&&0<t.height&&100==this.width&&100==this.height&&(this.width=t.width,this.height=t.height)}_setShape(t=!0){var e=this.owner.scaleX||1,i=this.owner.scaleY||1;this._shape.SetAsBox(this._width/2/Physics.PIXEL_RATIO*e,this._height/2/Physics.PIXEL_RATIO*i,new window.box2d.b2Vec2((this._width/2+this._x)/Physics.PIXEL_RATIO*e,(this._height/2+this._y)/Physics.PIXEL_RATIO*i)),t&&this.refresh()}get x(){return this._x}set x(t){this._x=t,this._shape&&this._setShape()}get y(){return this._y}set y(t){this._y=t,this._shape&&this._setShape()}get width(){return this._width}set width(t){if(t<=0)throw"BoxCollider size cannot be less than 0";this._width=t,this._shape&&this._setShape()}get height(){return this._height}set height(t){if(t<=0)throw"BoxCollider size cannot be less than 0";this._height=t,this._shape&&this._setShape()}resetShape(t=!0){this._setShape()}}class ChainCollider extends ColliderBase{constructor(){super(...arguments),this._x=0,this._y=0,this._points="0,0,100,0",this._loop=!1}getDef(){return this._shape||(this._shape=new window.box2d.b2ChainShape,this._setShape(!1)),this.label=this.label||"ChainCollider",super.getDef()}_setShape(t=!0){var e=this._points.split(","),i=e.length;if(i%2==1)throw"ChainCollider points lenth must a multiplier of 2";for(var s=[],o=0,n=i;o<n;o+=2)s.push(new window.box2d.b2Vec2((this._x+parseInt(e[o]))/Physics.PIXEL_RATIO,(this._y+parseInt(e[o+1]))/Physics.PIXEL_RATIO));this._loop?this._shape.CreateLoop(s,i/2):this._shape.CreateChain(s,i/2,new window.box2d.b2Vec2(0,0),new window.box2d.b2Vec2(0,0)),t&&this.refresh()}get x(){return this._x}set x(t){this._x=t,this._shape&&this._setShape()}get y(){return this._y}set y(t){this._y=t,this._shape&&this._setShape()}get points(){return this._points}set points(t){if(!t)throw"ChainCollider points cannot be empty";this._points=t,this._shape&&this._setShape()}get loop(){return this._loop}set loop(t){this._loop=t,this._shape&&this._setShape()}}class CircleCollider extends ColliderBase{constructor(){super(...arguments),this._x=0,this._y=0,this._radius=50}getDef(){return this._shape||(this._shape=new window.box2d.b2CircleShape,this._setShape(!1)),this.label=this.label||"CircleCollider",super.getDef()}_onAdded(){let t=this.owner;t&&0<t.width&&0<t.height&&50==this._radius&&(this._radius=t.width>>1)}_setShape(t=!0){var e=this.owner.scaleX||1;this._shape.m_radius=this._radius/Physics.PIXEL_RATIO*e,this._shape.m_p.Set((this._radius+this._x)/Physics.PIXEL_RATIO*e,(this._radius+this._y)/Physics.PIXEL_RATIO*e),t&&this.refresh()}get x(){return this._x}set x(t){this._x=t,this._shape&&this._setShape()}get y(){return this._y}set y(t){this._y=t,this._shape&&this._setShape()}get radius(){return this._radius}set radius(t){if(t<=0)throw"CircleCollider radius cannot be less than 0";this._radius=t,this._shape&&this._setShape()}resetShape(t=!0){this._setShape()}}class EdgeCollider extends ColliderBase{constructor(){super(...arguments),this._x=0,this._y=0,this._points="0,0,100,0"}getDef(){return this._shape||(this._shape=new window.box2d.b2EdgeShape,this._setShape(!1)),this.label=this.label||"EdgeCollider",super.getDef()}_setShape(t=!0){var e=this._points.split(","),i=e.length;if(i%2==1)throw"EdgeCollider points lenth must a multiplier of 2";for(var s=[],o=0,n=i;o<n;o+=2)s.push(new window.box2d.b2Vec2((this._x+parseInt(e[o]))/Physics.PIXEL_RATIO,(this._y+parseInt(e[o+1]))/Physics.PIXEL_RATIO));this._shape.SetTwoSided(s[0],s[1]),t&&this.refresh()}get x(){return this._x}set x(t){this._x=t,this._shape&&this._setShape()}get y(){return this._y}set y(t){this._y=t,this._shape&&this._setShape()}get points(){return this._points}set points(t){if(!t)throw"EdgeCollider points cannot be empty";this._points=t,this._shape&&this._setShape()}}class JointBase extends e.Component{constructor(){super(),this._singleton=!1}get joint(){return this._joint||this._createJoint(),this._joint}_onEnable(){this._createJoint()}_onAwake(){this._createJoint()}_createJoint(){}_onDisable(){this._joint&&this._joint.m_userData&&!this._joint.m_userData.isDestroy&&Physics.I._removeJoint(this._joint),this._joint=null}}class DistanceJoint extends JointBase{constructor(){super(...arguments),this.selfAnchor=[0,0],this.otherAnchor=[0,0],this.collideConnected=!1,this._length=0,this._maxLength=-1,this._minLength=-1,this._frequency=1,this._dampingRatio=0}_createJoint(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,e=DistanceJoint._temp||(DistanceJoint._temp=new t.b2DistanceJointDef);e.bodyA=this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,e.bodyB=this.selfBody.getBody(),e.localAnchorA.Set(this.otherAnchor[0]/Physics.PIXEL_RATIO,this.otherAnchor[1]/Physics.PIXEL_RATIO),e.localAnchorB.Set(this.selfAnchor[0]/Physics.PIXEL_RATIO,this.selfAnchor[1]/Physics.PIXEL_RATIO),t.b2LinearStiffness(e,this._frequency,this._dampingRatio,e.bodyA,e.bodyB),e.collideConnected=this.collideConnected;var i=e.bodyA.GetWorldPoint(e.localAnchorA,new t.b2Vec2),s=e.bodyB.GetWorldPoint(e.localAnchorB,new t.b2Vec2);e.length=this._length/Physics.PIXEL_RATIO||t.b2Vec2.SubVV(s,i,new t.b2Vec2).Length(),e.maxLength=t.b2_maxFloat,e.minLength=0,this._maxLength>=0&&(e.maxLength=this._maxLength/Physics.PIXEL_RATIO),this._minLength>=0&&(e.minLength=this._minLength/Physics.PIXEL_RATIO),this._joint=Physics.I._createJoint(e)}}get length(){return this._length}set length(t){this._length=t,this._joint&&this._joint.SetLength(t/Physics.PIXEL_RATIO)}get minLength(){return this._minLength}set minLength(t){this._minLength=t,this._joint&&this._joint.SetMinLength(t/Physics.PIXEL_RATIO)}get maxLength(){return this._maxLength}set maxLength(t){this._maxLength=t,this._joint&&this._joint.SetMaxLength(t/Physics.PIXEL_RATIO)}get frequency(){return this._frequency}set frequency(t){if(this._frequency=t,this._joint){let t={},e=window.box2d,i=this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,s=this.selfBody.getBody();e.b2LinearStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetStiffness(t.stiffness),this._joint.SetDamping(t.damping)}}get damping(){return this._dampingRatio}set damping(t){if(this._dampingRatio=t,this._joint){let t={},e=window.box2d,i=this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,s=this.selfBody.getBody();e.b2LinearStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetDamping(t.damping)}}}class GearJoint extends JointBase{constructor(){super(...arguments),this.collideConnected=!1,this._ratio=1}_createJoint(){if(!this._joint){if(!this.joint1)throw"Joint1 can not be empty";if(!this.joint2)throw"Joint2 can not be empty";var t=window.box2d,e=GearJoint._temp||(GearJoint._temp=new t.b2GearJointDef);e.bodyA=this.joint1.owner.getComponent(RigidBody).getBody(),e.bodyB=this.joint2.owner.getComponent(RigidBody).getBody(),e.joint1=this.joint1.joint,e.joint2=this.joint2.joint,e.ratio=this._ratio,e.collideConnected=this.collideConnected,this._joint=Physics.I._createJoint(e)}}get ratio(){return this._ratio}set ratio(t){this._ratio=t,this._joint&&this._joint.SetRatio(t)}}class MotorJoint extends JointBase{constructor(){super(...arguments),this.collideConnected=!1,this._linearOffset=[0,0],this._angularOffset=0,this._maxForce=1e3,this._maxTorque=1e3,this._correctionFactor=.3}_createJoint(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,e=MotorJoint._temp||(MotorJoint._temp=new t.b2MotorJointDef);e.Initialize(this.otherBody.getBody(),this.selfBody.getBody()),e.linearOffset=new t.b2Vec2(this._linearOffset[0]/Physics.PIXEL_RATIO,this._linearOffset[1]/Physics.PIXEL_RATIO),e.angularOffset=this._angularOffset,e.maxForce=this._maxForce,e.maxTorque=this._maxTorque,e.correctionFactor=this._correctionFactor,e.collideConnected=this.collideConnected,this._joint=Physics.I._createJoint(e)}}get linearOffset(){return this._linearOffset}set linearOffset(t){this._linearOffset=t,this._joint&&this._joint.SetLinearOffset(new window.box2d.b2Vec2(t[0]/Physics.PIXEL_RATIO,t[1]/Physics.PIXEL_RATIO))}get angularOffset(){return this._angularOffset}set angularOffset(t){this._angularOffset=t,this._joint&&this._joint.SetAngularOffset(t)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.SetMaxForce(t)}get maxTorque(){return this._maxTorque}set maxTorque(t){this._maxTorque=t,this._joint&&this._joint.SetMaxTorque(t)}get correctionFactor(){return this._correctionFactor}set correctionFactor(t){this._correctionFactor=t,this._joint&&this._joint.SetCorrectionFactor(t)}}class MouseJoint extends JointBase{constructor(){super(...arguments),this._maxForce=1e4,this._frequency=5,this._dampingRatio=.7}_onEnable(){super._onEnable(),this.owner.on(e.Event.MOUSE_DOWN,this,this.onMouseDown)}onMouseDown(){this._createJoint(),e.ILaya.stage.on(e.Event.MOUSE_MOVE,this,this.onMouseMove),e.ILaya.stage.once(e.Event.MOUSE_UP,this,this.onStageMouseUp),e.ILaya.stage.once(e.Event.MOUSE_OUT,this,this.onStageMouseUp)}_createJoint(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=MouseJoint._temp||(MouseJoint._temp=new t.b2MouseJointDef);if(this.anchor)var s=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,Physics.I.worldRoot);else s=Physics.I.worldRoot.globalToLocal(e.Point.TEMP.setTo(e.ILaya.stage.mouseX,e.ILaya.stage.mouseY));var o=new t.b2Vec2(s.x/Physics.PIXEL_RATIO,s.y/Physics.PIXEL_RATIO);i.bodyA=Physics.I._emptyBody,i.bodyB=this.selfBody.getBody(),i.target=o,t.b2LinearStiffness(i,this._frequency,this._dampingRatio,i.bodyA,i.bodyB),i.maxForce=this._maxForce,this._joint=Physics.I._createJoint(i)}}onStageMouseUp(){e.ILaya.stage.off(e.Event.MOUSE_MOVE,this,this.onMouseMove),e.ILaya.stage.off(e.Event.MOUSE_UP,this,this.onStageMouseUp),e.ILaya.stage.off(e.Event.MOUSE_OUT,this,this.onStageMouseUp),super._onDisable()}onMouseMove(){this._joint.SetTarget(new window.box2d.b2Vec2(Physics.I.worldRoot.mouseX/Physics.PIXEL_RATIO,Physics.I.worldRoot.mouseY/Physics.PIXEL_RATIO))}_onDisable(){super._onDisable(),this.owner.off(e.Event.MOUSE_DOWN,this,this.onMouseDown)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.SetMaxForce(t)}get frequency(){return this._frequency}set frequency(t){if(this._frequency=t,this._joint){let t={},e=window.box2d,i=Physics.I._emptyBody,s=this.selfBody.getBody();e.b2LinearStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetStiffness(t.stiffness),this._joint.SetDamping(t.damping)}}get damping(){return this._dampingRatio}set damping(t){if(this._dampingRatio=t,this._joint){let t={},e=window.box2d,i=Physics.I._emptyBody,s=this.selfBody.getBody();e.b2LinearStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetDamping(t.damping)}}}class PrismaticJoint extends JointBase{constructor(){super(...arguments),this.anchor=[0,0],this.axis=[1,0],this.collideConnected=!1,this._enableMotor=!1,this._motorSpeed=0,this._maxMotorForce=1e4,this._enableLimit=!1,this._lowerTranslation=0,this._upperTranslation=0}_createJoint(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=PrismaticJoint._temp||(PrismaticJoint._temp=new t.b2PrismaticJointDef),s=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,Physics.I.worldRoot),o=new t.b2Vec2(s.x/Physics.PIXEL_RATIO,s.y/Physics.PIXEL_RATIO);i.Initialize(this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,this.selfBody.getBody(),o,new t.b2Vec2(this.axis[0],this.axis[1])),i.enableMotor=this._enableMotor,i.motorSpeed=this._motorSpeed,i.maxMotorForce=this._maxMotorForce,i.enableLimit=this._enableLimit,i.lowerTranslation=this._lowerTranslation/Physics.PIXEL_RATIO,i.upperTranslation=this._upperTranslation/Physics.PIXEL_RATIO,i.collideConnected=this.collideConnected,this._joint=Physics.I._createJoint(i)}}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.EnableMotor(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.SetMotorSpeed(t)}get maxMotorForce(){return this._maxMotorForce}set maxMotorForce(t){this._maxMotorForce=t,this._joint&&this._joint.SetMaxMotorForce(t)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t,this._joint&&this._joint.EnableLimit(t)}get lowerTranslation(){return this._lowerTranslation}set lowerTranslation(t){this._lowerTranslation=t,this._joint&&this._joint.SetLimits(t,this._upperTranslation)}get upperTranslation(){return this._upperTranslation}set upperTranslation(t){this._upperTranslation=t,this._joint&&this._joint.SetLimits(this._lowerTranslation,t)}}class PulleyJoint extends JointBase{constructor(){super(...arguments),this.selfAnchor=[0,0],this.otherAnchor=[0,0],this.selfGroundPoint=[0,0],this.otherGroundPoint=[0,0],this.ratio=1.5,this.collideConnected=!1}_createJoint(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=PulleyJoint._temp||(PulleyJoint._temp=new t.b2PulleyJointDef),s=this.otherBody.owner.localToGlobal(e.Point.TEMP.setTo(this.otherAnchor[0],this.otherAnchor[1]),!1,Physics.I.worldRoot),o=new t.b2Vec2(s.x/Physics.PIXEL_RATIO,s.y/Physics.PIXEL_RATIO),n=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.selfAnchor[0],this.selfAnchor[1]),!1,Physics.I.worldRoot),r=new t.b2Vec2(n.x/Physics.PIXEL_RATIO,n.y/Physics.PIXEL_RATIO),a=this.otherBody.owner.localToGlobal(e.Point.TEMP.setTo(this.otherGroundPoint[0],this.otherGroundPoint[1]),!1,Physics.I.worldRoot),h=new t.b2Vec2(a.x/Physics.PIXEL_RATIO,a.y/Physics.PIXEL_RATIO),l=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.selfGroundPoint[0],this.selfGroundPoint[1]),!1,Physics.I.worldRoot),_=new t.b2Vec2(l.x/Physics.PIXEL_RATIO,l.y/Physics.PIXEL_RATIO);i.Initialize(this.otherBody.getBody(),this.selfBody.getBody(),h,_,o,r,this.ratio),i.collideConnected=this.collideConnected,this._joint=Physics.I._createJoint(i)}}}class RevoluteJoint extends JointBase{constructor(){super(...arguments),this.anchor=[0,0],this.collideConnected=!1,this._enableMotor=!1,this._motorSpeed=0,this._maxMotorTorque=1e4,this._enableLimit=!1,this._lowerAngle=0,this._upperAngle=0}_createJoint(){if(!this._joint){if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=RevoluteJoint._temp||(RevoluteJoint._temp=new t.b2RevoluteJointDef),s=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,Physics.I.worldRoot),o=new t.b2Vec2(s.x/Physics.PIXEL_RATIO,s.y/Physics.PIXEL_RATIO);i.Initialize(this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,this.selfBody.getBody(),o),i.enableMotor=this._enableMotor,i.motorSpeed=this._motorSpeed,i.maxMotorTorque=this._maxMotorTorque,i.enableLimit=this._enableLimit,i.lowerAngle=this._lowerAngle,i.upperAngle=this._upperAngle,i.collideConnected=this.collideConnected,this._joint=Physics.I._createJoint(i)}}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.EnableMotor(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.SetMotorSpeed(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.SetMaxMotorTorque(t)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t,this._joint&&this._joint.EnableLimit(t)}get lowerAngle(){return this._lowerAngle}set lowerAngle(t){this._lowerAngle=t,this._joint&&this._joint.SetLimits(t,this._upperAngle)}get upperAngle(){return this._upperAngle}set upperAngle(t){this._upperAngle=t,this._joint&&this._joint.SetLimits(this._lowerAngle,t)}}class WeldJoint extends JointBase{constructor(){super(...arguments),this.anchor=[0,0],this.collideConnected=!1,this._frequency=5,this._dampingRatio=.7}_createJoint(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=WeldJoint._temp||(WeldJoint._temp=new t.b2WeldJointDef),s=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,Physics.I.worldRoot),o=new t.b2Vec2(s.x/Physics.PIXEL_RATIO,s.y/Physics.PIXEL_RATIO);i.Initialize(this.otherBody.getBody(),this.selfBody.getBody(),o),t.b2AngularStiffness(i,this._frequency,this._dampingRatio,i.bodyA,i.bodyB),i.collideConnected=this.collideConnected,this._joint=Physics.I._createJoint(i)}}get frequency(){return this._frequency}set frequency(t){if(this._frequency=t,this._joint){let t={},e=window.box2d,i=this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,s=this.selfBody.getBody();e.b2AngularStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetStiffness(t.stiffness),this._joint.SetDamping(t.damping)}}get damping(){return this._dampingRatio}set damping(t){if(this._dampingRatio=t,this._joint){let t={},e=window.box2d,i=this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,s=this.selfBody.getBody();e.b2AngularStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetDamping(t.damping)}}}class WheelJoint extends JointBase{constructor(){super(...arguments),this.anchor=[0,0],this.collideConnected=!1,this.axis=[1,0],this._frequency=5,this._dampingRatio=.7,this._enableMotor=!1,this._motorSpeed=0,this._maxMotorTorque=1e4,this._enableLimit=!0,this._lowerTranslation=0,this._upperTranslation=0}_createJoint(){if(!this._joint){if(!this.otherBody)throw"otherBody can not be empty";if(this.selfBody=this.selfBody||this.owner.getComponent(RigidBody),!this.selfBody)throw"selfBody can not be empty";var t=window.box2d,i=WheelJoint._temp||(WheelJoint._temp=new t.b2WheelJointDef),s=this.selfBody.owner.localToGlobal(e.Point.TEMP.setTo(this.anchor[0],this.anchor[1]),!1,Physics.I.worldRoot),o=new t.b2Vec2(s.x/Physics.PIXEL_RATIO,s.y/Physics.PIXEL_RATIO);i.Initialize(this.otherBody.getBody(),this.selfBody.getBody(),o,new t.b2Vec2(this.axis[0],this.axis[1])),i.enableMotor=this._enableMotor,i.motorSpeed=this._motorSpeed,i.maxMotorTorque=this._maxMotorTorque,t.b2LinearStiffness(i,this._frequency,this._dampingRatio,i.bodyA,i.bodyB),i.collideConnected=this.collideConnected,i.enableLimit=this._enableLimit,i.lowerTranslation=this._lowerTranslation/Physics.PIXEL_RATIO,i.upperTranslation=this._upperTranslation/Physics.PIXEL_RATIO,this._joint=Physics.I._createJoint(i)}}get frequency(){return this._frequency}set frequency(t){if(this._frequency=t,this._joint){let t={},e=window.box2d,i=this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,s=this.selfBody.getBody();e.b2LinearStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetStiffness(t.stiffness),this._joint.SetDamping(t.damping)}}get damping(){return this._dampingRatio}set damping(t){if(this._dampingRatio=t,this._joint){let t={},e=window.box2d,i=this.otherBody?this.otherBody.getBody():Physics.I._emptyBody,s=this.selfBody.getBody();e.b2LinearStiffness(t,this._frequency,this._dampingRatio,i,s),this._joint.SetDamping(t.damping)}}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.EnableMotor(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.SetMotorSpeed(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.SetMaxMotorTorque(t)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t,this._joint&&this._joint.EnableLimit(t)}get lowerTranslation(){return this._lowerTranslation}set lowerTranslation(t){this._lowerTranslation=t,this._joint&&this._joint.SetLimits(t,this._upperTranslation)}get upperTranslation(){return this._upperTranslation}set upperTranslation(t){this._upperTranslation=t,this._joint&&this._joint.SetLimits(this._lowerTranslation,t)}}class PhysicsDebugDraw extends e.Sprite{constructor(){super(),this.m_drawFlags=99,PhysicsDebugDraw._inited||(PhysicsDebugDraw._inited=!0,PhysicsDebugDraw.init()),this._camera={},this._camera.m_center=new PhysicsDebugDraw.box2d.b2Vec2(0,0),this._camera.m_extent=25,this._camera.m_zoom=1,this._camera.m_width=1280,this._camera.m_height=800,this._mG=new e.Graphics,this.graphics=this._mG,this._textSp=new e.Sprite,this._textG=this._textSp.graphics,this.addChild(this._textSp)}static init(){PhysicsDebugDraw.box2d=e.Browser.window.box2d,PhysicsDebugDraw.DrawString_s_color=new PhysicsDebugDraw.box2d.b2Color(.9,.6,.6),PhysicsDebugDraw.DrawStringWorld_s_p=new PhysicsDebugDraw.box2d.b2Vec2,PhysicsDebugDraw.DrawStringWorld_s_cc=new PhysicsDebugDraw.box2d.b2Vec2,PhysicsDebugDraw.DrawStringWorld_s_color=new PhysicsDebugDraw.box2d.b2Color(.5,.9,.5)}render(t,e,i){this._renderToGraphic(),super.render(t,e,i)}_renderToGraphic(){this.world&&(this._textG.clear(),this._mG.clear(),this._mG.save(),this._mG.scale(Physics.PIXEL_RATIO,Physics.PIXEL_RATIO),this.lineWidth=1/Physics.PIXEL_RATIO,this.world.DebugDraw?this.world.DebugDraw():this.world.DrawDebugData(),this._mG.restore())}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}PushTransform(t){this._mG.save(),this._mG.translate(t.p.x,t.p.y),this._mG.rotate(t.q.GetAngle())}PopTransform(t){this._mG.restore()}DrawPolygon(t,e,i){var s,o;for(t.length,o=[],s=0;s<e;s++)o.push(t[s].x,t[s].y);this._mG.drawPoly(0,0,o,null,i.MakeStyleString(1),this.lineWidth)}DrawSolidPolygon(t,e,i){var s,o;for(t.length,o=[],s=0;s<e;s++)o.push(t[s].x,t[s].y);this._mG.drawPoly(0,0,o,i.MakeStyleString(.5),i.MakeStyleString(1),this.lineWidth)}DrawCircle(t,e,i){this._mG.drawCircle(t.x,t.y,e,null,i.MakeStyleString(1),this.lineWidth)}DrawSolidCircle(t,e,i,s){var o=t.x,n=t.y;this._mG.drawCircle(o,n,e,s.MakeStyleString(.5),s.MakeStyleString(1),this.lineWidth),this._mG.drawLine(o,n,o+i.x*e,n+i.y*e,s.MakeStyleString(1),this.lineWidth)}DrawParticles(t,e,i,s){if(null!==i)for(var o=0;o<s;++o){var n=t[o],r=i[o];this._mG.drawCircle(n.x,n.y,e,r.MakeStyleString(),null,this.lineWidth)}else for(o=0;o<s;++o)n=t[o],this._mG.drawCircle(n.x,n.y,e,"#ffff00",null,this.lineWidth)}DrawSegment(t,e,i){this._mG.drawLine(t.x,t.y,e.x,e.y,i.MakeStyleString(1),this.lineWidth)}DrawTransform(t){this.PushTransform(t),this._mG.drawLine(0,0,1,0,PhysicsDebugDraw.box2d.b2Color.RED.MakeStyleString(1),this.lineWidth),this._mG.drawLine(0,0,0,1,PhysicsDebugDraw.box2d.b2Color.GREEN.MakeStyleString(1),this.lineWidth),this.PopTransform(t)}DrawPoint(t,e,i){e*=this._camera.m_zoom;var s=(e/=this._camera.m_extent)/2;this._mG.drawRect(t.x-s,t.y-s,e,e,i.MakeStyleString(),null)}DrawString(t,e,i){this._textG.fillText(i,t,e,"15px DroidSans",PhysicsDebugDraw.DrawString_s_color.MakeStyleString(),"left")}DrawStringWorld(t,e,i){this.DrawString(t,e,i)}DrawAABB(t,e){var i=t.lowerBound.x,s=t.lowerBound.y,o=t.upperBound.x-t.lowerBound.x,n=t.upperBound.y-t.lowerBound.y;this._mG.drawRect(i,s,o,n,null,e.MakeStyleString(),this.lineWidth)}static enable(t=99){if(!PhysicsDebugDraw.I){var i=new PhysicsDebugDraw;i.world=Physics.I.world,i.world.SetDebugDraw(i),i.zOrder=1e3,i.m_drawFlags=t,e.ILaya.stage.addChild(i),PhysicsDebugDraw.I=i}return i}}PhysicsDebugDraw._inited=!1;class PolygonCollider extends ColliderBase{constructor(){super(...arguments),this._x=0,this._y=0,this._points="50,0,100,100,0,100"}getDef(){return this._shape||(this._shape=new window.box2d.b2PolygonShape,this._setShape(!1)),this.label=this.label||"PolygonCollider",super.getDef()}_setShape(t=!0){var e=this._points.split(","),i=e.length;if(i<6)throw"PolygonCollider points must be greater than 3";if(i%2==1)throw"PolygonCollider points lenth must a multiplier of 2";for(var s=[],o=0,n=i;o<n;o+=2)s.push(new window.box2d.b2Vec2((this._x+parseInt(e[o]))/Physics.PIXEL_RATIO,(this._y+parseInt(e[o+1]))/Physics.PIXEL_RATIO));this._shape.Set(s,i/2),t&&this.refresh()}get x(){return this._x}set x(t){this._x=t,this._shape&&this._setShape()}get y(){return this._y}set y(t){this._y=t,this._shape&&this._setShape()}get points(){return this._points}set points(t){if(!t)throw"PolygonCollider points cannot be empty";this._points=t,this._shape&&this._setShape()}}let i=e.ClassUtils.regClass;i("Physics",Physics),i("PhysicsDebugDraw",PhysicsDebugDraw),i("ColliderBase",ColliderBase),i("BoxCollider",BoxCollider),i("ChainCollider",ChainCollider),i("CircleCollider",CircleCollider),i("EdgeCollider",EdgeCollider),i("PolygonCollider",PolygonCollider),i("RigidBody",RigidBody),i("JointBase",JointBase),i("DistanceJoint",DistanceJoint),i("GearJoint",GearJoint),i("MotorJoint",MotorJoint),i("MouseJoint",MouseJoint),i("PrismaticJoint",PrismaticJoint),i("PulleyJoint",PulleyJoint),i("RevoluteJoint",RevoluteJoint),i("WeldJoint",WeldJoint),i("WheelJoint",WheelJoint),t.BoxCollider=BoxCollider,t.ChainCollider=ChainCollider,t.CircleCollider=CircleCollider,t.ColliderBase=ColliderBase,t.DestructionListener=DestructionListener,t.DistanceJoint=DistanceJoint,t.EdgeCollider=EdgeCollider,t.GearJoint=GearJoint,t.JointBase=JointBase,t.MotorJoint=MotorJoint,t.MouseJoint=MouseJoint,t.Physics=Physics,t.PhysicsDebugDraw=PhysicsDebugDraw,t.PolygonCollider=PolygonCollider,t.PrismaticJoint=PrismaticJoint,t.PulleyJoint=PulleyJoint,t.RevoluteJoint=RevoluteJoint,t.RigidBody=RigidBody,t.WeldJoint=WeldJoint,t.WheelJoint=WheelJoint}(window.Laya=window.Laya||{},Laya);
//# sourceMappingURL=laya.physics.js.map